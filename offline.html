<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система учёта товаров (Автономная версия)</title>
    
    <!-- Локальные стили вместо Tailwind CDN -->
    <link rel="stylesheet" href="offline-styles.css">
    
    <!-- Локальная XLSX библиотека -->
    <script src="simple-excel.js"></script>

    <!-- Условная загрузка Firebase для автономной работы -->
    <script>
        // Проверяем наличие интернета и загружаем Firebase только при необходимости
        let isOnline = navigator.onLine;
        let firebaseEnabled = false;
        
        async function checkInternetConnection() {
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                return true;
            } catch {
                return false;
            }
        }
        
        async function initializeFirebaseIfOnline() {
            const hasInternet = await checkInternetConnection();
            
            if (hasInternet) {
                console.log('🌐 Интернет доступен, загружаем Firebase...');
                loadFirebaseSDK();
            } else {
                console.log('📴 Работаем в автономном режиме');
                initOfflineMode();
            }
        }
        
        function loadFirebaseSDK() {
            try {
                const script = document.createElement('script');
                script.type = 'module';
                script.innerHTML = `
                    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
                    import { getDatabase, ref, set, get, onValue, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
                    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

                    const firebaseConfig = {
                        apiKey: "AIzaSyCayEVi5NeiLKd9Q_c_-NUSvl8PIrd3aRU",
                        authDomain: "warehouse-system-f4e52.firebaseapp.com",
                        databaseURL: "https://warehouse-system-f4e52-default-rtdb.asia-southeast1.firebasedatabase.app",
                        projectId: "warehouse-system-f4e52",
                        storageBucket: "warehouse-system-f4e52.firebasestorage.app",
                        messagingSenderId: "660222070151",
                        appId: "1:660222070151:web:abebee403e889d2de19722"
                    };

                    const app = initializeApp(firebaseConfig);
                    const database = getDatabase(app);
                    const auth = getAuth(app);

                    window.firebaseDB = database;
                    window.firebaseAuth = auth;
                    window.firebaseRefs = { ref, set, get, onValue, push };
                    window.signInAnonymously = signInAnonymously;
                    window.firebaseEnabled = true;
                    
                    console.log('✅ Firebase SDK загружен успешно');
                `;
                document.head.appendChild(script);
            } catch (error) {
                console.log('❌ Ошибка загрузки Firebase, работаем автономно:', error);
                initOfflineMode();
            }
        }
        
        function initOfflineMode() {
            window.firebaseEnabled = false;
            window.firebaseDB = null;
            window.firebaseAuth = null;
            window.firebaseRefs = null;
            window.signInAnonymously = null;
            console.log('📴 Автономный режим активирован');
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseIfOnline();
        });
        
        // Слушатели изменения статуса интернета
        window.addEventListener('online', () => {
            console.log('🌐 Интернет подключен');
            isOnline = true;
            if (!firebaseEnabled) {
                initializeFirebaseIfOnline();
            }
        });
        
        window.addEventListener('offline', () => {
            console.log('📴 Интернет отключен');
            isOnline = false;
        });
    </script>
    <style>
        body {
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .mobile-menu.open {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .desktop-sidebar {
                display: none;
            }

            .mobile-header {
                display: flex !important;
                min-height: 60px;
                padding: 8px 12px !important;
            }

            /* Стили для мобильного селектора года */
            #mobileYearSelector {
                min-width: 60px;
                max-width: 80px;
            }

            #mobileAddYearBtn {
                min-width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Стили для мобильного модального окна */
            #mobileYearModal {
                backdrop-filter: blur(4px);
            }

            #mobileYearModal .bg-white {
                animation: modalSlideIn 0.3s ease-out;
            }

            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            /* Стили для уведомлений */
            #mobileNotification {
                animation: notificationSlideIn 0.3s ease-out;
            }

            @keyframes notificationSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Исправления для мобильного меню */
            #sidebar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                height: 100vh !important;
                width: 280px !important;
                z-index: 9999 !important;
                background-color: #1e40af !important;
                transform: translateX(-100%) !important;
                transition: transform 0.3s ease !important;
            }

            #sidebar.open {
                transform: translateX(0) !important;
            }

            /* Overlay для закрытия меню */
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 9998;
                display: none;
            }

            .mobile-overlay.show {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }

            .mobile-menu {
                transform: translateX(0);
                position: static;
            }
        }

        /* Стили для валидации полей с datalist */
        .border-green-500 {
            border-color: #10b981 !important;
        }

        .border-red-500 {
            border-color: #ef4444 !important;
        }

        /* Анимация для сообщений об ошибках */
        .text-red-500 {
            color: #ef4444;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Улучшенные стили для datalist */
        input[list]::-webkit-calendar-picker-indicator {
            display: none !important;
        }

        input[list] {
            position: relative;
        }

        input[list]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Стили для отчета остатков складов */
        .stock-balance-report {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .warehouse-section {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
        }

        .warehouse-section h4 {
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .totals-section {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .totals-section h4 {
            color: #1e40af;
            font-weight: 700;
        }

        /* Стили для группировки складов */
        .warehouse-group-section {
            margin-bottom: 32px;
        }

        .warehouse-group-section h3 {
            color: #7c3aed;
            font-weight: 700;
            border-bottom: 2px solid #c4b5fd;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }

        /* Улучшенные стили для строк товаров */
        .warehouse-section .flex {
            border-bottom: 1px solid #e5e7eb !important;
            transition: background-color 0.2s ease;
            margin: 0;
            padding: 2px 8px !important;
            min-height: 24px;
            line-height: 1.2;
        }

        .warehouse-section .flex:hover {
            background-color: #f3f4f6 !important;
        }

        .warehouse-section .flex:last-child {
            border-bottom: 1px solid #d1d5db !important;
        }

        /* Стили для отчета остатков складов */
        .stock-balance-report {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .warehouse-section {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
        }

        .warehouse-section h4 {
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .totals-section {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .totals-section h4 {
            color: #1e40af;
            font-weight: 700;
        }

        .product-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .product-line:last-child {
            border-bottom: none;
        }

        .product-name {
            font-weight: 500;
            color: #374151;
        }

        .product-quantity {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .quantity-positive {
            color: #059669;
        }

        .quantity-negative {
            color: #dc2626;
        }

        .grand-total {
            border-top: 2px solid #1e40af;
            margin-top: 12px;
            padding-top: 12px;
            font-size: 1.1em;
            font-weight: 700;
            color: #1e40af;
        }

        @media (max-width: 768px) {
            .warehouse-section {
                padding: 8px;
                margin-bottom: 12px;
            }

            .totals-section {
                padding: 12px;
            }

            .product-line {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .product-quantity {
                align-self: flex-end;
            }
        }
        
        /* Стили для автономной версии */
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            z-index: 10000;
            transition: all 0.3s ease;
        }
        
        .offline-indicator.online {
            background-color: #10b981;
            color: white;
        }
        
        .offline-indicator.offline {
            background-color: #ef4444;
            color: white;
        }
        
        .version-badge {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
        }
    </style>
</head>

<body class="bg-gray-100 h-full">
    <!-- Индикатор статуса подключения -->
    <div id="connectionStatus" class="offline-indicator offline">
        📴 Автономно
    </div>
    
    <!-- Бейдж версии -->
    <div class="version-badge">
        Автономная v1.0
    </div>

    <!-- Мобильная шапка -->
    <div class="mobile-header bg-blue-600 text-white p-4 justify-between items-center">
        <button id="mobileMenuBtn" class="text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
        <div class="flex flex-col items-center gap-1 flex-1">
            <h1 class="text-base font-bold">Учёт товаров 📴</h1>
            <div class="flex items-center gap-3 text-xs">
                <!-- Мобильный селектор года -->
                <!-- Мобильная кнопка переключения года -->
                <button id="mobileYearButton" onclick="showMobileYearModal()"
                    class="flex items-center gap-1 bg-white bg-opacity-20 rounded px-3 py-1.5 hover:bg-opacity-30 transition-all">
                    <span class="text-white text-xs">Года</span>
                    <span id="mobileCurrentYearDisplay" class="text-white font-bold text-sm">2025</span>
                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div id="syncStatus" class="flex items-center gap-1">
                    <div id="syncIndicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                    <span id="syncText" class="text-xs">Офлайн</span>
                </div>
            </div>
        </div>
        <div class="flex flex-col items-end gap-1">
            <div class="flex gap-1">
                <button id="mobileConnectBtn"
                    class="bg-green-500 text-white px-1.5 py-0.5 rounded text-xs hover:bg-green-600">
                    ON
                </button>
                <button id="mobileOfflineBtn"
                    class="bg-gray-500 text-white px-1.5 py-0.5 rounded text-xs hover:bg-gray-600">
                    OFF
                </button>
            </div>
            <button id="logoutBtnMobile" class="text-white text-xs hover:text-gray-200">Выход</button>
        </div>
    </div>

    <!-- Экран входа (вне основного интерфейса) -->
    <div id="loginScreen" class="max-w-md mx-auto mt-20 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-center">Вход в систему</h2>
        <form id="loginForm">
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium mb-2">Логин</label>
                <input type="text" id="username" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium mb-2">Пароль</label>
                <input type="password" id="password" class="w-full p-2 border rounded" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Войти</button>
        </form>
        <div class="mt-4 text-center">
            <button type="button" id="forgotPasswordBtn" class="text-blue-600 hover:text-blue-800 text-sm underline">
                Забыли пароль?
            </button>
        </div>
    </div>

    <!-- Модальное окно выбора года для мобильных -->
    <div id="mobileYearModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full max-h-96 overflow-hidden">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <h3 class="text-lg font-bold">Выберите год</h3>
                <button onclick="closeMobileYearModal()" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-4">
                <div id="mobileYearsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Годы будут добавлены динамически -->
                </div>
                <div id="mobileAddYearSection" class="mt-4 pt-4 border-t" style="display: none;">
                    <h4 class="font-medium mb-2">Добавить новый год</h4>
                    <div class="flex gap-2">
                        <input type="number" id="mobileNewYearInput" placeholder="2026" min="2020" max="2050"
                            class="flex-1 p-2 border rounded text-sm">
                        <button onclick="addNewYearFromMobile()"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                            Добавить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="mobileNotification" class="fixed top-4 left-4 right-4 z-50 hidden">
        <div class="bg-green-500 text-white p-3 rounded-lg shadow-lg flex items-center justify-between">
            <span id="mobileNotificationText"></span>
            <button onclick="hideMobileNotification()" class="text-white hover:text-gray-200 ml-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <div id="mainInterface" class="flex h-full">
        <!-- Боковое меню -->
        <div id="sidebar"
            class="mobile-menu desktop-sidebar bg-blue-800 text-white w-64 min-h-full p-4 fixed md:static z-50">
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-2">Система учёта</h2>
                <div id="userInfo" class="text-sm bg-blue-700 p-2 rounded mb-3">
                    <div>Пользователь: <span id="currentUser">admin</span></div>
                    <div>Роль: <span id="currentRole">Администратор</span></div>
                    <div class="flex items-center gap-2 mt-2">
                        <div id="syncIndicatorDesktop" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        <span id="syncTextDesktop" class="text-xs">Синхронизация: Офлайн</span>
                    </div>
                </div>

                <!-- Селектор года -->
                <div class="bg-blue-700 p-3 rounded">
                    <label class="block text-sm font-medium mb-2">Рабочий год:</label>
                    <div class="flex gap-2">
                        <select id="yearSelector" onchange="switchYear(this.value)"
                            class="flex-1 p-1 text-black rounded text-sm">
                            <!-- Годы будут добавлены динамически -->
                        </select>
                        <button onclick="addNewYear()" class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs"
                            title="Добавить новый год">+</button>
                    </div>
                    <div class="text-xs mt-1 opacity-75">Текущий: <span id="currentYearDisplay">2025</span></div>
                </div>
            </div>

            <nav class="space-y-2">
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded"
                    data-section="dashboard">Главная</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="income"
                    id="incomeBtn">Приход</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="expense"
                    id="expenseBtn">Расход</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="payments"
                    id="paymentsBtn">Погашения</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="wagon-summary"
                    id="wagonSummaryBtn">Свод Вагонов</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="balance-summary"
                    id="balanceSummaryBtn">Свод Остатков</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="debt-report"
                    id="debtReportBtn">Отчёт по долгам</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="wagon-totals"
                    id="wagonTotalsBtn">Итоги Вагонов</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="reports"
                    id="reportsBtn">Отчёты</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="stock-balance"
                    id="stockBalanceBtn">📦 Остатки складов</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="management"
                    id="managementBtn">Управление</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="users"
                    id="usersBtn">Пользователи</button>
                <button class="menu-item w-full text-left p-2 hover:bg-blue-700 rounded" data-section="backup"
                    id="backupBtn">Резервное копирование</button>
            </nav>

            <div class="mt-8">
                <button id="logoutBtn" class="w-full bg-red-600 hover:bg-red-700 p-2 rounded">Выход</button>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="flex-1 p-4 md:p-6 overflow-auto">


            <!-- Главная -->
            <div id="dashboard" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Панель управления</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-2">Общий приход</h3>
                        <p class="text-2xl font-bold text-green-600" id="totalIncome">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-2">Общий расход</h3>
                        <p class="text-2xl font-bold text-red-600" id="totalExpense">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-2">Остаток</h3>
                        <p class="text-2xl font-bold text-blue-600" id="totalBalance">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-2">Долги</h3>
                        <p class="text-2xl font-bold text-orange-600" id="totalDebt">0</p>
                    </div>
                </div>

                <!-- Быстрые отчеты -->
                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h3 class="text-lg font-semibold mb-4">📊 Быстрые отчеты</h3>
                    <div class="flex flex-wrap gap-4">
                        <button id="generateQuickStockReport" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <span>📋</span>
                            <span>Фактические остатки</span>
                        </button>
                        <button id="sendStockToWhatsApp" 
                                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                            <span>📱</span>
                            <span>Отправить в WhatsApp</span>
                        </button>
                        <button id="copyStockToClipboard" 
                                class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
                            <span>📄</span>
                            <span>Копировать отчет</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Приход -->
            <div id="income" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Приход товаров</h1>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <form id="incomeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="incomeDate" class="block text-sm font-medium mb-2">Дата</label>
                            <input type="date" id="incomeDate" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="incomeWagon" class="block text-sm font-medium mb-2">Номер вагона</label>
                            <input type="text" id="incomeWagon" class="w-full p-2 border rounded" required>
                        </div>

                        <div>
                            <label for="incomeCompany" class="block text-sm font-medium mb-2">Фирма</label>
                            <input type="text" id="incomeCompany" list="incomeCompanyList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить название фирмы..."
                                required>
                            <datalist id="incomeCompanyList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="incomeCompanyError" class="text-red-500 text-sm mt-1 hidden">Фирма не найдена в
                                списке!</div>
                        </div>
                        <div>
                            <label for="incomeWarehouse" class="block text-sm font-medium mb-2">Склад</label>
                            <input type="text" id="incomeWarehouse" list="incomeWarehouseList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить название склада..."
                                required>
                            <datalist id="incomeWarehouseList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="incomeWarehouseError" class="text-red-500 text-sm mt-1 hidden">Склад не найден в
                                списке!</div>
                        </div>
                        <div>
                            <label for="incomeProduct" class="block text-sm font-medium mb-2">Товар</label>
                            <input type="text" id="incomeProduct" list="incomeProductList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить название товара..."
                                required>
                            <datalist id="incomeProductList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="incomeProductError" class="text-red-500 text-sm mt-1 hidden">Товар не найден в
                                списке!</div>
                        </div>
                        <div>
                            <label for="incomeQtyDoc" class="block text-sm font-medium mb-2">Коли-по док</label>
                            <input type="number" id="incomeQtyDoc" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="incomeQtyFact" class="block text-sm font-medium mb-2">Коли-Факт</label>
                            <input type="number" id="incomeQtyFact" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="incomeDifference" class="block text-sm font-medium mb-2">Разница</label>
                            <input type="number" id="incomeDifference" class="w-full p-2 border rounded bg-gray-100"
                                readonly>
                        </div>
                        <div>
                            <label for="incomeWeightTons" class="block text-sm font-medium mb-2">Вес Тонн Факт</label>
                            <input type="number" id="incomeWeightTons" class="w-full p-2 border rounded bg-gray-100"
                                readonly step="0.01">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="incomeNotes" class="block text-sm font-medium mb-2">Примечания</label>
                            <textarea id="incomeNotes" class="w-full p-2 border rounded" rows="2"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit"
                                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Добавить
                                приход</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Дата</th>
                                <th class="p-3 text-left">Вагон</th>
                                <th class="p-3 text-left">Фирма</th>
                                <th class="p-3 text-left">Склад</th>
                                <th class="p-3 text-left">Товар</th>
                                <th class="p-3 text-left">По док</th>
                                <th class="p-3 text-left">Факт</th>
                                <th class="p-3 text-left">Разница</th>
                                <th class="p-3 text-left">Тонн</th>
                                <th class="p-3 text-left">Пользователь</th>
                                <th class="p-3 text-left">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="incomeTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Расход -->
            <div id="expense" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Расход товаров</h1>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="expenseDate" class="block text-sm font-medium mb-2">Дата</label>
                            <input type="date" id="expenseDate" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="expenseCoalition" class="block text-sm font-medium mb-2">Коалица
                                (необязательно)</label>
                            <select id="expenseCoalition" class="w-full p-2 border rounded">
                                <option value="">Выберите коалицу</option>
                            </select>
                        </div>
                        <div>
                            <label for="expenseNumber" class="block text-sm font-medium mb-2">Номер
                                (месяц\квитанция)</label>
                            <input type="text" id="expenseNumber" class="w-full p-2 border rounded"
                                placeholder="01\0001" pattern="[0-9]{2}\\[0-9]+"
                                title="Формат: месяц\номер (например, 01\0001)">
                        </div>
                        <div>
                            <label for="expenseCompany" class="block text-sm font-medium mb-2">Фирма</label>
                            <input type="text" id="expenseCompany" list="expenseCompanyList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить название фирмы..."
                                required>
                            <datalist id="expenseCompanyList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="expenseCompanyError" class="text-red-500 text-sm mt-1 hidden">Фирма не найдена в
                                списке!</div>
                        </div>
                        <div>
                            <label for="expenseWarehouse" class="block text-sm font-medium mb-2">Склад</label>
                            <input type="text" id="expenseWarehouse" list="expenseWarehouseList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить название склада..."
                                required>
                            <datalist id="expenseWarehouseList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="expenseWarehouseError" class="text-red-500 text-sm mt-1 hidden">Склад не найден в
                                списке!</div>
                        </div>
                        <div>
                            <label for="expenseProduct" class="block text-sm font-medium mb-2">Товар</label>
                            <input type="text" id="expenseProduct" list="expenseProductList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить название товара..."
                                required>
                            <datalist id="expenseProductList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="expenseProductError" class="text-red-500 text-sm mt-1 hidden">Товар не найден в
                                списке!</div>
                        </div>
                        <div>
                            <label for="expenseClient" class="block text-sm font-medium mb-2">Клиент</label>
                            <input type="text" id="expenseClient" list="expenseClientList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить имя клиента..." required>
                            <datalist id="expenseClientList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="expenseClientError" class="text-red-500 text-sm mt-1 hidden">Клиент не найден в
                                списке!</div>
                        </div>
                        <div>
                            <label for="expenseQuantity" class="block text-sm font-medium mb-2">Количество</label>
                            <input type="number" id="expenseQuantity" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="expenseTons" class="block text-sm font-medium mb-2">Тонн</label>
                            <input type="number" id="expenseTons" class="w-full p-2 border rounded bg-gray-100" readonly
                                step="0.01">
                        </div>
                        <div>
                            <label for="expensePrice" class="block text-sm font-medium mb-2">Цена за единицу</label>
                            <input type="number" id="expensePrice" class="w-full p-2 border rounded" required
                                step="0.01">
                        </div>
                        <div>
                            <label for="expenseTotal" class="block text-sm font-medium mb-2">Общая сумма</label>
                            <input type="number" id="expenseTotal" class="w-full p-2 border rounded bg-gray-100"
                                readonly step="0.01">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="expenseNotes" class="block text-sm font-medium mb-2">Примечания</label>
                            <textarea id="expenseNotes" class="w-full p-2 border rounded" rows="2"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit"
                                class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 mr-4">Добавить
                                расход</button>
                            <button type="button" id="createInvoiceBtn"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 mr-4">Создать
                                накладную</button>
                            <button type="button" id="addTestDataBtn"
                                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Тестовые
                                данные</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">
                                    <input type="checkbox" id="selectAllExpense" class="mr-2">
                                    Выбрать
                                </th>
                                <th class="p-3 text-left">Дата</th>
                                <th class="p-3 text-left">Коалица</th>
                                <th class="p-3 text-left">Номер</th>
                                <th class="p-3 text-left">Фирма</th>
                                <th class="p-3 text-left">Склад</th>
                                <th class="p-3 text-left">Товар</th>
                                <th class="p-3 text-left">Клиент</th>
                                <th class="p-3 text-left">Количество</th>
                                <th class="p-3 text-left">Тонн</th>
                                <th class="p-3 text-left">Цена</th>
                                <th class="p-3 text-left">Сумма</th>
                                <th class="p-3 text-left">Пользователь</th>
                                <th class="p-3 text-left">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Погашения -->
            <div id="payments" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Погашения</h1>
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <form id="paymentsForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="paymentDate" class="block text-sm font-medium mb-2">Дата</label>
                            <input type="date" id="paymentDate" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="paymentClient" class="block text-sm font-medium mb-2">Клиент</label>
                            <input type="text" id="paymentClient" list="paymentClientList"
                                class="w-full p-2 border rounded" placeholder="Начните вводить имя клиента..." required>
                            <datalist id="paymentClientList">
                                <!-- Опции будут добавлены динамически -->
                            </datalist>
                            <div id="paymentClientError" class="text-red-500 text-sm mt-1 hidden">Клиент не найден в
                                списке!</div>
                        </div>
                        <div>
                            <label for="paymentSomoni" class="block text-sm font-medium mb-2">Сомони</label>
                            <input type="number" id="paymentSomoni" class="w-full p-2 border rounded" required
                                step="0.01">
                        </div>
                        <div>
                            <label for="paymentRate" class="block text-sm font-medium mb-2">Курс</label>
                            <input type="number" id="paymentRate" class="w-full p-2 border rounded" required
                                step="0.01">
                        </div>
                        <div>
                            <label for="paymentAmount" class="block text-sm font-medium mb-2">Сумма
                                (блокировано)</label>
                            <input type="number" id="paymentAmount" class="w-full p-2 border rounded bg-gray-100"
                                readonly step="0.01">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="paymentNotes" class="block text-sm font-medium mb-2">Примечания</label>
                            <textarea id="paymentNotes" class="w-full p-2 border rounded" rows="2"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <button type="submit"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 mr-4">Добавить
                                погашение</button>
                            <button type="button" id="createCashOrderBtn"
                                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Создать кассовый
                                ордер</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">
                                    <input type="checkbox" id="selectAllPayments" class="mr-2">
                                    Выбрать
                                </th>
                                <th class="p-3 text-left">Дата</th>
                                <th class="p-3 text-left">Клиент</th>
                                <th class="p-3 text-left">Сомони</th>
                                <th class="p-3 text-left">Курс</th>
                                <th class="p-3 text-left">Сумма</th>
                                <th class="p-3 text-left">Примечания</th>
                                <th class="p-3 text-left">Пользователь</th>
                                <th class="p-3 text-left">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Свод Вагонов -->
            <div id="wagon-summary" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Свод Вагонов</h1>
                <div class="mb-4">
                    <label for="wagonSummaryWarehouse" class="block text-sm font-medium mb-2">Склад</label>
                    <select id="wagonSummaryWarehouse" class="p-2 border rounded">
                        <option value="">Все склады</option>
                    </select>
                </div>
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Вагон</th>
                                <th class="p-3 text-left">Фирма</th>
                                <th class="p-3 text-left">Склад</th>
                                <th class="p-3 text-left">Товар</th>
                                <th class="p-3 text-left">По док</th>
                                <th class="p-3 text-left">Факт</th>
                                <th class="p-3 text-left">Тонн</th>
                            </tr>
                        </thead>
                        <tbody id="wagonSummaryTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded">
                    <h3 class="font-semibold">Итоги для информации:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                        <div>Всего вагонов: <span id="totalWagons">0</span></div>
                        <div>Общий вес: <span id="totalWeight">0</span> тонн</div>
                        <div>Общая разница: <span id="totalDifference">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Свод Остатков -->
            <div id="balance-summary" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Свод Остатков</h1>
                <div class="mb-4">
                    <label for="balanceSummaryWarehouse" class="block text-sm font-medium mb-2">Склад</label>
                    <select id="balanceSummaryWarehouse" class="p-2 border rounded">
                        <option value="">Все склады</option>
                    </select>
                </div>
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Склад</th>
                                <th class="p-3 text-left">Фирма</th>
                                <th class="p-3 text-left">Товар</th>
                                <th class="p-3 text-left">Приход</th>
                                <th class="p-3 text-left">Расход</th>
                                <th class="p-3 text-left">Остаток</th>
                                <th class="p-3 text-left">Остаток тонн</th>
                            </tr>
                        </thead>
                        <tbody id="balanceSummaryTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded">
                    <h3 class="font-semibold">Итоги для информации:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                        <div>Общий приход: <span id="summaryTotalIncome">0</span></div>
                        <div>Общий расход: <span id="summaryTotalExpense">0</span></div>
                        <div>Общий остаток: <span id="summaryTotalBalance">0</span> тонн</div>
                    </div>
                </div>
            </div>

            <!-- Остатки складов -->
            <div id="stock-balance" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">📦 Остатки складов</h1>

                <!-- Фильтры -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="stockBalanceCompany" class="block text-sm font-medium mb-2">Компания</label>
                            <select id="stockBalanceCompany" class="w-full p-2 border rounded">
                                <option value="">Все компании</option>
                                <option value="Торговый Дом">Торговый Дом</option>
                            </select>
                        </div>
                        <div>
                            <label for="stockBalanceWarehouse" class="block text-sm font-medium mb-2">Склад</label>
                            <select id="stockBalanceWarehouse" class="w-full p-2 border rounded">
                                <option value="">Все склады</option>
                            </select>
                        </div>
                        <div>
                            <label for="stockBalanceYear" class="block text-sm font-medium mb-2">Год</label>
                            <select id="stockBalanceYear" class="w-full p-2 border rounded">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                    </div>

                    <!-- Дополнительные опции -->
                    <div class="mt-4 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="showZeroBalance" class="mr-2" checked>
                            <span class="text-sm font-medium">Показать нулевые остатки</span>
                        </label>
                    </div>

                    <div class="mt-4 flex flex-wrap gap-2">
                        <button id="generateStockBalanceBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            📊 Сформировать отчет
                        </button>
                        <button id="exportStockBalanceWhatsAppBtn"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            📱 Отправить в WhatsApp
                        </button>
                        <button id="printStockBalanceBtn"
                            class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                            🖨️ Печать
                        </button>
                    </div>
                </div>

                <!-- Отчет -->
                <div id="stockBalanceReport" class="bg-white rounded-lg shadow p-6 hidden">
                    <div id="stockBalanceContent" class="stock-balance-report">
                        <!-- Содержимое отчета будет добавлено динамически -->
                    </div>
                </div>
            </div>

            <!-- Отчёт по долгам -->
            <div id="debt-report" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Отчёт по остаток долгов</h1>
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Клиент</th>
                                <th class="p-3 text-left">Общая задолженность</th>
                                <th class="p-3 text-left">Погашено</th>
                                <th class="p-3 text-left">Остаток долга</th>
                            </tr>
                        </thead>
                        <tbody id="debtReportTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded">
                    <h3 class="font-semibold mb-2">Итоги для информации:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>Общая задолженность: <span id="totalDebtSum">0</span></div>
                        <div>Всего погашено: <span id="totalPaidSum">0</span></div>
                        <div class="text-green-600">Переплаты: <span id="totalOverpayment">0</span></div>
                        <div class="text-red-600">Долги: <span id="totalDebts">0</span></div>
                    </div>
                    <div class="mt-2 pt-2 border-t">
                        <div class="font-semibold">Итоговый баланс: <span id="totalDebtAmount" class="text-lg">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Итоги Вагонов -->
            <div id="wagon-totals" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Итоги Вагонов количество по складам</h1>
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Товар</th>
                                <th class="p-3 text-left">Фирма</th>
                                <th class="p-3 text-left">Склад</th>
                                <th class="p-3 text-left">Количество вагонов</th>
                                <th class="p-3 text-left">Приход по док</th>
                                <th class="p-3 text-left">Приход по факт</th>
                                <th class="p-3 text-left">Разница</th>
                                <th class="p-3 text-left">Вес тонн</th>
                            </tr>
                        </thead>
                        <tbody id="wagonTotalsTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded">
                    <h3 class="font-semibold">Итоги для информации:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-2">
                        <div>Всего вагонов: <span id="grandTotalWagons">0</span></div>
                        <div>Общий приход по док: <span id="grandTotalDoc">0</span></div>
                        <div>Общий приход по факт: <span id="grandTotalFact">0</span></div>
                        <div>Общая разница: <span id="grandTotalDifference">0</span></div>
                        <div>Общий вес: <span id="grandTotalWeight">0</span> тонн</div>
                    </div>
                </div>
            </div>

            <!-- Отчёты -->
            <div id="reports" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Отчёты</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <button class="report-btn bg-blue-600 text-white p-4 rounded hover:bg-blue-700"
                        data-report="product-expense">Отчёт по расходу товаров</button>
                    <button class="report-btn bg-green-600 text-white p-4 rounded hover:bg-green-700"
                        data-report="product-income">Отчёт по приходу товаров</button>
                    <button class="report-btn bg-purple-600 text-white p-4 rounded hover:bg-purple-700"
                        data-report="client-expense">Расход по клиентам</button>
                    <button class="report-btn bg-orange-600 text-white p-4 rounded hover:bg-orange-700"
                        data-report="client-period">Расход по клиентам за период</button>
                    <button class="report-btn bg-indigo-600 text-white p-4 rounded hover:bg-indigo-700"
                        data-report="warehouse-report">Отчёт по складам</button>
                    <button class="report-btn bg-teal-600 text-white p-4 rounded hover:bg-teal-700"
                        data-report="payments-report">Отчёт по погашениям</button>
                </div>

                <div id="reportFilters" class="bg-white p-4 rounded-lg shadow mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Фильтры</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="reportDateFrom" class="block text-sm font-medium mb-2">Дата с</label>
                            <input type="date" id="reportDateFrom" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label for="reportDateTo" class="block text-sm font-medium mb-2">Дата по</label>
                            <input type="date" id="reportDateTo" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label for="reportWarehouse" class="block text-sm font-medium mb-2">Склад</label>
                            <select id="reportWarehouse" class="w-full p-2 border rounded">
                                <option value="">Все склады</option>
                            </select>
                        </div>
                        <div>
                            <label for="reportClient" class="block text-sm font-medium mb-2">Клиент</label>
                            <select id="reportClient" class="w-full p-2 border rounded">
                                <option value="">Все клиенты</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button id="generateReport"
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Сформировать
                            отчёт</button>
                        <button id="exportToExcel"
                            class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 hidden">
                            📊 Экспорт в Excel</button>
                    </div>
                </div>

                <div id="reportResults" class="bg-white rounded-lg shadow overflow-x-auto hidden">
                    <div class="p-4 border-b">
                        <h3 id="reportTitle" class="text-lg font-semibold"></h3>
                    </div>
                    <div id="reportContent"></div>
                </div>
            </div>



            <!-- Управление -->
            <div id="management" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Управление товарами, фирмами и складами</h1>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Управление товарами -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Товары</h3>
                        <form id="productForm" class="mb-4">
                            <input type="text" id="productName" placeholder="Название товара"
                                class="w-full p-2 border rounded mb-2" required>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Добавить
                                товар</button>
                        </form>
                        <div class="space-y-2" id="productsList"></div>
                    </div>

                    <!-- Управление фирмами -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Фирмы</h3>
                        <form id="companyForm" class="mb-4">
                            <input type="text" id="companyName" placeholder="Название фирмы"
                                class="w-full p-2 border rounded mb-2" required>
                            <button type="submit"
                                class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">Добавить
                                фирму</button>
                        </form>
                        <div class="space-y-2" id="companiesList"></div>
                    </div>

                    <!-- Управление складами -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Склады</h3>
                        <form id="warehouseForm" class="mb-4">
                            <input type="text" id="warehouseName" placeholder="Название склада"
                                class="w-full p-2 border rounded mb-2" required>
                            <select id="warehouseGroup" class="w-full p-2 border rounded mb-2" required>
                                <option value="">Выберите подгруппу</option>
                            </select>
                            <button type="submit"
                                class="w-full bg-purple-600 text-white p-2 rounded hover:bg-purple-700">Добавить
                                склад</button>
                        </form>
                        <div class="space-y-2" id="warehousesList"></div>
                    </div>

                    <!-- Управление коалицами -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Коалица</h3>
                        <form id="coalitionForm" class="mb-4">
                            <input type="text" id="coalitionName" placeholder="Название коалицы"
                                class="w-full p-2 border rounded mb-2" required>
                            <button type="submit"
                                class="w-full bg-teal-600 text-white p-2 rounded hover:bg-teal-700">Добавить
                                коалицу</button>
                        </form>
                        <div class="space-y-2" id="coalitionsList"></div>
                    </div>
                </div>

                <!-- Управление подгруппами складов -->
                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Подгруппы складов</h3>
                    <form id="warehouseGroupForm" class="mb-4">
                        <div class="flex gap-2">
                            <input type="text" id="warehouseGroupName" placeholder="Название подгруппы"
                                class="flex-1 p-2 border rounded" required>
                            <button type="submit"
                                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Добавить</button>
                        </div>
                    </form>
                    <div class="space-y-2" id="warehouseGroupsList"></div>
                </div>

                <!-- Управление клиентами -->
                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Клиенты</h3>
                    <form id="clientForm" class="mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <input type="text" id="clientName" placeholder="Имя клиента" class="p-2 border rounded"
                                required>
                            <input type="tel" id="clientPhone" placeholder="Телефон (необязательно)"
                                class="p-2 border rounded">
                            <button type="submit"
                                class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">Добавить
                                клиента</button>
                        </div>
                    </form>
                    <div class="space-y-2" id="clientsList"></div>
                </div>

                <!-- Управление годами (только для администраторов) -->
                <div id="yearManagementSection" class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Управление годами <span class="text-sm text-gray-500">(только
                            для администраторов)</span></h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Добавление нового года -->
                        <div>
                            <h4 class="font-medium mb-3">Добавить новый год</h4>
                            <form id="yearForm" class="mb-4">
                                <div class="flex gap-2">
                                    <input type="number" id="newYearInput" placeholder="2026" min="2020" max="2050"
                                        class="flex-1 p-2 border rounded" required>
                                    <button type="submit"
                                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Добавить
                                        год</button>
                                </div>
                            </form>
                            <div class="text-sm text-gray-600">
                                <p>• Год должен быть в формате YYYY (например, 2026)</p>
                                <p>• Новый год будет создан с пустыми данными</p>
                                <p>• После создания вы автоматически переключитесь на новый год</p>
                            </div>
                        </div>

                        <!-- Список существующих годов -->
                        <div>
                            <h4 class="font-medium mb-3">Существующие года</h4>
                            <div id="yearsList" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- Года будут добавлены динамически -->
                            </div>
                        </div>
                    </div>

                    <!-- Статистика по годам -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="font-medium mb-3">Статистика по годам</h4>
                        <div id="yearsStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Статистика будет добавлена динамически -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Пользователи -->
            <div id="users" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Управление пользователями</h1>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">Добавить пользователя</h3>
                    <form id="userForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="newUsername" class="block text-sm font-medium mb-2">Логин</label>
                            <input type="text" id="newUsername" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium mb-2">Пароль</label>
                            <input type="password" id="newPassword" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="userRole" class="block text-sm font-medium mb-2">Роль</label>
                            <select id="userRole" class="w-full p-2 border rounded" required>
                                <option value="">Выберите роль</option>
                                <option value="admin">Администратор</option>
                                <option value="warehouse">Завсклада</option>
                                <option value="cashier">Кассир</option>
                                <option value="manager">Руководитель</option>
                            </select>
                        </div>
                        <div>
                            <label for="userWarehouseGroup" class="block text-sm font-medium mb-2">Подгруппы
                                складов</label>
                            <select id="userWarehouseGroup" class="w-full p-2 border rounded" multiple size="4">
                                <!-- Опции будут добавлены динамически -->
                            </select>
                            <div class="text-xs text-gray-600 mt-1">
                                Удерживайте Ctrl (Cmd на Mac) для выбора нескольких групп
                            </div>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="userBlocked" class="mr-2">
                                <span class="text-sm font-medium">🔒 Заблокировать пользователя</span>
                            </label>
                        </div>
                        <div class="md:col-span-2 flex gap-4">
                            <button type="submit"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Добавить
                                пользователя</button>
                            <button type="button" id="restoreDefaultUsersBtn"
                                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Восстановить
                                пользователей по умолчанию</button>
                            <button type="button" id="resetToDefaultBtn"
                                class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">Сбросить к настройкам
                                по умолчанию</button>
                        </div>
                    </form>
                </div>

                <!-- Смена паролей -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold mb-4">Смена пароля</h3>
                    <form id="changePasswordForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="userSelectDiv" class="md:col-span-2">
                            <label for="changePasswordUser" class="block text-sm font-medium mb-2">Пользователь</label>
                            <select id="changePasswordUser" class="w-full p-2 border rounded" required>
                                <option value="">Выберите пользователя</option>
                            </select>
                        </div>
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium mb-2">Текущий пароль</label>
                            <input type="password" id="currentPassword" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="newPasswordChange" class="block text-sm font-medium mb-2">Новый пароль</label>
                            <input type="password" id="newPasswordChange" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label for="confirmPassword" class="block text-sm font-medium mb-2">Подтвердите
                                пароль</label>
                            <input type="password" id="confirmPassword" class="w-full p-2 border rounded" required>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit"
                                class="bg-orange-600 text-white px-6 py-2 rounded hover:bg-orange-700">Изменить
                                пароль</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left">Логин</th>
                                <th class="p-3 text-left">Роль</th>
                                <th class="p-3 text-left">Подгруппа складов</th>
                                <th class="p-3 text-left">Статус</th>
                                <th class="p-3 text-left">Требует смену пароля</th>
                                <th class="p-3 text-left">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Резервное копирование -->
            <div id="backup" class="content-section hidden">
                <h1 class="text-3xl font-bold mb-6">Резервное копирование и экспорт</h1>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Экспорт данных</h3>
                        <p class="text-gray-600 mb-4">Создать резервную копию всех данных</p>
                        <button id="exportBtn"
                            class="w-full bg-green-600 text-white p-3 rounded hover:bg-green-700">Экспорт JSON</button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Экспорт в Excel</h3>
                        <p class="text-gray-600 mb-4">Экспорт всех данных в Excel таблицы</p>
                        <button id="exportExcelBtn"
                            class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Экспорт Excel</button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Импорт данных</h3>
                        <p class="text-gray-600 mb-4">Восстановить данные из резервной копии</p>
                        <input type="file" id="importFile" accept=".json" class="w-full p-2 border rounded mb-4">
                        <button id="importBtn"
                            class="w-full bg-purple-600 text-white p-3 rounded hover:bg-purple-700">Импорт
                            данных</button>
                    </div>
                </div>

                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Экспорт отдельных разделов в Excel</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button id="exportIncomeExcel"
                            class="bg-green-500 text-white p-3 rounded hover:bg-green-600">Приход</button>
                        <button id="exportExpenseExcel"
                            class="bg-red-500 text-white p-3 rounded hover:bg-red-600">Расход</button>
                        <button id="exportPaymentsExcel"
                            class="bg-blue-500 text-white p-3 rounded hover:bg-blue-600">Погашения</button>
                        <button id="exportDebtExcel"
                            class="bg-orange-500 text-white p-3 rounded hover:bg-orange-600">Долги</button>
                        <button id="exportWagonSummaryExcel"
                            class="bg-indigo-500 text-white p-3 rounded hover:bg-indigo-600">Свод вагонов</button>
                        <button id="exportBalanceSummaryExcel"
                            class="bg-purple-500 text-white p-3 rounded hover:bg-purple-600">Свод остатков</button>
                        <button id="exportWagonTotalsExcel"
                            class="bg-pink-500 text-white p-3 rounded hover:bg-pink-600">Итоги вагонов</button>
                        <button id="exportManagementExcel"
                            class="bg-gray-500 text-white p-3 rounded hover:bg-gray-600">Справочники</button>
                    </div>
                </div>

                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4 text-blue-600">Синхронизация с облаком</h3>
                    <div class="bg-green-50 border border-green-200 rounded p-3 mb-4">
                        <p class="text-sm text-green-800">
                            <strong>Проект:</strong> warehouse-system-f4e52
                            <br><strong>Регион:</strong> Asia Southeast (Сингапур)
                            <br><strong>Статус:</strong> <span id="firebaseConfigStatus"
                                class="font-semibold text-green-600">Настроено ✓</span>
                        </p>
                    </div>
                    <p class="text-gray-600 mb-4">Управление синхронизацией данных с Firebase.</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <button id="connectFirebaseBtn"
                            class="bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700">
                            Подключиться
                            <div class="text-xs mt-1">Включить синхронизацию</div>
                        </button>
                        <button id="syncToCloudBtn" class="bg-blue-600 text-white px-4 py-3 rounded hover:bg-blue-700">
                            Загрузить в облако
                            <div class="text-xs mt-1">Отправить локальные данные</div>
                        </button>
                        <button id="syncFromCloudBtn"
                            class="bg-purple-600 text-white px-4 py-3 rounded hover:bg-purple-700">
                            Загрузить из облака
                            <div class="text-xs mt-1">Получить данные с сервера</div>
                        </button>
                        <button id="refreshInterfaceBtn"
                            class="bg-orange-600 text-white px-4 py-3 rounded hover:bg-orange-700">
                            Обновить интерфейс
                            <div class="text-xs mt-1">Перезагрузить таблицы</div>
                        </button>
                    </div>
                </div>

                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4 text-red-600">Очистка базы данных</h3>
                    <p class="text-gray-600 mb-4">Внимание! Эти действия удалят данные безвозвратно.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="clearOperationsBtn"
                            class="bg-orange-600 text-white px-4 py-3 rounded hover:bg-orange-700">
                            Очистить операции
                            <div class="text-xs mt-1">Приходы, расходы, погашения</div>
                        </button>
                        <button id="clearCatalogsBtn"
                            class="bg-yellow-600 text-white px-4 py-3 rounded hover:bg-yellow-700">
                            Очистить каталоги
                            <div class="text-xs mt-1">Фирмы, склады, товары, клиенты</div>
                        </button>
                        <button id="clearAllBtn" class="bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700">
                            Полная очистка
                            <div class="text-xs mt-1">Все данные кроме admin</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания накладной -->
    <div id="invoiceModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-full overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Создание расходной накладной</h2>
                    <button id="closeInvoiceModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <label for="invoiceClient" class="block text-sm font-medium mb-2">Выберите клиента</label>
                    <select id="invoiceClient" class="w-full p-2 border rounded">
                        <option value="">Выберите клиента</option>
                    </select>
                </div>

                <div id="selectedExpensesList" class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Выбранные документы</h3>
                    <div id="selectedExpensesContent" class="space-y-4"></div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button id="cancelInvoice"
                        class="px-6 py-2 border border-gray-300 rounded hover:bg-gray-50">Отмена</button>
                    <button id="printInvoice" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Печать
                        накладной</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для печати накладной -->
    <div id="printModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-5xl w-full max-h-full overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Расходная накладная</h2>
                    <div class="space-x-2">
                        <button id="exportInvoiceExcel"
                            class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Экспорт
                            Excel</button>
                        <button id="printInvoiceBtn"
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Печать</button>
                        <button id="closePrintModal"
                            class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Закрыть</button>
                    </div>
                </div>

                <div id="invoiceContent" class="print-content">
                    <!-- Содержимое накладной будет сгенерировано здесь -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания кассового ордера -->
    <div id="cashOrderModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-full overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Создание расходного кассового ордера</h2>
                    <button id="closeCashOrderModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-6">
                    <label for="cashOrderClient" class="block text-sm font-medium mb-2">Выберите клиента</label>
                    <select id="cashOrderClient" class="w-full p-2 border rounded">
                        <option value="">Выберите клиента</option>
                    </select>
                </div>

                <div id="selectedPaymentsList" class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Выбранные погашения</h3>
                    <div id="selectedPaymentsContent" class="space-y-4"></div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button id="cancelCashOrder"
                        class="px-6 py-2 border border-gray-300 rounded hover:bg-gray-50">Отмена</button>
                    <button id="printCashOrder"
                        class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">Печать кассового
                        ордера</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для печати кассового ордера -->
    <div id="printCashOrderModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-5xl w-full max-h-full overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Расходный кассовый ордер</h2>
                    <div class="space-x-2">
                        <button id="exportCashOrderExcel"
                            class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Экспорт
                            Excel</button>
                        <button id="printCashOrderBtn"
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Печать</button>
                        <button id="closePrintCashOrderModal"
                            class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Закрыть</button>
                    </div>
                </div>

                <div id="cashOrderContent" class="print-content">
                    <!-- Содержимое кассового ордера будет сгенерировано здесь -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно результатов импорта -->
    <div id="importResultModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-full overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Результаты импорта</h2>
                    <button id="closeImportResultModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div id="importResultContent" class="space-y-4">
                    <!-- Содержимое результатов импорта будет сгенерировано здесь -->
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="closeImportResult"
                        class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно принудительной смены пароля -->
    <div id="forcePasswordChangeModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                        <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 mb-2">Требуется смена пароля</h2>
                    <p class="text-gray-600">Администратор требует, чтобы вы сменили пароль перед продолжением работы.
                    </p>
                </div>

                <form id="forcePasswordChangeForm" class="space-y-4">
                    <div>
                        <label for="forceCurrentPassword" class="block text-sm font-medium mb-2">Текущий пароль</label>
                        <input type="password" id="forceCurrentPassword" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="forceNewPassword" class="block text-sm font-medium mb-2">Новый пароль</label>
                        <input type="password" id="forceNewPassword" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div>
                        <label for="forceConfirmPassword" class="block text-sm font-medium mb-2">Подтвердите новый
                            пароль</label>
                        <input type="password" id="forceConfirmPassword" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="forcePasswordLogout"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">Выйти</button>
                        <button type="submit"
                            class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">Изменить
                            пароль</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования групп пользователя -->
    <div id="editUserGroupsModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">✏️ Редактировать группы складов</h2>
                    <button onclick="hideEditUserGroupsModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">Пользователь: <span id="editGroupsUsername" class="font-semibold"></span></p>
                    <p class="text-sm text-gray-600 mb-4">Роль: <span id="editGroupsUserRole" class="font-semibold"></span></p>
                </div>

                <form id="editUserGroupsForm" class="space-y-4">
                    <div>
                        <label for="editUserGroupsSelect" class="block text-sm font-medium mb-2">Подгруппы складов</label>
                        <select id="editUserGroupsSelect" class="w-full p-2 border rounded" multiple size="6">
                            <!-- Опции будут добавлены динамически -->
                        </select>
                        <div class="text-xs text-gray-600 mt-1">
                            Удерживайте Ctrl (Cmd на Mac) для выбора нескольких групп
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideEditUserGroupsModal()"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 border rounded">Отмена</button>
                        <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            .print-content,
            .print-content * {
                visibility: visible;
            }

            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            #printModal {
                position: static !important;
                background: white !important;
            }
        }
    </style>

    <script>
        // Данные приложения
        let appData = {
            users: [
                { username: 'admin', password: 'P0l1uret@n@', role: 'admin', warehouseGroup: [''], blocked: false }
            ],
            products: [],
            companies: [],
            warehouses: [],
            warehouseGroups: [],
            clients: [],
            years: {},
            currentYear: new Date().getFullYear(),
            income: [],
            expense: [],
            payments: []
        };

        let currentUser = null;
        let currentInvoiceData = null;
        let currentCashOrderData = null;

        // Функции управления годами с проверкой прав
        function switchYear(year) {
            if (!year) return;

            console.log('🔄 Переключение на год:', year);
            console.log('🔄 Предыдущий год был:', appData.currentYear);
            appData.currentYear = year;
            console.log('🔄 Новый текущий год установлен:', appData.currentYear);

            // Обновляем отображение текущего года
            const currentYearDisplay = document.getElementById('currentYearDisplay');
            if (currentYearDisplay) {
                currentYearDisplay.textContent = year;
            }

            // Обновляем отображение в мобильном меню
            const mobileCurrentYear = document.getElementById('mobile-current-year');
            if (mobileCurrentYear) {
                mobileCurrentYear.textContent = year;
            }

            // Обновляем отображение года в мобильной шапке
            const mobileCurrentYearDisplay = document.getElementById('mobileCurrentYearDisplay');
            if (mobileCurrentYearDisplay) {
                mobileCurrentYearDisplay.textContent = year;
            }

            // Обновляем все таблицы для нового года
            updateAllTables();

            // Обновляем селектор года в разделе остатков складов
            if (typeof updateStockBalanceYearSelector === 'function') {
                updateStockBalanceYearSelector();
            }

            saveData();

            if (window.showSuccessMessage) {
                window.showSuccessMessage(`Переключено на ${year} год`);
            }
        }

        // Делаем функцию доступной глобально
        window.switchYear = switchYear;

        function addNewYear() {
            // Проверяем права доступа - только администраторы могут создавать года
            if (!currentUser || currentUser.role !== 'admin') {
                if (window.showErrorMessage) {
                    window.showErrorMessage('Только администраторы могут создавать новые года!');
                } else {
                    alert('Только администраторы могут создавать новые года!');
                }
                return;
            }

            const year = prompt('Введите новый год (например, 2026):');

            if (!year) {
                return; // Пользователь отменил
            }

            if (!/^\d{4}$/.test(year)) {
                if (window.showErrorMessage) {
                    window.showErrorMessage('Пожалуйста, введите корректный год (4 цифры)');
                } else {
                    alert('Пожалуйста, введите корректный год (4 цифры)');
                }
                return;
            }

            if (appData.years[year]) {
                if (window.showWarningMessage) {
                    window.showWarningMessage(`Год ${year} уже существует!`);
                } else {
                    alert(`Год ${year} уже существует!`);
                }
                return;
            }

            // Добавляем новый год
            appData.years[year] = {
                income: [],
                expense: [],
                payments: []
            };

            updateYearSelector();
            switchYear(year);
            saveData();

            if (window.showSuccessMessage) {
                window.showSuccessMessage(`Год ${year} успешно создан и активирован!`);
            } else {
                alert(`Год ${year} успешно создан и активирован!`);
            }
        }

        function updateYearSelector() {
            const selector = document.getElementById('yearSelector');
            const mobileSelector = document.getElementById('mobile-year-selector');
            const mobileYearSelector = document.getElementById('mobileYearSelector'); // Новый селектор в шапке
            const currentYearDisplay = document.getElementById('currentYearDisplay');
            const mobileCurrentYear = document.getElementById('mobile-current-year');

            // Сортируем годы по убыванию (новые сверху)
            const sortedYears = Object.keys(appData.years).sort((a, b) => b - a);

            // Обновляем десктопный селектор
            if (selector) {
                selector.innerHTML = '';
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === appData.currentYear.toString()) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            }

            // Обновляем мобильный селектор в боковом меню
            if (mobileSelector) {
                mobileSelector.innerHTML = '';
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === appData.currentYear.toString()) {
                        option.selected = true;
                    }
                    mobileSelector.appendChild(option);
                });
            }

            // Обновляем новый мобильный селектор в шапке
            if (mobileYearSelector) {
                mobileYearSelector.innerHTML = '';
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === appData.currentYear.toString()) {
                        option.selected = true;
                    }
                    mobileYearSelector.appendChild(option);
                });
            }

            // Обновляем отображение текущего года
            if (currentYearDisplay) {
                currentYearDisplay.textContent = appData.currentYear;
            }
            if (mobileCurrentYear) {
                mobileCurrentYear.textContent = appData.currentYear;
            }

            // Обновляем мобильный селектор если функция доступна
            if (window.updateMobileYearSelector) {
                window.updateMobileYearSelector();
            }

            // Обновляем мобильное отображение текущего года
            updateMobileCurrentYearDisplay();
        }

        function setupYearManagement() {
            // Инициализируем года если не существуют
            if (!appData.years) {
                appData.years = {};
            }

            const currentYear = new Date().getFullYear().toString();
            if (!appData.currentYear) {
                appData.currentYear = currentYear;
            }

            // Создаем текущий год если не существует
            if (!appData.years[appData.currentYear]) {
                appData.years[appData.currentYear] = {
                    income: [],
                    expense: [],
                    payments: []
                };
            }

            updateYearSelector();
            setupYearPermissions();
        }

        function setupYearPermissions() {
            const addYearBtn = document.querySelector('button[onclick="addNewYear()"]');
            const mobileAddYearBtn = document.getElementById('mobile-add-year-btn');
            const mobileAddYearBtnHeader = document.getElementById('mobileAddYearBtn'); // Новая кнопка в шапке

            // Показываем/скрываем кнопки добавления года в зависимости от роли
            const isAdmin = currentUser && currentUser.role === 'admin';

            if (addYearBtn) {
                if (isAdmin) {
                    addYearBtn.style.display = 'block';
                    addYearBtn.title = 'Добавить новый год (только для администраторов)';
                } else {
                    addYearBtn.style.display = 'none';
                }
            }

            if (mobileAddYearBtn) {
                if (isAdmin) {
                    mobileAddYearBtn.style.display = 'block';
                    mobileAddYearBtn.title = 'Добавить новый год (только для администраторов)';
                } else {
                    mobileAddYearBtn.style.display = 'none';
                }
            }

            // Управляем новой кнопкой в мобильной шапке
            if (mobileAddYearBtnHeader) {
                if (isAdmin) {
                    mobileAddYearBtnHeader.style.display = 'inline-block';
                    mobileAddYearBtnHeader.title = 'Добавить новый год (только для администраторов)';
                } else {
                    mobileAddYearBtnHeader.style.display = 'none';
                }
            }

            // Также обновляем мобильный селектор если функция доступна
            if (window.updateMobileYearSelector) {
                window.updateMobileYearSelector();
            }

            // Управляем видимостью раздела управления годами
            const yearManagementSection = document.getElementById('yearManagementSection');
            if (yearManagementSection) {
                if (isAdmin) {
                    yearManagementSection.style.display = 'block';
                } else {
                    yearManagementSection.style.display = 'none';
                }
            }
        }

        // Функции для управления годами в интерфейсе
        function initYearManagementInterface() {
            // Инициализируем форму добавления года
            const yearForm = document.getElementById('yearForm');
            if (yearForm) {
                yearForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const yearInput = document.getElementById('newYearInput');
                    const year = yearInput.value.trim();

                    if (year) {
                        addNewYearFromInterface(year);
                        yearInput.value = '';
                    }
                });
            }

            // Обновляем интерфейс
            updateYearManagementInterface();
        }

        function addNewYearFromInterface(year) {
            // Проверяем права доступа
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Только администраторы могут создавать новые года!');
                return;
            }

            // Валидация года
            if (!/^\d{4}$/.test(year)) {
                alert('Пожалуйста, введите корректный год (4 цифры)');
                return;
            }

            if (appData.years[year]) {
                alert(`Год ${year} уже существует!`);
                return;
            }

            // Добавляем новый год
            appData.years[year] = {
                income: [],
                expense: [],
                payments: []
            };

            updateYearSelector();
            updateYearManagementInterface();
            switchYear(year);
            saveData();

            alert(`Год ${year} успешно создан и активирован!`);
        }

        function updateYearManagementInterface() {
            updateYearsList();
            updateYearsStats();
        }

        function updateYearsList() {
            const yearsList = document.getElementById('yearsList');
            if (!yearsList) return;

            const years = Object.keys(appData.years || {}).sort((a, b) => b - a);

            yearsList.innerHTML = years.map(year => {
                const isCurrentYear = year === appData.currentYear;
                const data = appData.years[year];
                const incomeCount = data.income ? data.income.length : 0;
                const expenseCount = data.expense ? data.expense.length : 0;
                const paymentsCount = data.payments ? data.payments.length : 0;

                return `
                    <div class="flex items-center justify-between p-3 border rounded ${isCurrentYear ? 'bg-blue-50 border-blue-300' : 'bg-gray-50'}">
                        <div>
                            <div class="font-medium">${year} ${isCurrentYear ? '(текущий)' : ''}</div>
                            <div class="text-sm text-gray-600">
                                Приход: ${incomeCount}, Расход: ${expenseCount}, Погашения: ${paymentsCount}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${!isCurrentYear ? `<button onclick="switchYear('${year}')" class="text-blue-600 hover:text-blue-800 text-sm">Переключить</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateYearsStats() {
            const yearsStats = document.getElementById('yearsStats');
            if (!yearsStats) return;

            const years = Object.keys(appData.years || {});
            const totalYears = years.length;

            let totalRecords = 0;
            let currentYearRecords = 0;

            years.forEach(year => {
                const data = appData.years[year];
                const yearRecords = (data.income?.length || 0) + (data.expense?.length || 0) + (data.payments?.length || 0);
                totalRecords += yearRecords;

                if (year === appData.currentYear) {
                    currentYearRecords = yearRecords;
                }
            });

            yearsStats.innerHTML = `
                <div class="bg-blue-50 p-4 rounded">
                    <div class="text-2xl font-bold text-blue-600">${totalYears}</div>
                    <div class="text-sm text-gray-600">Всего годов</div>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <div class="text-2xl font-bold text-green-600">${totalRecords}</div>
                    <div class="text-sm text-gray-600">Всего записей</div>
                </div>
                <div class="bg-orange-50 p-4 rounded">
                    <div class="text-2xl font-bold text-orange-600">${currentYearRecords}</div>
                    <div class="text-sm text-gray-600">Записей в ${appData.currentYear}</div>
                </div>
            `;
        }

        // Мобильные функции для переключения годов
        function showMobileYearModal() {
            const modal = document.getElementById('mobileYearModal');
            if (modal) {
                updateMobileYearsList();
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Блокируем прокрутку фона
            }
        }

        function closeMobileYearModal() {
            const modal = document.getElementById('mobileYearModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Восстанавливаем прокрутку
            }
        }

        function updateMobileYearsList() {
            const yearsList = document.getElementById('mobileYearsList');
            const addYearSection = document.getElementById('mobileAddYearSection');

            if (!yearsList) return;

            const years = Object.keys(appData.years || {}).sort((a, b) => b - a);
            const isAdmin = currentUser && currentUser.role === 'admin';

            // Показываем/скрываем секцию добавления года для админов
            if (addYearSection) {
                addYearSection.style.display = isAdmin ? 'block' : 'none';
            }

            yearsList.innerHTML = years.map(year => {
                const isCurrentYear = year === appData.currentYear;
                const data = appData.years[year];
                const incomeCount = data.income ? data.income.length : 0;
                const expenseCount = data.expense ? data.expense.length : 0;
                const paymentsCount = data.payments ? data.payments.length : 0;
                const totalRecords = incomeCount + expenseCount + paymentsCount;

                return `
                    <button onclick="selectMobileYear('${year}')" 
                        class="w-full text-left p-3 border rounded-lg hover:bg-gray-50 transition-colors ${isCurrentYear ? 'bg-blue-50 border-blue-300' : 'border-gray-200'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-lg">${year} ${isCurrentYear ? '✓' : ''}</div>
                                <div class="text-sm text-gray-600">
                                    ${totalRecords} записей (П:${incomeCount}, Р:${expenseCount}, Пог:${paymentsCount})
                                </div>
                            </div>
                            ${isCurrentYear ? '<div class="text-blue-600 font-bold">Текущий</div>' : ''}
                        </div>
                    </button>
                `;
            }).join('');
        }

        function selectMobileYear(year) {
            if (year === appData.currentYear) {
                showMobileNotification(`Уже работаете с ${year} годом`, 'info');
                closeMobileYearModal();
                return;
            }

            switchYear(year);
            closeMobileYearModal();
            showMobileNotification(`Переключено на ${year} год`, 'success');
        }

        function addNewYearFromMobile() {
            const input = document.getElementById('mobileNewYearInput');
            if (!input) return;

            const year = input.value.trim();
            if (!year) {
                showMobileNotification('Введите год', 'error');
                return;
            }

            // Проверяем права доступа
            if (!currentUser || currentUser.role !== 'admin') {
                showMobileNotification('Только администраторы могут создавать новые года!', 'error');
                return;
            }

            // Валидация года
            if (!/^\d{4}$/.test(year)) {
                showMobileNotification('Введите корректный год (4 цифры)', 'error');
                return;
            }

            if (appData.years[year]) {
                showMobileNotification(`Год ${year} уже существует!`, 'error');
                return;
            }

            // Добавляем новый год
            appData.years[year] = {
                income: [],
                expense: [],
                payments: []
            };

            updateYearSelector();
            updateMobileYearsList();
            switchYear(year);
            saveData();

            input.value = '';
            closeMobileYearModal();
            showMobileNotification(`Год ${year} успешно создан и активирован!`, 'success');
        }

        function showMobileNotification(message, type = 'success') {
            const notification = document.getElementById('mobileNotification');
            const text = document.getElementById('mobileNotificationText');

            if (!notification || !text) return;

            text.textContent = message;

            // Устанавливаем цвет в зависимости от типа
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            notification.querySelector('div').className = `${colors[type] || colors.success} text-white p-3 rounded-lg shadow-lg flex items-center justify-between`;

            notification.classList.remove('hidden');

            // Автоматически скрываем через 3 секунды
            setTimeout(() => {
                hideMobileNotification();
            }, 3000);
        }

        function hideMobileNotification() {
            const notification = document.getElementById('mobileNotification');
            if (notification) {
                notification.classList.add('hidden');
            }
        }

        // Обновляем отображение текущего года в мобильной кнопке
        function updateMobileCurrentYearDisplay() {
            const display = document.getElementById('mobileCurrentYearDisplay');
            if (display) {
                display.textContent = appData.currentYear || '2025';
            }
        }

        function updateAllTables() {
            // Обновляем все таблицы с данными
            if (typeof updateIncomeTable === 'function') updateIncomeTable();
            if (typeof updateExpenseTable === 'function') updateExpenseTable();
            if (typeof updatePaymentsTable === 'function') updatePaymentsTable();
            if (typeof updateDashboard === 'function') updateDashboard();
            if (typeof updateWagonSummary === 'function') updateWagonSummary();
            if (typeof updateBalanceSummary === 'function') updateBalanceSummary();
            if (typeof updateDebtReport === 'function') updateDebtReport();
            if (typeof updateWagonTotals === 'function') updateWagonTotals();
        }

        // Функции переноса документов между годами (только для администраторов)
        function transferIncomeToYear(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Только администраторы могут переносить документы между годами!');
                return;
            }

            showTransferModal('income', id);
        }

        function transferExpenseToYear(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Только администраторы могут переносить документы между годами!');
                return;
            }

            showTransferModal('expense', id);
        }

        function transferPaymentToYear(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Только администраторы могут переносить документы между годами!');
                return;
            }

            showTransferModal('payment', id);
        }

        function showTransferModal(type, id) {
            const currentData = getCurrentYearData();
            if (!currentData) return;

            // Инициализируем массивы в текущем году если они не существуют
            if (!currentData.income) currentData.income = [];
            if (!currentData.expense) currentData.expense = [];
            if (!currentData.payments) currentData.payments = [];

            let item;
            let typeName;

            switch (type) {
                case 'income':
                    item = currentData.income?.find(i => i.id === id);
                    typeName = 'Приход';
                    break;
                case 'expense':
                    item = currentData.expense?.find(i => i.id === id);
                    typeName = 'Расход';
                    break;
                case 'payment':
                    item = currentData.payments?.find(i => i.id === id);
                    typeName = 'Погашение';
                    break;
            }

            if (!item) {
                alert('Документ не найден!');
                return;
            }

            // Получаем список доступных годов (кроме текущего)
            const availableYears = Object.keys(appData.years || {})
                .filter(year => year !== appData.currentYear)
                .sort((a, b) => b - a);

            if (availableYears.length === 0) {
                alert('Нет других годов для переноса. Создайте новый год сначала.');
                return;
            }

            // Создаем описание документа
            let description = '';
            switch (type) {
                case 'income':
                    description = `${item.product || 'Товар'} - ${item.warehouse || 'Склад'} (${item.qtyFact || 0} шт.)`;
                    break;
                case 'expense':
                    description = `${item.product || 'Товар'} - ${item.client || 'Клиент'} (${item.quantity || 0} шт., ${item.total || 0} сом.)`;
                    break;
                case 'payment':
                    description = `${item.client || 'Клиент'} - ${item.amount || 0} сом.`;
                    break;
            }

            const targetYear = prompt(
                `Перенести документ "${typeName}"?\n\n` +
                `Описание: ${description}\n` +
                `Дата: ${item.date || 'Не указана'}\n\n` +
                `Доступные года: ${availableYears.join(', ')}\n\n` +
                `Введите год для переноса:`
            );

            if (!targetYear) return;

            if (!availableYears.includes(targetYear)) {
                alert(`Год ${targetYear} не найден или недоступен для переноса!`);
                return;
            }

            // Выполняем перенос
            executeTransfer(type, id, targetYear, description);
        }

        function executeTransfer(type, id, targetYear, description) {
            const currentData = getCurrentYearData();
            const targetData = appData.years[targetYear];

            if (!currentData || !targetData) {
                alert('Ошибка: данные года не найдены!');
                return;
            }

            // Инициализируем массивы в целевом году если они не существуют
            if (!targetData.income) targetData.income = [];
            if (!targetData.expense) targetData.expense = [];
            if (!targetData.payments) targetData.payments = [];

            let item;
            let sourceArray;
            let targetArray;

            switch (type) {
                case 'income':
                    sourceArray = currentData.income;
                    targetArray = targetData.income;
                    break;
                case 'expense':
                    sourceArray = currentData.expense;
                    targetArray = targetData.expense;
                    break;
                case 'payment':
                    sourceArray = currentData.payments;
                    targetArray = targetData.payments;
                    break;
            }

            if (!sourceArray) {
                alert(`Ошибка: массив ${type} не найден в текущем году!`);
                return;
            }

            if (!targetArray) {
                alert(`Ошибка: массив ${type} не найден в целевом году!`);
                return;
            }

            // Находим и удаляем документ из текущего года
            const itemIndex = sourceArray.findIndex(i => i.id === id);
            if (itemIndex === -1) {
                alert('Документ не найден в текущем году!');
                return;
            }

            item = sourceArray[itemIndex];
            sourceArray.splice(itemIndex, 1);

            // Добавляем информацию о переносе
            item.transferredFrom = appData.currentYear;
            item.transferredAt = new Date().toISOString();
            item.transferredBy = currentUser.username;

            // Добавляем документ в целевой год
            targetArray.push(item);

            // Сохраняем данные
            saveData();

            // Обновляем интерфейс
            updateAllTables();
            updateYearManagementInterface();

            // Показываем уведомление
            const typeName = type === 'income' ? 'Приход' : type === 'expense' ? 'Расход' : 'Погашение';

            if (typeof showMobileNotification === 'function') {
                showMobileNotification(`${typeName} перенесен в ${targetYear} год`, 'success');
            } else {
                alert(`${typeName} успешно перенесен в ${targetYear} год!\n\nОписание: ${description}`);
            }

            console.log(`📋 Документ перенесен: ${typeName} из ${appData.currentYear} в ${targetYear}`);
        }

        function updateMobileUserInfo() {
            // Обновляем информацию о пользователе в мобильном меню
            const mobileCurrentUser = document.getElementById('mobile-current-user');
            const mobileCurrentRole = document.getElementById('mobile-current-role');

            if (currentUser) {
                if (mobileCurrentUser) {
                    mobileCurrentUser.textContent = currentUser.username;
                }
                if (mobileCurrentRole) {
                    mobileCurrentRole.textContent = getRoleText(currentUser.role);
                }
            }
        }

        function updateMobileMenuAccess() {
            if (!currentUser) return;

            const role = currentUser.role;
            console.log('📱 Обновление прав доступа для роли:', role);

            // Права доступа к разделам меню
            const menuItems = {
                'income': ['admin', 'warehouse'],
                'expense': ['admin', 'warehouse'],
                'payments': ['admin', 'cashier'],
                'wagon-summary': ['admin', 'warehouse', 'cashier', 'manager'],
                'balance-summary': ['admin', 'warehouse', 'cashier', 'manager'],
                'debt-report': ['admin', 'cashier', 'warehouse', 'manager'],
                'wagon-totals': ['admin', 'warehouse', 'cashier', 'manager'],
                'stock-balance': ['admin', 'cashier', 'manager'],
                'reports': ['admin', 'warehouse', 'cashier'],
                'management': ['admin', 'warehouse', 'cashier'],
                'users': ['admin'],
                'backup': ['admin', 'warehouse', 'cashier']
            };

            // Обновляем мобильное меню (из mobile-menu-complete.js)
            const mobileMenuItems = document.querySelectorAll('.mobile-menu-item');
            console.log('📱 Найдено мобильных пунктов меню:', mobileMenuItems.length);

            mobileMenuItems.forEach(item => {
                const section = item.dataset.section;
                if (section && menuItems[section]) {
                    if (menuItems[section].includes(role)) {
                        item.style.display = 'block';
                        console.log('📱 Показываем раздел:', section);
                    } else {
                        item.style.display = 'none';
                        console.log('📱 Скрываем раздел:', section);
                    }
                }
            });

            // Также обновляем обычное меню для совместимости
            Object.keys(menuItems).forEach(section => {
                const btn = document.getElementById(section.replace('-', '') + 'Btn') ||
                    document.querySelector(`[data-section="${section}"]`);
                if (btn) {
                    if (menuItems[section].includes(role)) {
                        btn.style.display = 'block';
                    } else {
                        btn.style.display = 'none';
                    }
                }
            });
        }

        // Делаем функцию доступной глобально
        window.updateMobileMenuAccess = updateMobileMenuAccess;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function () {
            loadData();
            setupYearManagement();
            initYearManagementInterface();
            showLoginScreen();
            setupEventListeners();

            // Автоматическое подключение к Firebase через 3 секунды
            setTimeout(() => {
                console.log('🚀 Запускаем автоподключение к Firebase...');
                if (window.firebaseDB && window.firebaseRefs) {
                    connectToFirebase();
                } else {
                    console.error('❌ Firebase SDK не загружен! Проверьте интернет-соединение.');
                    updateSyncStatus('offline', 'SDK не загружен');

                    // Повторная попытка через 5 секунд для мобильных
                    setTimeout(() => {
                        console.log('🔄 Повторная попытка подключения...');
                        if (window.firebaseDB && window.firebaseRefs) {
                            connectToFirebase();
                        }
                    }, 5000);
                }
            }, 3000);
        });

        function setupEventListeners() {
            // Мобильное меню
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');

            console.log('📱 Инициализация мобильного меню');
            console.log('📱 Кнопка найдена:', !!mobileMenuBtn);
            console.log('📱 Sidebar найден:', !!sidebar);

            // Создаем overlay для закрытия меню
            let overlay = document.querySelector('.mobile-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'mobile-overlay';
                document.body.appendChild(overlay);
                console.log('📱 Overlay создан');
            } else {
                console.log('📱 Overlay уже существует');
            }

            // Обработчик кнопки меню
            mobileMenuBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                console.log('📱 Клик по кнопке мобильного меню');

                const isOpen = sidebar.classList.contains('open');
                console.log('📱 Меню открыто:', isOpen);

                if (isOpen) {
                    // Закрываем меню
                    console.log('📱 Закрываем меню');
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                } else {
                    // Открываем меню
                    console.log('📱 Открываем меню');
                    sidebar.classList.add('open');
                    overlay.classList.add('show');
                }
            });

            // Закрытие меню при клике на overlay
            overlay.addEventListener('click', function () {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            });

            // Закрытие меню при нажатии Escape
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                }
            });

            // Вход в систему
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('forgotPasswordBtn').addEventListener('click', showForgotPasswordInfo);
            document.getElementById('forgotPasswordBtn').addEventListener('click', showForgotPasswordInfo);

            // Выход
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('logoutBtnMobile').addEventListener('click', logout);

            // Навигация
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function () {
                    showSection(this.dataset.section);
                    // Закрыть мобильное меню
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.querySelector('.mobile-overlay');
                    sidebar.classList.remove('open');
                    if (overlay) overlay.classList.remove('show');
                });
            });

            // Формы
            document.getElementById('incomeForm').addEventListener('submit', handleIncomeSubmit);

            // Автозаполнение текущей даты в поле даты прихода
            function setCurrentDate() {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0]; // Формат YYYY-MM-DD
                document.getElementById('incomeDate').value = dateString;
            }

            // Устанавливаем текущую дату при загрузке
            setCurrentDate();

            // Автозаполнение при фокусе на поле даты (если пустое)
            document.getElementById('incomeDate').addEventListener('focus', function () {
                if (!this.value) {
                    setCurrentDate();
                }
            });


            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);

            // Автозаполнение месяца в поле номера расхода
            document.getElementById('expenseNumber').addEventListener('focus', function () {
                if (!this.value) {
                    const currentMonth = new Date().getMonth() + 1;
                    const monthStr = currentMonth.toString().padStart(2, '0');
                    this.value = monthStr + '\\';
                    // Устанавливаем курсор после слеша
                    setTimeout(() => {
                        this.setSelectionRange(this.value.length, this.value.length);
                    }, 0);
                }
            });

            // Функция для установки текущей даты
            function setCurrentDateForForm(fieldId) {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById(fieldId).value = dateString;
            }

            // Устанавливаем текущую дату для всех форм при загрузке
            setCurrentDateForForm('expenseDate');
            setCurrentDateForForm('paymentDate');

            // Автозаполнение при фокусе на поля дат (если пустые)
            document.getElementById('expenseDate').addEventListener('focus', function () {
                if (!this.value) {
                    setCurrentDateForForm('expenseDate');
                }
            });

            document.getElementById('paymentDate').addEventListener('focus', function () {
                if (!this.value) {
                    setCurrentDateForForm('paymentDate');
                }
            });

            document.getElementById('paymentsForm').addEventListener('submit', handlePaymentsSubmit);
            document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
            document.getElementById('companyForm').addEventListener('submit', handleCompanySubmit);
            document.getElementById('warehouseForm').addEventListener('submit', handleWarehouseSubmit);
            document.getElementById('warehouseGroupForm').addEventListener('submit', handleWarehouseGroupSubmit);
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit);
            document.getElementById('coalitionForm').addEventListener('submit', handleCoalitionSubmit);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('forcePasswordChangeForm').addEventListener('submit', handleForcePasswordChange);
            document.getElementById('editUserGroupsForm').addEventListener('submit', handleEditUserGroupsSubmit);
            document.getElementById('forcePasswordLogout').addEventListener('click', forcePasswordLogout);
            document.getElementById('restoreDefaultUsersBtn').addEventListener('click', restoreDefaultUsers);
            document.getElementById('resetToDefaultBtn').addEventListener('click', resetToDefault);

            // Firebase синхронизация
            document.getElementById('connectFirebaseBtn').addEventListener('click', connectToFirebase);
            document.getElementById('syncToCloudBtn').addEventListener('click', syncToCloud);
            document.getElementById('syncFromCloudBtn').addEventListener('click', syncFromCloud);
            document.getElementById('refreshInterfaceBtn').addEventListener('click', () => {
                updateAllTables();
                showSuccessMessage('Интерфейс обновлен!');
            });
            document.getElementById('mobileConnectBtn').addEventListener('click', () => {
                console.log('📱 Мобильное подключение к Firebase...');
                connectToFirebase();
            });
            document.getElementById('mobileOfflineBtn').addEventListener('click', () => {
                enableOfflineMode();
            });

            // Автоматические расчёты
            document.getElementById('incomeQtyDoc').addEventListener('input', calculateIncomeDifference);
            document.getElementById('incomeQtyFact').addEventListener('input', calculateIncomeDifference);
            document.getElementById('expenseQuantity').addEventListener('input', calculateExpenseTotals);
            document.getElementById('expensePrice').addEventListener('input', calculateExpenseTotals);
            document.getElementById('paymentSomoni').addEventListener('input', calculatePaymentAmount);
            document.getElementById('paymentRate').addEventListener('input', calculatePaymentAmount);

            // Валидация полей с datalist в форме прихода
            document.getElementById('incomeCompany').addEventListener('input', validateIncomeCompany);
            document.getElementById('incomeCompany').addEventListener('blur', validateIncomeCompany);
            document.getElementById('incomeWarehouse').addEventListener('input', validateIncomeWarehouse);
            document.getElementById('incomeWarehouse').addEventListener('blur', validateIncomeWarehouse);
            document.getElementById('incomeProduct').addEventListener('input', validateIncomeProduct);
            document.getElementById('incomeProduct').addEventListener('blur', validateIncomeProduct);

            // Валидация полей с datalist в форме расхода
            document.getElementById('expenseCompany').addEventListener('input', validateExpenseCompany);
            document.getElementById('expenseCompany').addEventListener('blur', validateExpenseCompany);
            document.getElementById('expenseWarehouse').addEventListener('input', validateExpenseWarehouse);
            document.getElementById('expenseWarehouse').addEventListener('blur', validateExpenseWarehouse);
            document.getElementById('expenseProduct').addEventListener('input', validateExpenseProduct);
            document.getElementById('expenseProduct').addEventListener('blur', validateExpenseProduct);
            document.getElementById('expenseClient').addEventListener('input', validateExpenseClient);
            document.getElementById('expenseClient').addEventListener('blur', validateExpenseClient);

            // Валидация полей с datalist в форме погашений
            document.getElementById('paymentClient').addEventListener('input', validatePaymentClient);
            document.getElementById('paymentClient').addEventListener('blur', validatePaymentClient);

            // Отчёты
            document.querySelectorAll('.report-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    showReportFilters(this.dataset.report);
                });
            });
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('exportToExcel').addEventListener('click', exportReportToExcel);

            // Резервное копирование
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('exportExcelBtn').addEventListener('click', exportAllToExcel);
            document.getElementById('importBtn').addEventListener('click', importData);
            document.getElementById('clearOperationsBtn').addEventListener('click', () => clearDatabase('operations'));
            document.getElementById('clearCatalogsBtn').addEventListener('click', () => clearDatabase('catalogs'));
            document.getElementById('clearAllBtn').addEventListener('click', () => clearDatabase('all'));

            // Модальное окно результатов импорта
            document.getElementById('closeImportResultModal').addEventListener('click', closeImportResultModal);
            document.getElementById('closeImportResult').addEventListener('click', closeImportResultModal);

            // Экспорт отдельных разделов в Excel
            document.getElementById('exportIncomeExcel').addEventListener('click', () => exportSectionToExcel('income'));
            document.getElementById('exportExpenseExcel').addEventListener('click', () => exportSectionToExcel('expense'));
            document.getElementById('exportPaymentsExcel').addEventListener('click', () => exportSectionToExcel('payments'));
            document.getElementById('exportDebtExcel').addEventListener('click', () => exportSectionToExcel('debt'));
            document.getElementById('exportWagonSummaryExcel').addEventListener('click', () => exportSectionToExcel('wagonSummary'));
            document.getElementById('exportBalanceSummaryExcel').addEventListener('click', () => exportSectionToExcel('balanceSummary'));
            document.getElementById('exportWagonTotalsExcel').addEventListener('click', () => exportSectionToExcel('wagonTotals'));
            document.getElementById('exportManagementExcel').addEventListener('click', () => exportSectionToExcel('management'));

            // Накладная
            document.getElementById('createInvoiceBtn').addEventListener('click', openInvoiceModal);
            document.getElementById('addTestDataBtn').addEventListener('click', addTestExpenseData);
            document.getElementById('closeInvoiceModal').addEventListener('click', closeInvoiceModal);
            document.getElementById('cancelInvoice').addEventListener('click', closeInvoiceModal);
            document.getElementById('printInvoice').addEventListener('click', generateInvoice);
            document.getElementById('closePrintModal').addEventListener('click', closePrintModal);
            document.getElementById('printInvoiceBtn').addEventListener('click', printInvoice);
            document.getElementById('exportInvoiceExcel').addEventListener('click', exportInvoiceToExcel);
            document.getElementById('selectAllExpense').addEventListener('change', toggleSelectAllExpense);
            document.getElementById('invoiceClient').addEventListener('change', filterExpensesByClient);

            // Кассовый ордер
            document.getElementById('createCashOrderBtn').addEventListener('click', openCashOrderModal);
            document.getElementById('closeCashOrderModal').addEventListener('click', closeCashOrderModal);
            document.getElementById('cancelCashOrder').addEventListener('click', closeCashOrderModal);
            document.getElementById('printCashOrder').addEventListener('click', generateCashOrder);
            document.getElementById('closePrintCashOrderModal').addEventListener('click', closePrintCashOrderModal);
            document.getElementById('printCashOrderBtn').addEventListener('click', printCashOrder);
            document.getElementById('exportCashOrderExcel').addEventListener('click', exportCashOrderToExcel);
            document.getElementById('selectAllPayments').addEventListener('change', toggleSelectAllPayments);
            document.getElementById('cashOrderClient').addEventListener('change', filterPaymentsByClient);

            // Фильтры
            document.getElementById('wagonSummaryWarehouse').addEventListener('change', updateWagonSummary);
            document.getElementById('balanceSummaryWarehouse').addEventListener('change', updateBalanceSummary);

            // Устанавливаем текущую дату по умолчанию для всех форм
            setDefaultDates();
        }

        function setDefaultDates() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];

            // Устанавливаем даты для всех форм
            const dateFields = ['incomeDate', 'expenseDate', 'paymentDate'];
            dateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value) {
                    field.value = dateString;
                }
            });
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            const mainInterface = document.getElementById('mainInterface');
            if (mainInterface) {
                mainInterface.style.display = 'none';
            }
        }

        function showForgotPasswordInfo() {
            showWarningMessage('Для восстановления пароля обратитесь к администратору системы. Пользователи по умолчанию: admin/admin, tillo/123456, abdullo/123456, firdavs/123456');
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = appData.users.find(u => u.username === username && u.password === password);

            if (user) {
                // Проверяем, заблокирован ли пользователь
                if (user.blocked) {
                    showErrorMessage('Ваш аккаунт заблокирован. Обратитесь к администратору.');
                    return;
                }

                currentUser = user;

                // Проверяем, требуется ли смена пароля
                if (user.requiresPasswordChange) {
                    showForcePasswordChangeModal();
                    return;
                }

                // Автосохранение при входе
                saveData();

                document.getElementById('loginScreen').classList.add('hidden');
                const mainInterface = document.getElementById('mainInterface');
                if (mainInterface) {
                    mainInterface.style.display = 'flex';
                }
                document.getElementById('currentUser').textContent = user.username;
                document.getElementById('currentRole').textContent = getRoleText(user.role);

                setupUserInterface();
                updateYearSelector(); // Обновляем селектор года после входа
                updateAllTables(); // Обновляем все таблицы с синхронизированными данными
                showSection('dashboard');
                updateDashboard();
            } else {
                showErrorMessage('Неверный логин или пароль');
            }
        }

        function logout() {
            // Автосохранение при выходе
            saveData();

            currentUser = null;
            showLoginScreen();
            document.getElementById('loginForm').reset();
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'Администратор',
                'warehouse': 'Завсклада',
                'cashier': 'Кассир',
                'manager': 'Руководитель'
            };
            return roles[role] || role;
        }

        function setupUserInterface() {
            const role = currentUser.role;

            // Скрыть/показать элементы меню в зависимости от роли
            const menuItems = {
                'income': ['admin', 'warehouse'],
                'expense': ['admin', 'warehouse'],
                'payments': ['admin', 'cashier'],
                'wagon-summary': ['admin', 'warehouse', 'cashier', 'manager'],
                'balance-summary': ['admin', 'warehouse', 'cashier', 'manager'],
                'debt-report': ['admin', 'cashier', 'warehouse', 'manager'],
                'wagon-totals': ['admin', 'warehouse', 'cashier', 'manager'],
                'stock-balance': ['admin', 'cashier', 'manager'],
                'reports': ['admin', 'warehouse', 'cashier'],
                'management': ['admin', 'warehouse', 'cashier'],
                'users': ['admin'],
                'backup': ['admin', 'warehouse', 'cashier']
            };

            Object.keys(menuItems).forEach(section => {
                const btn = document.getElementById(section.replace('-', '') + 'Btn') ||
                    document.querySelector(`[data-section="${section}"]`);
                if (btn) {
                    if (menuItems[section].includes(role)) {
                        btn.style.display = 'block';
                    } else {
                        btn.style.display = 'none';
                    }
                }
            });

            // Обновить выпадающие списки
            updateDropdowns();

            // Обновить список пользователей для смены пароля
            updatePasswordChangeUserList();

            // Настроить права доступа к управлению годами
            setupYearPermissions();

            // Обновить мобильное меню
            updateMobileUserInfo();
            updateMobileMenuAccess();
        }

        function showSection(sectionId) {
            // Проверяем права доступа для роли "manager"
            if (currentUser && currentUser.role === 'manager') {
                const allowedSections = ['wagon-summary', 'balance-summary', 'debt-report', 'wagon-totals', 'stock-balance'];
                if (!allowedSections.includes(sectionId)) {
                    alert('У вас нет доступа к этому разделу. Доступны только отчеты и сводки.');
                    return;
                }
            }

            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('hidden');

                // Обновить данные для конкретных секций
                switch (sectionId) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'income':
                        updateIncomeTable();
                        break;
                    case 'expense':
                        updateExpenseTable();
                        break;
                    case 'payments':
                        updatePaymentsTable();
                        break;
                    case 'wagon-summary':
                        updateWagonSummary();
                        break;
                    case 'balance-summary':
                        updateBalanceSummary();
                        break;
                    case 'stock-balance':
                        initializeStockBalance();
                        break;
                    case 'debt-report':
                        updateDebtReport();
                        break;
                    case 'wagon-totals':
                        updateWagonTotals();
                        break;
                    case 'management':
                        updateManagementLists();
                        break;
                    case 'users':
                        updateUsersTable();
                        setupPasswordChangeInterface();
                        break;

                }
            }
        }

        function updateDropdowns() {
            // Обновить все выпадающие списки
            updateProductDropdowns();
            updateCompanyDropdowns();
            updateWarehouseDropdowns();
            updateClientDropdowns();
            updateCoalitionDropdowns();
            updateWarehouseGroupDropdowns();
            updateReportClientDropdown();

            // Обновляем селектор года в разделе остатков складов
            if (typeof updateStockBalanceYearSelector === 'function') {
                updateStockBalanceYearSelector();
            }
        }

        function updateProductDropdowns() {
            // Обновляем datalist для прихода товаров
            const incomeProductList = document.getElementById('incomeProductList');
            if (incomeProductList) {
                incomeProductList.innerHTML = '';
                appData.products.forEach(product => {
                    incomeProductList.innerHTML += `<option value="${product}">`;
                });
            }

            // Обновляем datalist для расхода товаров
            const expenseProductList = document.getElementById('expenseProductList');
            if (expenseProductList) {
                expenseProductList.innerHTML = '';
                appData.products.forEach(product => {
                    expenseProductList.innerHTML += `<option value="${product}">`;
                });
            }
        }

        // Функции для работы с годами
        function initializeYears() {
            const currentYear = new Date().getFullYear().toString();

            // Проверяем, что структура годов существует
            if (!appData.years) {
                console.log('Инициализируем структуру годов');
                appData.years = {};
            }

            // Если текущего года нет в данных, добавляем его
            if (!appData.years[currentYear]) {
                console.log('Добавляем текущий год:', currentYear);
                appData.years[currentYear] = {
                    income: [],
                    expense: [],
                    payments: []
                };
            }

            // Устанавливаем текущий год
            appData.currentYear = currentYear;

            console.log('Годы после инициализации:', Object.keys(appData.years));

            // Обновляем селектор года после небольшой задержки, чтобы DOM успел загрузиться
            setTimeout(updateYearSelector, 100);
        }

        function updateYearSelector() {
            console.log('updateYearSelector вызвана');
            const selector = document.getElementById('yearSelector');
            const currentYearDisplay = document.getElementById('currentYearDisplay');

            console.log('Селектор найден:', !!selector);
            console.log('Доступные годы:', Object.keys(appData.years));

            if (selector) {
                // Очищаем селектор
                selector.innerHTML = '';

                // Сортируем годы по убыванию (новые сверху)
                const sortedYears = Object.keys(appData.years).sort((a, b) => b - a);
                console.log('Отсортированные годы:', sortedYears);

                // Добавляем опции
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === appData.currentYear) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                    console.log('Добавлена опция:', year);
                });

                console.log('Селектор обновлен, количество опций:', selector.options.length);
            } else {
                console.error('Селектор yearSelector не найден!');
            }

            if (currentYearDisplay) {
                currentYearDisplay.textContent = appData.currentYear;
                console.log('Обновлен текущий год:', appData.currentYear);
            } else {
                console.error('Элемент currentYearDisplay не найден!');
            }
        }

        // Дублированная функция switchYear удалена - используется основная выше



        // Функция для получения данных текущего года
        function getCurrentYearData() {
            console.log('📅 getCurrentYearData вызвана');
            console.log('📅 appData.currentYear:', appData.currentYear);
            console.log('📅 Доступные годы:', Object.keys(appData.years || {}));
            console.log('📅 appData.years:', appData.years);

            if (!appData.years) {
                console.log('Создаем appData.years');
                appData.years = {};
            }
            if (!appData.years[appData.currentYear]) {
                console.log('Создаем данные для года:', appData.currentYear);
                appData.years[appData.currentYear] = {
                    income: [],
                    expense: [],
                    payments: []
                };
            }

            const yearData = appData.years[appData.currentYear];
            console.log('📅 Возвращаем данные для года', appData.currentYear, ':', {
                income: yearData.income?.length || 0,
                expense: yearData.expense?.length || 0,
                payments: yearData.payments?.length || 0
            });
            return yearData;
        }

        // Совместимость со старым кодом - создаем геттеры для appData
        Object.defineProperty(appData, 'income', {
            get: function () { return getCurrentYearData().income; },
            set: function (value) { getCurrentYearData().income = value; }
        });

        Object.defineProperty(appData, 'expense', {
            get: function () { return getCurrentYearData().expense; },
            set: function (value) { getCurrentYearData().expense = value; }
        });

        Object.defineProperty(appData, 'payments', {
            get: function () { return getCurrentYearData().payments; },
            set: function (value) { getCurrentYearData().payments = value; }
        });

        function updateCompanyDropdowns() {
            // Обновляем datalist для прихода товаров
            const incomeCompanyList = document.getElementById('incomeCompanyList');
            if (incomeCompanyList) {
                incomeCompanyList.innerHTML = '';
                appData.companies.forEach(company => {
                    incomeCompanyList.innerHTML += `<option value="${company}">`;
                });
            }

            // Обновляем datalist для расхода товаров
            const expenseCompanyList = document.getElementById('expenseCompanyList');
            if (expenseCompanyList) {
                expenseCompanyList.innerHTML = '';
                appData.companies.forEach(company => {
                    expenseCompanyList.innerHTML += `<option value="${company}">`;
                });
            }
        }

        function updateWarehouseDropdowns() {
            // Обновляем datalist для прихода товаров
            const incomeWarehouseList = document.getElementById('incomeWarehouseList');
            if (incomeWarehouseList) {
                incomeWarehouseList.innerHTML = '';

                let warehouses = appData.warehouses;
                // Фильтрация складов по подгруппе для завсклада
                if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                    warehouses = filterWarehousesByUserGroups(warehouses);
                }

                warehouses.forEach(warehouse => {
                    incomeWarehouseList.innerHTML += `<option value="${warehouse.name}">`;
                });
            }

            // Обновляем datalist для расхода товаров
            const expenseWarehouseList = document.getElementById('expenseWarehouseList');
            if (expenseWarehouseList) {
                expenseWarehouseList.innerHTML = '';

                let warehouses = appData.warehouses;
                // Фильтрация складов по подгруппе для завсклада
                if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                    warehouses = filterWarehousesByUserGroups(warehouses);
                }

                warehouses.forEach(warehouse => {
                    expenseWarehouseList.innerHTML += `<option value="${warehouse.name}">`;
                });
            }

            // Обновляем остальные обычные select
            const selects = ['wagonSummaryWarehouse', 'balanceSummaryWarehouse', 'reportWarehouse'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select && select.tagName === 'SELECT') {
                    const isFilter = selectId.includes('Summary') || selectId.includes('report');
                    select.innerHTML = isFilter ? '<option value="">Все склады</option>' : '<option value="">Выберите склад</option>';

                    let warehouses = appData.warehouses;

                    // Фильтрация складов по подгруппе для завсклада
                    if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                        warehouses = filterWarehousesByUserGroups(warehouses);
                    }

                    warehouses.forEach(warehouse => {
                        select.innerHTML += `<option value="${warehouse.name}">${warehouse.name}</option>`;
                    });
                }
            });
        }

        function updateReportClientDropdown() {
            const select = document.getElementById('reportClient');
            if (select) {
                select.innerHTML = '<option value="">Все клиенты</option>';
                appData.clients.forEach(client => {
                    const clientName = typeof client === 'string' ? client : client.name;
                    const clientPhone = typeof client === 'string' ? '' : (client.phone || '');
                    const displayText = clientPhone ? `${clientName} (${clientPhone})` : clientName;
                    select.innerHTML += `<option value="${clientName}">${displayText}</option>`;
                });
            }
        }

        function updateClientDropdowns() {
            // Обновляем datalist для расхода товаров
            const expenseClientList = document.getElementById('expenseClientList');
            if (expenseClientList) {
                expenseClientList.innerHTML = '';
                appData.clients.forEach(client => {
                    const clientName = typeof client === 'string' ? client : client.name;
                    expenseClientList.innerHTML += `<option value="${clientName}">`;
                });
            }

            // Обновляем datalist для погашений
            const paymentClientList = document.getElementById('paymentClientList');
            if (paymentClientList) {
                paymentClientList.innerHTML = '';
                appData.clients.forEach(client => {
                    const clientName = typeof client === 'string' ? client : client.name;
                    paymentClientList.innerHTML += `<option value="${clientName}">`;
                });
            }
        }

        function updateCoalitionDropdowns() {
            const selects = ['expenseCoalition'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select && appData.coalitions) {
                    select.innerHTML = '<option value="">Выберите коалицу</option>';
                    appData.coalitions.forEach(coalition => {
                        select.innerHTML += `<option value="${coalition}">${coalition}</option>`;
                    });
                }
            });
        }

        function updateWarehouseGroupDropdowns() {
            // Обновляем селектор для создания складов
            const warehouseGroupSelect = document.getElementById('warehouseGroup');
            if (warehouseGroupSelect) {
                warehouseGroupSelect.innerHTML = '<option value="">Выберите подгруппу</option>';
                appData.warehouseGroups.forEach(group => {
                    warehouseGroupSelect.innerHTML += `<option value="${group}">${group}</option>`;
                });
            }
            
            // Обновляем мультиселектор для пользователей
            const userWarehouseGroupSelect = document.getElementById('userWarehouseGroup');
            if (userWarehouseGroupSelect) {
                userWarehouseGroupSelect.innerHTML = '';
                appData.warehouseGroups.forEach(group => {
                    userWarehouseGroupSelect.innerHTML += `<option value="${group}">${group}</option>`;
                });
            }
        }

        // Вспомогательная функция для фильтрации складов по группам пользователя
        function filterWarehousesByUserGroups(warehouses) {
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userGroups = Array.isArray(currentUser.warehouseGroup) ? 
                    currentUser.warehouseGroup.filter(g => g !== '') : 
                    [currentUser.warehouseGroup].filter(g => g !== '');
                
                if (userGroups.length > 0) {
                    return warehouses.filter(w => userGroups.includes(w.group));
                }
            }
            return warehouses;
        }

        // Вспомогательная функция для получения названий складов пользователя
        function getUserWarehouseNames() {
            console.log('🏪 getUserWarehouseNames вызвана для пользователя:', currentUser?.username);
            console.log('🏪 Роль пользователя:', currentUser?.role);
            console.log('🏪 Группы пользователя:', currentUser?.warehouseGroup);
            
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userGroups = Array.isArray(currentUser.warehouseGroup) ? 
                    currentUser.warehouseGroup.filter(g => g !== '') : 
                    [currentUser.warehouseGroup].filter(g => g !== '');
                
                console.log('🏪 Обработанные группы:', userGroups);
                console.log('🏪 Все склады:', appData.warehouses);
                
                if (userGroups.length > 0) {
                    const userWarehouses = appData.warehouses
                        .filter(w => userGroups.includes(w.group))
                        .map(w => w.name);
                    console.log('🏪 Склады пользователя:', userWarehouses);
                    return userWarehouses;
                }
            }
            
            const allWarehouses = appData.warehouses.map(w => w.name);
            console.log('🏪 Возвращаем все склады:', allWarehouses);
            return allWarehouses;
        }

        function calculateIncomeDifference() {
            const qtyDoc = parseFloat(document.getElementById('incomeQtyDoc').value) || 0;
            const qtyFact = parseFloat(document.getElementById('incomeQtyFact').value) || 0;
            const difference = qtyFact - qtyDoc;
            const weightTons = qtyFact / 20;

            document.getElementById('incomeDifference').value = difference;
            document.getElementById('incomeWeightTons').value = weightTons.toFixed(2);
        }

        function calculateExpenseTotals() {
            const quantity = parseFloat(document.getElementById('expenseQuantity').value) || 0;
            const price = parseFloat(document.getElementById('expensePrice').value) || 0;
            const tons = quantity / 20;
            const total = tons * price;

            document.getElementById('expenseTons').value = tons.toFixed(2);
            document.getElementById('expenseTotal').value = total.toFixed(2);
        }

        function calculatePaymentAmount() {
            const somoni = parseFloat(document.getElementById('paymentSomoni').value) || 0;
            const rate = parseFloat(document.getElementById('paymentRate').value) || 0;
            const amount = rate > 0 ? somoni / rate : 0;

            document.getElementById('paymentAmount').value = amount.toFixed(2);
        }

        // Функции валидации для полей с datalist
        function validateIncomeCompany() {
            const input = document.getElementById('incomeCompany');
            const errorDiv = document.getElementById('incomeCompanyError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }

            const isValid = appData.companies.includes(value);

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                errorDiv.classList.remove('hidden');
                input.classList.add('border-red-500');
                input.classList.remove('border-green-500');
            }

            return isValid;
        }

        function validateIncomeWarehouse() {
            const input = document.getElementById('incomeWarehouse');
            const errorDiv = document.getElementById('incomeWarehouseError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }

            let warehouses = appData.warehouses;
            // Фильтрация складов по подгруппе для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                warehouses = filterWarehousesByUserGroups(warehouses);
            }

            const isValid = warehouses.some(w => w.name === value);

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                errorDiv.classList.remove('hidden');
                input.classList.add('border-red-500');
                input.classList.remove('border-green-500');
            }

            return isValid;
        }

        function validateIncomeProduct() {
            const input = document.getElementById('incomeProduct');
            const errorDiv = document.getElementById('incomeProductError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return true;
            }

            const isValid = appData.products.includes(value);

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                errorDiv.classList.remove('hidden');
                input.classList.add('border-red-500');
                input.classList.remove('border-green-500');
            }

            return isValid;
        }

        // Функция для очистки стилей валидации
        function clearIncomeValidationStyles() {
            const fields = ['incomeCompany', 'incomeWarehouse', 'incomeProduct'];
            const errors = ['incomeCompanyError', 'incomeWarehouseError', 'incomeProductError'];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('border-red-500', 'border-green-500');
                }
            });

            errors.forEach(errorId => {
                const error = document.getElementById(errorId);
                if (error) {
                    error.classList.add('hidden');
                }
            });
        }

        // Функции валидации для полей расхода
        function validateExpenseCompany() {
            const input = document.getElementById('expenseCompany');
            const errorDiv = document.getElementById('expenseCompanyError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return false; // Поле обязательно для заполнения
            }

            const isValid = appData.companies.includes(value);

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                // Автоматически добавляем новую фирму в список
                appData.companies.push(value);
                updateCompanyDropdowns();
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            }

            return true;
        }

        function validateExpenseWarehouse() {
            const input = document.getElementById('expenseWarehouse');
            const errorDiv = document.getElementById('expenseWarehouseError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return false; // Поле обязательно для заполнения
            }

            let warehouses = appData.warehouses;
            // Фильтрация складов по подгруппе для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                warehouses = filterWarehousesByUserGroups(warehouses);
            }

            const isValid = warehouses.some(w => w.name === value);

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                // Для завсклада - проверяем, что склад принадлежит его группе
                if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                    errorDiv.textContent = 'Склад должен принадлежать вашей группе!';
                    errorDiv.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    input.classList.remove('border-green-500');
                    return false;
                } else {
                    // Для админа - автоматически добавляем новый склад
                    const defaultGroup = appData.warehouseGroups[0] || 'Основная';
                    appData.warehouses.push({ name: value, group: defaultGroup });
                    updateWarehouseDropdowns();
                    errorDiv.classList.add('hidden');
                    input.classList.remove('border-red-500');
                    input.classList.add('border-green-500');
                }
            }

            return true;
        }

        function validateExpenseProduct() {
            const input = document.getElementById('expenseProduct');
            const errorDiv = document.getElementById('expenseProductError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return false; // Поле обязательно для заполнения
            }

            const isValid = appData.products.includes(value);

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                // Автоматически добавляем новый товар в список
                appData.products.push(value);
                updateProductDropdowns();
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            }

            return true;
        }

        function validateExpenseClient() {
            const input = document.getElementById('expenseClient');
            const errorDiv = document.getElementById('expenseClientError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return false; // Поле обязательно для заполнения
            }

            const isValid = appData.clients.some(client => {
                const clientName = typeof client === 'string' ? client : client.name;
                return clientName === value;
            });

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                // Автоматически добавляем нового клиента в список
                appData.clients.push(value);
                updateClientDropdowns();
                updateReportClientDropdown();
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            }

            return true;
        }

        // Функция для очистки стилей валидации расхода
        function clearExpenseValidationStyles() {
            const fields = ['expenseCompany', 'expenseWarehouse', 'expenseProduct', 'expenseClient'];
            const errors = ['expenseCompanyError', 'expenseWarehouseError', 'expenseProductError', 'expenseClientError'];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('border-red-500', 'border-green-500');
                }
            });

            errors.forEach(errorId => {
                const error = document.getElementById(errorId);
                if (error) {
                    error.classList.add('hidden');
                }
            });
        }

        // Функция валидации для клиента в погашениях
        function validatePaymentClient() {
            const input = document.getElementById('paymentClient');
            const errorDiv = document.getElementById('paymentClientError');
            const value = input.value.trim();

            if (value === '') {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                return false; // Поле обязательно для заполнения
            }

            const isValid = appData.clients.some(client => {
                const clientName = typeof client === 'string' ? client : client.name;
                return clientName === value;
            });

            if (isValid) {
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            } else {
                // Автоматически добавляем нового клиента в список
                appData.clients.push(value);
                updateClientDropdowns();
                updateReportClientDropdown();
                errorDiv.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
            }

            return true;
        }

        // Функция для очистки стилей валидации погашений
        function clearPaymentValidationStyles() {
            const fields = ['paymentClient'];
            const errors = ['paymentClientError'];

            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.classList.remove('border-red-500', 'border-green-500');
                }
            });

            errors.forEach(errorId => {
                const error = document.getElementById(errorId);
                if (error) {
                    error.classList.add('hidden');
                }
            });
        }

        function handleIncomeSubmit(e) {
            e.preventDefault();

            try {
                // Проверяем валидацию всех полей с datalist
                const isCompanyValid = validateIncomeCompany();
                const isWarehouseValid = validateIncomeWarehouse();
                const isProductValid = validateIncomeProduct();

                if (!isCompanyValid || !isWarehouseValid || !isProductValid) {
                    showErrorMessage('Пожалуйста, исправьте ошибки в форме перед отправкой!');
                    return;
                }

                // Дополнительная валидация обязательных полей
                const requiredFields = [
                    { id: 'incomeDate', name: 'Дата' },
                    { id: 'incomeWagon', name: 'Номер вагона' },
                    { id: 'incomeQtyDoc', name: 'Количество по документу' },
                    { id: 'incomeQtyFact', name: 'Фактическое количество' }
                ];

                const missingFields = [];
                for (const field of requiredFields) {
                    const value = document.getElementById(field.id).value.trim();
                    if (!value) {
                        missingFields.push(field.name);
                    }
                }

                if (missingFields.length > 0) {
                    showErrorMessage(`Заполните обязательные поля: ${missingFields.join(', ')}`);
                    return;
                }

                // Валидация числовых значений
                const qtyDoc = parseFloat(document.getElementById('incomeQtyDoc').value);
                const qtyFact = parseFloat(document.getElementById('incomeQtyFact').value);

                if (isNaN(qtyDoc) || qtyDoc < 0) {
                    showErrorMessage('Количество по документу должно быть положительным числом');
                    return;
                }

                if (isNaN(qtyFact) || qtyFact < 0) {
                    showErrorMessage('Фактическое количество должно быть положительным числом');
                    return;
                }

                const incomeData = {
                    id: Date.now(),
                    date: document.getElementById('incomeDate').value,
                    wagon: document.getElementById('incomeWagon').value.trim(),
                    company: document.getElementById('incomeCompany').value.trim(),
                    warehouse: document.getElementById('incomeWarehouse').value.trim(),
                    product: document.getElementById('incomeProduct').value.trim(),
                    qtyDoc: qtyDoc,
                    qtyFact: qtyFact,
                    difference: qtyFact - qtyDoc,
                    weightTons: parseFloat((qtyFact / 20).toFixed(2)),
                    notes: document.getElementById('incomeNotes').value,
                    user: currentUser.username,
                    editedBy: null
                };

                getCurrentYearData().income.push(incomeData);
                saveData();
                updateIncomeTable();
                document.getElementById('incomeForm').reset();

                // Очищаем стили валидации после сброса формы
                clearIncomeValidationStyles();

                // Восстанавливаем текущую дату после сброса формы
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('incomeDate').value = dateString;

                showSuccessMessage('Приход товара успешно добавлен');

            } catch (error) {
                console.error('Ошибка при добавлении прихода:', error);
                showErrorMessage('Произошла ошибка при добавлении прихода: ' + error.message);
            }
        }

        function handleExpenseSubmit(e) {
            e.preventDefault();

            try {
                // Принудительная инициализация на случай проблем
                if (!appData.years) {
                    appData.years = {};
                }
                if (!appData.currentYear) {
                    appData.currentYear = new Date().getFullYear().toString();
                }
                if (!appData.years[appData.currentYear]) {
                    appData.years[appData.currentYear] = {
                        income: [],
                        expense: [],
                        payments: []
                    };
                }

                // Проверяем валидацию всех полей с datalist
                const isCompanyValid = validateExpenseCompany();
                const isWarehouseValid = validateExpenseWarehouse();
                const isProductValid = validateExpenseProduct();
                const isClientValid = validateExpenseClient();

                if (!isCompanyValid || !isWarehouseValid || !isProductValid || !isClientValid) {
                    showErrorMessage('Пожалуйста, исправьте ошибки в форме перед отправкой!');
                    return;
                }

                // Проверяем заполнение обязательных полей
                const requiredFields = [
                    { id: 'expenseDate', name: 'Дата' },
                    { id: 'expenseQuantity', name: 'Количество' },
                    { id: 'expensePrice', name: 'Цена' }
                ];

                const missingFields = [];
                for (const field of requiredFields) {
                    const value = document.getElementById(field.id).value.trim();
                    if (!value) {
                        missingFields.push(field.name);
                    }
                }

                if (missingFields.length > 0) {
                    showErrorMessage(`Заполните обязательные поля: ${missingFields.join(', ')}`);
                    return;
                }

                // Валидация числовых значений
                const quantity = parseFloat(document.getElementById('expenseQuantity').value);
                const price = parseFloat(document.getElementById('expensePrice').value);

                if (isNaN(quantity) || quantity <= 0) {
                    showErrorMessage('Количество должно быть положительным числом');
                    return;
                }

                if (isNaN(price) || price <= 0) {
                    showErrorMessage('Цена должна быть положительным числом');
                    return;
                }

                // Валидация номера (если заполнен)
                const expenseNumber = document.getElementById('expenseNumber').value.trim();
                if (expenseNumber && !/^[0-9]{2}\\[0-9]+$/.test(expenseNumber)) {
                    showErrorMessage('Номер должен быть в формате ММ\\NNNN (например, 01\\0001)');
                    return;
                }

                const expenseData = {
                    id: Date.now(),
                    date: document.getElementById('expenseDate').value,
                    coalition: document.getElementById('expenseCoalition').value || '',
                    number: expenseNumber,
                    company: document.getElementById('expenseCompany').value.trim(),
                    warehouse: document.getElementById('expenseWarehouse').value.trim(),
                    product: document.getElementById('expenseProduct').value.trim(),
                    client: document.getElementById('expenseClient').value.trim(),
                    quantity: quantity,
                    tons: parseFloat((quantity / 20).toFixed(2)),
                    price: price,
                    total: parseFloat(((quantity / 20) * price).toFixed(2)),
                    notes: document.getElementById('expenseNotes').value.trim(),
                    user: currentUser.username,
                    editedBy: null
                };

                const yearData = getCurrentYearData();
                if (!yearData.expense) {
                    yearData.expense = [];
                }

                yearData.expense.push(expenseData);
                saveData();
                updateExpenseTable();
                document.getElementById('expenseForm').reset();

                // Очищаем стили валидации после сброса формы
                clearExpenseValidationStyles();

                // Восстанавливаем текущую дату после сброса формы
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('expenseDate').value = dateString;

                showSuccessMessage('Расход товара успешно добавлен');

            } catch (error) {
                console.error('Ошибка при добавлении расхода:', error);
                showErrorMessage('Произошла ошибка при добавлении расхода: ' + error.message);
            }

            // Восстанавливаем текущую дату после сброса формы
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('expenseDate').value = dateString;

            console.log('Расход успешно добавлен');
            // Уведомление уже показывается в try-catch блоке
        }

        function handlePaymentsSubmit(e) {
            e.preventDefault();

            try {
                // Принудительная инициализация на случай проблем
                if (!appData.years) {
                    appData.years = {};
                }
                if (!appData.currentYear) {
                    appData.currentYear = new Date().getFullYear().toString();
                }
                if (!appData.years[appData.currentYear]) {
                    appData.years[appData.currentYear] = {
                        income: [],
                        expense: [],
                        payments: []
                    };
                }

                // Проверяем валидацию клиента
                const isClientValid = validatePaymentClient();
                if (!isClientValid) {
                    showErrorMessage('Пожалуйста, исправьте ошибки в форме перед отправкой!');
                    return;
                }

                // Проверяем заполнение обязательных полей
                const requiredFields = [
                    { id: 'paymentDate', name: 'Дата' },
                    { id: 'paymentSomoni', name: 'Сомони' },
                    { id: 'paymentRate', name: 'Курс' }
                ];

                const missingFields = [];
                for (const field of requiredFields) {
                    const value = document.getElementById(field.id).value.trim();
                    if (!value) {
                        missingFields.push(field.name);
                    }
                }

                if (missingFields.length > 0) {
                    showErrorMessage(`Заполните обязательные поля: ${missingFields.join(', ')}`);
                    return;
                }

                // Валидация числовых значений
                const somoni = parseFloat(document.getElementById('paymentSomoni').value);
                const rate = parseFloat(document.getElementById('paymentRate').value);

                if (isNaN(somoni) || somoni <= 0) {
                    showErrorMessage('Сумма в сомони должна быть положительным числом');
                    return;
                }

                if (isNaN(rate) || rate <= 0) {
                    showErrorMessage('Курс должен быть положительным числом');
                    return;
                }

                const paymentData = {
                    id: Date.now(),
                    date: document.getElementById('paymentDate').value,
                    client: document.getElementById('paymentClient').value.trim(),
                    somoni: somoni,
                    rate: rate,
                    amount: parseFloat((somoni / rate).toFixed(2)),
                    notes: document.getElementById('paymentNotes').value.trim(),
                    user: currentUser.username,
                    editedBy: null
                };

                const yearData = getCurrentYearData();
                if (!yearData.payments) {
                    yearData.payments = [];
                }

                yearData.payments.push(paymentData);
                saveData();
                updatePaymentsTable();
                document.getElementById('paymentsForm').reset();

                // Очищаем стили валидации после сброса формы
                clearPaymentValidationStyles();

                // Восстанавливаем текущую дату после сброса формы
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('paymentDate').value = dateString;

                showSuccessMessage('Погашение успешно добавлено');

            } catch (error) {
                console.error('Ошибка при добавлении погашения:', error);
                showErrorMessage('Произошла ошибка при добавлении погашения: ' + error.message);
            }
            console.log('yearData:', yearData);
            console.log('yearData.payments:', yearData.payments);
            console.log('Тип yearData.payments:', typeof yearData.payments);

            if (!yearData.payments) {
                console.error('yearData.payments is undefined! Создаем массив.');
                yearData.payments = [];
            }

            yearData.payments.push(paymentData);
            saveData();
            updatePaymentsTable();
            document.getElementById('paymentsForm').reset();

            console.log('Погашение успешно добавлено');
            // Уведомление уже показывается в try-catch блоке

            // Очищаем стили валидации после сброса формы
            clearPaymentValidationStyles();

            // Восстанавливаем текущую дату после сброса формы
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('paymentDate').value = dateString;
        }

        function handleProductSubmit(e) {
            e.preventDefault();
            const productName = document.getElementById('productName').value;

            // Проверяем что appData.products существует и является массивом
            if (!appData.products || !Array.isArray(appData.products)) {
                appData.products = [];
            }

            if (productName && !appData.products.includes(productName)) {
                appData.products.push(productName);
                saveData();
                updateProductDropdowns();
                updateManagementLists();
                document.getElementById('productForm').reset();
            }
        }

        function handleCompanySubmit(e) {
            e.preventDefault();
            const companyName = document.getElementById('companyName').value;

            // Проверяем что appData.companies существует и является массивом
            if (!appData.companies || !Array.isArray(appData.companies)) {
                appData.companies = [];
            }

            if (companyName && !appData.companies.includes(companyName)) {
                appData.companies.push(companyName);
                saveData();
                updateCompanyDropdowns();
                updateManagementLists();
                document.getElementById('companyForm').reset();
            }
        }

        function handleWarehouseSubmit(e) {
            e.preventDefault();
            const warehouseName = document.getElementById('warehouseName').value;
            const warehouseGroup = document.getElementById('warehouseGroup').value;

            if (warehouseName && warehouseGroup) {
                const warehouse = { name: warehouseName, group: warehouseGroup };
                if (!appData.warehouses.find(w => w.name === warehouseName)) {
                    appData.warehouses.push(warehouse);
                    saveData();
                    updateWarehouseDropdowns();
                    updateManagementLists();
                    document.getElementById('warehouseForm').reset();
                }
            }
        }

        function handleWarehouseGroupSubmit(e) {
            e.preventDefault();
            const groupName = document.getElementById('warehouseGroupName').value;
            if (groupName && !appData.warehouseGroups.includes(groupName)) {
                appData.warehouseGroups.push(groupName);
                saveData();
                updateWarehouseGroupDropdowns();
                updateManagementLists();
                document.getElementById('warehouseGroupForm').reset();
            }
        }

        function handleClientSubmit(e) {
            e.preventDefault();
            const clientName = document.getElementById('clientName').value;
            const clientPhone = document.getElementById('clientPhone').value;

            if (clientName) {
                // Проверяем, есть ли уже клиент с таким именем
                const existingClient = appData.clients.find(client =>
                    (typeof client === 'string' ? client : client.name) === clientName
                );

                if (!existingClient) {
                    const newClient = {
                        name: clientName,
                        phone: clientPhone || ''
                    };
                    appData.clients.push(newClient);
                    saveData();
                    updateClientDropdowns();
                    updateManagementLists();
                    document.getElementById('clientForm').reset();
                }
            }
        }

        function handleCoalitionSubmit(e) {
            e.preventDefault();
            const coalitionName = document.getElementById('coalitionName').value;

            // Инициализируем массив coalitions, если его нет
            if (!appData.coalitions) {
                appData.coalitions = [];
            }

            if (coalitionName && !appData.coalitions.includes(coalitionName)) {
                appData.coalitions.push(coalitionName);
                saveData();
                updateCoalitionDropdowns();
                updateManagementLists();
                document.getElementById('coalitionForm').reset();
            }
        }

        function handleUserSubmit(e) {
            e.preventDefault();
            
            // Получаем выбранные группы складов
            const selectedGroups = Array.from(document.getElementById('userWarehouseGroup').selectedOptions)
                .map(option => option.value);
            
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('userRole').value,
                warehouseGroup: selectedGroups.length > 0 ? selectedGroups : [''],
                blocked: document.getElementById('userBlocked').checked
            };

            if (!appData.users.find(u => u.username === userData.username)) {
                appData.users.push(userData);
                saveData();
                updateUsersTable();
                document.getElementById('userForm').reset();
            }
        }

        function handleChangePassword(e) {
            e.preventDefault();

            const selectedUsername = document.getElementById('changePasswordUser').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordChange').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Проверяем, что все поля заполнены
            if (!selectedUsername || !currentPassword || !newPassword || !confirmPassword) {
                alert('Пожалуйста, заполните все поля!');
                return;
            }

            // Проверяем совпадение нового пароля и подтверждения
            if (newPassword !== confirmPassword) {
                alert('Новый пароль и подтверждение не совпадают!');
                return;
            }

            // Проверяем минимальную длину пароля
            if (newPassword.length < 3) {
                alert('Пароль должен содержать минимум 3 символа!');
                return;
            }

            // Находим пользователя
            const user = appData.users.find(u => u.username === selectedUsername);
            if (!user) {
                alert('Пользователь не найден!');
                return;
            }

            // Проверяем права доступа
            if (currentUser.role !== 'admin' && currentUser.username !== selectedUsername) {
                alert('У вас нет прав для изменения пароля этого пользователя!');
                return;
            }

            // Проверяем текущий пароль
            if (user.password !== currentPassword) {
                alert('Неверный текущий пароль!');
                return;
            }

            // Изменяем пароль
            user.password = newPassword;
            saveData();

            // Очищаем форму
            document.getElementById('changePasswordForm').reset();
            updatePasswordChangeUserList();

            alert(`Пароль для пользователя "${selectedUsername}" успешно изменен!`);

            // Если пользователь изменил свой собственный пароль, обновляем currentUser
            if (currentUser.username === selectedUsername) {
                currentUser.password = newPassword;
            }
        }

        function togglePasswordChangeRequirement(username, required) {
            const user = appData.users.find(u => u.username === username);
            if (user) {
                user.requiresPasswordChange = required;
                saveData();

                const action = required ? 'установлено' : 'снято';
                alert(`Требование смены пароля для пользователя "${username}" ${action}!`);
            }
        }

        function toggleUserBlock(username, blocked) {
            const user = appData.users.find(u => u.username === username);
            if (user) {
                user.blocked = blocked;
                saveData();
                updateUsersTable();

                const action = blocked ? 'заблокирован' : 'разблокирован';
                alert(`Пользователь "${username}" ${action}!`);
            }
        }

        function showForcePasswordChangeModal() {
            document.getElementById('forcePasswordChangeModal').style.display = 'flex';
        }

        function hideForcePasswordChangeModal() {
            document.getElementById('forcePasswordChangeModal').style.display = 'none';
        }

        function handleForcePasswordChange(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('forceCurrentPassword').value;
            const newPassword = document.getElementById('forceNewPassword').value;
            const confirmPassword = document.getElementById('forceConfirmPassword').value;

            // Проверяем, что все поля заполнены
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Пожалуйста, заполните все поля!');
                return;
            }

            // Проверяем совпадение нового пароля и подтверждения
            if (newPassword !== confirmPassword) {
                alert('Новый пароль и подтверждение не совпадают!');
                return;
            }

            // Проверяем минимальную длину пароля
            if (newPassword.length < 3) {
                alert('Пароль должен содержать минимум 3 символа!');
                return;
            }

            // Проверяем текущий пароль
            if (currentUser.password !== currentPassword) {
                alert('Неверный текущий пароль!');
                return;
            }

            // Изменяем пароль
            currentUser.password = newPassword;
            currentUser.requiresPasswordChange = false; // Снимаем требование смены пароля

            // Обновляем данные в массиве пользователей
            const userIndex = appData.users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                appData.users[userIndex].password = newPassword;
                appData.users[userIndex].requiresPasswordChange = false;
            }

            saveData();

            // Скрываем модальное окно
            hideForcePasswordChangeModal();

            // Очищаем форму
            document.getElementById('forcePasswordChangeForm').reset();

            alert('Пароль успешно изменен! Теперь вы можете продолжить работу.');

            // Продолжаем обычный вход в систему
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser.username;
            document.getElementById('currentRole').textContent = getRoleText(currentUser.role);

            setupUserInterface();
            updateYearSelector();
            updateAllTables();
            showSection('dashboard');
            updateDashboard();
        }

        function forcePasswordLogout() {
            hideForcePasswordChangeModal();
            currentUser = null;
            showLoginScreen();
            document.getElementById('loginForm').reset();
            document.getElementById('forcePasswordChangeForm').reset();
        }

        function resetUserPassword(username) {
            // Проверяем права администратора
            if (currentUser.role !== 'admin') {
                alert('Только администратор может сбрасывать пароли!');
                return;
            }

            // Подтверждение действия
            if (!confirm(`Вы уверены, что хотите сбросить пароль для пользователя "${username}"?\n\nНовый временный пароль будет: 123456`)) {
                return;
            }

            // Находим пользователя
            const user = appData.users.find(u => u.username === username);
            if (!user) {
                alert('Пользователь не найден!');
                return;
            }

            // Генерируем временный пароль
            const temporaryPassword = '123456';

            // Сбрасываем пароль
            user.password = temporaryPassword;
            user.requiresPasswordChange = true; // Требуем смену пароля при следующем входе

            saveData();
            updateUsersTable();

            // Показываем информацию администратору
            alert(`Пароль для пользователя "${username}" успешно сброшен!\n\n` +
                `Временный пароль: ${temporaryPassword}\n\n` +
                `Пользователь будет обязан сменить пароль при следующем входе.\n\n` +
                `Сообщите пользователю новый временный пароль.`);
        }

        function showForgotPasswordInfo() {
            alert(`Если вы забыли пароль, обратитесь к администратору системы.\n\n` +
                `Администратор может:\n` +
                `• Сбросить ваш пароль\n` +
                `• Выдать временный пароль\n` +
                `• Помочь восстановить доступ\n\n` +
                `Контакты администратора:\n` +
                `• Найдите пользователя с ролью "Администратор"\n` +
                `• Обратитесь к системному администратору вашей организации`);
        }

        function restoreDefaultUsers() {
            if (confirm('Восстановить пользователей по умолчанию? Это добавит отсутствующих пользователей, но не удалит существующих.')) {
                const defaultUsers = [
                    { username: 'admin', password: 'P0l1uret@n@', role: 'admin', warehouseGroup: [''], blocked: false },
                    { username: 'tillo', password: '123456', role: 'warehouse', warehouseGroup: ['Сугд'], blocked: false },
                    { username: 'abdullo', password: '123456', role: 'warehouse', warehouseGroup: ['Хисор'], blocked: false },
                    { username: 'firdavs', password: '123456', role: 'cashier', warehouseGroup: [''], blocked: false },
                    { username: 'dillik0807', password: '123456', role: 'admin', warehouseGroup: [''], blocked: false },
                    { username: 'sorbon', password: '123456', role: 'admin', warehouseGroup: [''], blocked: false },
                    { username: 'rukovoditel', password: '123456', role: 'manager', warehouseGroup: [''] }
                ];

                let addedCount = 0;
                defaultUsers.forEach(defaultUser => {
                    if (!appData.users.find(u => u.username === defaultUser.username)) {
                        appData.users.push(defaultUser);
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    saveData();
                    updateUsersTable();
                    alert(`Добавлено ${addedCount} пользователей по умолчанию`);
                } else {
                    alert('Все пользователи по умолчанию уже существуют');
                }
            }
        }

        function resetToDefault() {
            if (confirm('ВНИМАНИЕ! Это полностью очистит localStorage и перезагрузит страницу с настройками по умолчанию. Все данные будут потеряны! Продолжить?')) {
                if (confirm('Последнее предупреждение! Все данные будут удалены безвозвратно!')) {
                    localStorage.clear();
                    alert('Данные очищены. Страница будет перезагружена.');
                    location.reload();
                }
            }
        }

        // Firebase функции
        let isFirebaseConnected = false;
        let firebaseListener = null;

        function updateSyncStatus(status, text) {
            const indicators = ['syncIndicator', 'syncIndicatorDesktop'];
            const texts = ['syncText', 'syncTextDesktop'];

            indicators.forEach(id => {
                const indicator = document.getElementById(id);
                if (indicator) {
                    indicator.className = `w-2 h-2 rounded-full ${status === 'connected' ? 'bg-green-400' :
                        status === 'syncing' ? 'bg-yellow-400' : 'bg-gray-400'}`;
                }
            });

            texts.forEach(id => {
                const textEl = document.getElementById(id);
                if (textEl) {
                    textEl.textContent = text;
                }
            });
        }

        async function connectToFirebase() {
            try {
                console.log('🔥 Начинаем подключение к Firebase...');
                updateSyncStatus('syncing', 'Подключение...');

                // Проверяем доступность Firebase
                if (!window.firebaseDB || !window.firebaseRefs) {
                    throw new Error('Firebase SDK не загружен');
                }

                console.log('✅ Firebase SDK доступен');

                // Настройка слушателя изменений для реального времени
                const { ref, onValue, get } = window.firebaseRefs;
                const dataRef = ref(window.firebaseDB, 'retailAppData');

                console.log('👂 Настраиваем слушатель изменений...');

                firebaseListener = onValue(dataRef, (snapshot) => {
                    console.log('🔔 Получено обновление из Firebase');
                    if (snapshot.exists() && !window.isLocalUpdate) {
                        const cloudData = snapshot.val();
                        console.log('📊 Данные из облака:', Object.keys(cloudData));
                        if (cloudData && Object.keys(cloudData).length > 0) {
                            appData = cloudData;
                            localStorage.setItem('retailAppData', JSON.stringify(appData));
                            if (currentUser) {
                                updateAllTables();
                            }
                            console.log('✅ Данные обновлены из облака в реальном времени');
                        }
                    }
                }, (error) => {
                    console.error('❌ Ошибка слушателя Firebase:', error);
                });

                // Попробуем загрузить данные отдельно
                try {
                    console.log('📥 Пробуем загрузить данные из облака...');
                    const snapshot = await get(dataRef);
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        console.log('📊 Получены данные из облака:', Object.keys(cloudData));
                        if (cloudData && Object.keys(cloudData).length > 0) {
                            appData = cloudData;
                            localStorage.setItem('retailAppData', JSON.stringify(appData));
                            if (currentUser) {
                                updateAllTables();
                            }
                            console.log('✅ Данные загружены и интерфейс обновлен');
                        }
                    } else {
                        console.log('ℹ️ В облаке пока нет данных');
                    }
                } catch (loadError) {
                    console.log('⚠️ Не удалось загрузить данные при подключении:', loadError.message);
                    console.log('Но слушатель настроен, данные будут синхронизироваться при изменениях');
                }

                isFirebaseConnected = true;
                updateSyncStatus('connected', 'Онлайн');
                console.log('🎉 Firebase подключен успешно! Синхронизация активна.');

            } catch (error) {
                console.error('❌ Ошибка подключения к Firebase:', error);
                console.error('Детали ошибки:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                updateSyncStatus('offline', 'Ошибка');

                let errorMsg = 'Ошибка подключения: ';
                if (error.message.includes('network')) {
                    errorMsg += 'Проблема с интернет-соединением';
                } else if (error.message.includes('permission')) {
                    errorMsg += 'Нет доступа к базе данных';
                } else {
                    errorMsg += error.message;
                }

                alert(errorMsg);
            }
        }

        async function syncToCloud() {
            if (!isFirebaseConnected) {
                alert('Сначала подключитесь к Firebase');
                return;
            }

            try {
                updateSyncStatus('syncing', 'Загрузка...');

                const { ref, set } = window.firebaseRefs;
                const dataRef = ref(window.firebaseDB, 'retailAppData');

                window.isLocalUpdate = true;
                await set(dataRef, appData);
                window.isLocalUpdate = false;

                updateSyncStatus('connected', 'Загружено');
                alert('Данные успешно загружены в облако!');

                setTimeout(() => {
                    updateSyncStatus('connected', 'Онлайн');
                }, 2000);

            } catch (error) {
                console.error('Ошибка загрузки в облако:', error);
                updateSyncStatus('connected', 'Ошибка загрузки');
                alert('Ошибка загрузки: ' + error.message);
            }
        }

        async function syncFromCloud() {
            if (!isFirebaseConnected) {
                alert('Сначала подключитесь к Firebase');
                return;
            }

            try {
                updateSyncStatus('syncing', 'Скачивание...');

                const { ref, get } = window.firebaseRefs;
                const dataRef = ref(window.firebaseDB, 'retailAppData');
                const snapshot = await get(dataRef);

                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    if (confirm('Заменить локальные данные данными из облака?')) {
                        appData = cloudData;
                        localStorage.setItem('retailAppData', JSON.stringify(appData));
                        if (currentUser) {
                            updateAllTables();
                        }
                        updateSyncStatus('connected', 'Скачано');
                        alert('Данные успешно загружены из облака!');
                    }
                } else {
                    alert('В облаке нет данных');
                }

                setTimeout(() => {
                    updateSyncStatus('connected', 'Онлайн');
                }, 2000);

            } catch (error) {
                console.error('Ошибка загрузки из облака:', error);
                updateSyncStatus('connected', 'Ошибка скачивания');
                alert('Ошибка загрузки: ' + error.message);
            }
        }

        function enableOfflineMode() {
            console.log('📴 Включен офлайн режим');
            updateSyncStatus('offline', 'Офлайн режим');

            alert('Система работает в офлайн режиме.\nДанные сохраняются локально в браузере.\nДля синхронизации используйте экспорт/импорт.');
        }

        function updateAllTables() {
            console.log('🔄 Обновляем все таблицы после синхронизации...');

            // Проверяем что пользователь вошел в систему
            if (!currentUser) {
                console.log('Пользователь не вошел в систему, пропускаем обновление таблиц');
                return;
            }

            // Проверяем что DOM готов
            if (!document.getElementById('incomeTableBody')) {
                console.log('DOM еще не готов, откладываем обновление таблиц');
                setTimeout(() => updateAllTables(), 1000);
                return;
            }

            // Обновляем все таблицы с индивидуальной обработкой ошибок
            console.log('📊 Обновляем таблицы данных...');

            // Обновляем таблицы данных
            updateAllTables.safeUpdate('updateIncomeTable', '  - Обновляем таблицу приходов');
            updateAllTables.safeUpdate('updateExpenseTable', '  - Обновляем таблицу расходов');
            updateAllTables.safeUpdate('updatePaymentsTable', '  - Обновляем таблицу платежей');
            updateAllTables.safeUpdate('updateUsersTable', '  - Обновляем таблицу пользователей');

            // Обновляем списки управления
            console.log('📋 Обновляем списки управления...');
            updateAllTables.safeUpdate('updateManagementLists', '  - Обновляем списки управления');

            // Обновляем выпадающие списки
            console.log('🔽 Обновляем выпадающие списки...');
            updateAllTables.safeUpdate('updateDropdowns', '  - Обновляем выпадающие списки');

            // Обновляем селектор года
            console.log('📅 Обновляем селектор года...');
            updateAllTables.safeUpdate('updateYearSelector', '  - Обновляем селектор года');

            // Обновляем Dashboard
            console.log('📈 Обновляем Dashboard...');
            updateAllTables.safeUpdate('updateDashboard', '  - Обновляем Dashboard');

            console.log('✅ Все таблицы обновлены успешно');
        }

        // Вспомогательная функция для безопасного обновления
        updateAllTables.safeUpdate = function (functionName, logMessage) {
            try {
                if (typeof window[functionName] === 'function') {
                    console.log(logMessage);
                    window[functionName]();
                } else {
                    console.log(`⚠️ Функция ${functionName} не найдена`);
                }
            } catch (error) {
                console.error(`❌ Ошибка в ${functionName}:`, error);
            }
        }

        // Тихая синхронизация без уведомлений
        async function syncToCloudSilent() {
            if (!isFirebaseConnected || !window.firebaseDB) return;

            try {
                const { ref, set } = window.firebaseRefs;
                const dataRef = ref(window.firebaseDB, 'retailAppData');

                window.isLocalUpdate = true;
                await set(dataRef, appData);
                window.isLocalUpdate = false;

                console.log('Данные автоматически синхронизированы с облаком');

            } catch (error) {
                console.error('Ошибка автосинхронизации:', error);
            }
        }

        function updateIncomeTable() {
            const tbody = document.getElementById('incomeTableBody');
            tbody.innerHTML = '';

            // Получаем данные текущего года с проверкой
            const currentData = getCurrentYearData();
            if (!currentData || !currentData.income || !Array.isArray(currentData.income)) {
                console.log('Нет данных о доходах для текущего года');
                return;
            }

            let income = currentData.income;

            // Фильтрация для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            // Сортировка: сначала новые, потом старые
            income.sort((a, b) => {
                // Пробуем разные способы сортировки

                // 1. По timestamp если есть
                if (a.timestamp && b.timestamp) {
                    return b.timestamp - a.timestamp;
                }

                // 2. По ID если есть
                if (a.id && b.id) {
                    return b.id - a.id;
                }

                // 3. По дате
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);

                if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                    return dateB.getTime() - dateA.getTime();
                }

                // 4. Если ничего не работает, оставляем как есть
                return 0;
            });

            income.forEach(item => {
                // Проверяем права на редактирование с учетом даты
                const canEdit = canEditRecord(item);
                // Только администратор может удалять любые данные
                const canDelete = currentUser.role === 'admin';
                const editInfo = item.editedBy ? ` (изменено: ${item.editedBy})` : '';

                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">${item.date}</td>
                        <td class="p-3">${item.wagon}</td>
                        <td class="p-3">${item.company}</td>
                        <td class="p-3">${item.warehouse}</td>
                        <td class="p-3">${item.product}</td>
                        <td class="p-3">${item.qtyDoc}</td>
                        <td class="p-3">${item.qtyFact}</td>
                        <td class="p-3">${item.difference}</td>
                        <td class="p-3">${item.weightTons}</td>
                        <td class="p-3">${item.user}${editInfo}</td>
                        <td class="p-3">
                            ${canEdit ? `<button onclick="editIncome(${item.id})" class="text-blue-600 hover:text-blue-800 mr-2">Изменить</button>` : ''}
                            ${canDelete ? `<button onclick="deleteIncome(${item.id})" class="text-red-600 hover:text-red-800 mr-2">Удалить</button>` : ''}
                            ${currentUser && currentUser.role === 'admin' ? `<button onclick="transferIncomeToYear(${item.id})" class="text-purple-600 hover:text-purple-800" title="Перенести в другой год">Перенести</button>` : ''}
                        </td>
                    </tr>
                `;
            });
        }

        function updateExpenseTable() {
            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = '';

            // Получаем данные текущего года с проверкой
            const currentData = getCurrentYearData();
            if (!currentData || !currentData.expense || !Array.isArray(currentData.expense)) {
                console.log('Нет данных о расходах для текущего года');
                return;
            }

            let expense = currentData.expense;
            console.log('Обновление таблицы расходов, найдено записей:', expense.length);

            // Фильтрация для завсклада
            if (currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            // Сортировка: сначала новые, потом старые
            expense.sort((a, b) => {
                // Пробуем разные способы сортировки

                // 1. По timestamp если есть
                if (a.timestamp && b.timestamp) {
                    return b.timestamp - a.timestamp;
                }

                // 2. По ID если есть
                if (a.id && b.id) {
                    return b.id - a.id;
                }

                // 3. По дате
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);

                if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                    return dateB.getTime() - dateA.getTime();
                }

                // 4. Если ничего не работает, оставляем как есть
                return 0;
            });

            expense.forEach((item, index) => {
                // Проверяем права на редактирование с учетом даты
                const canEdit = canEditRecord(item);
                // Только администратор может удалять любые данные
                const canDelete = currentUser.role === 'admin';
                const editInfo = item.editedBy ? ` (изменено: ${item.editedBy})` : '';

                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">
                            <input type="checkbox" class="expense-checkbox" data-index="${index}" data-id="${item.id}" data-client="${item.client}">
                        </td>
                        <td class="p-3">${item.date}</td>
                        <td class="p-3">${item.coalition || ''}</td>
                        <td class="p-3">${item.number || ''}</td>
                        <td class="p-3">${item.company}</td>
                        <td class="p-3">${item.warehouse}</td>
                        <td class="p-3">${item.product}</td>
                        <td class="p-3">${item.client}</td>
                        <td class="p-3">${item.quantity}</td>
                        <td class="p-3">${item.tons}</td>
                        <td class="p-3">${item.price}</td>
                        <td class="p-3">${item.total}</td>
                        <td class="p-3">${item.user}${editInfo}</td>
                        <td class="p-3">
                            ${canEdit ? `<button onclick="editExpense(${item.id})" class="text-blue-600 hover:text-blue-800 mr-2">Изменить</button>` : ''}
                            ${canDelete ? `<button onclick="deleteExpense(${item.id})" class="text-red-600 hover:text-red-800 mr-2">Удалить</button>` : ''}
                            ${currentUser && currentUser.role === 'admin' ? `<button onclick="transferExpenseToYear(${item.id})" class="text-purple-600 hover:text-purple-800" title="Перенести в другой год">Перенести</button>` : ''}
                        </td>
                    </tr>
                `;
            });
        }

        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            // Получаем данные текущего года с проверкой
            const currentData = getCurrentYearData();
            if (!currentData || !currentData.payments || !Array.isArray(currentData.payments)) {
                console.log('Нет данных о платежах для текущего года');
                return;
            }

            // Сортировка: сначала новые, потом старые
            let payments = currentData.payments.slice().sort((a, b) => {
                // Пробуем разные способы сортировки

                // 1. По timestamp если есть
                if (a.timestamp && b.timestamp) {
                    return b.timestamp - a.timestamp;
                }

                // 2. По ID если есть
                if (a.id && b.id) {
                    return b.id - a.id;
                }

                // 3. По дате
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);

                if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) {
                    return dateB.getTime() - dateA.getTime();
                }

                // 4. Если ничего не работает, оставляем как есть
                return 0;
            });

            payments.forEach((item, index) => {
                // Проверяем права на редактирование с учетом даты
                const canEdit = canEditRecord(item);
                // Только администратор может удалять любые данные
                const canDelete = currentUser.role === 'admin';
                const editInfo = item.editedBy ? ` (изменено: ${item.editedBy})` : '';

                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">
                            <input type="checkbox" class="payment-checkbox" data-index="${index}" data-id="${item.id}" data-client="${item.client}">
                        </td>
                        <td class="p-3">${item.date}</td>
                        <td class="p-3">${item.client}</td>
                        <td class="p-3">${item.somoni}</td>
                        <td class="p-3">${item.rate}</td>
                        <td class="p-3">${item.amount}</td>
                        <td class="p-3">${item.notes}</td>
                        <td class="p-3">${item.user}${editInfo}</td>
                        <td class="p-3">
                            ${canEdit ? `<button onclick="editPayment(${item.id})" class="text-blue-600 hover:text-blue-800 mr-2">Изменить</button>` : ''}
                            ${canDelete ? `<button onclick="deletePayment(${item.id})" class="text-red-600 hover:text-red-800 mr-2">Удалить</button>` : ''}
                            ${currentUser && currentUser.role === 'admin' ? `<button onclick="transferPaymentToYear(${item.id})" class="text-purple-600 hover:text-purple-800" title="Перенести в другой год">Перенести</button>` : ''}
                        </td>
                    </tr>
                `;
            });
        }

        function updateWagonSummary() {
            const tbody = document.getElementById('wagonSummaryTableBody');
            const warehouseFilter = document.getElementById('wagonSummaryWarehouse').value;
            tbody.innerHTML = '';

            let income = getCurrentYearData().income;

            // Фильтрация по складу
            if (warehouseFilter) {
                income = income.filter(item => item.warehouse === warehouseFilter);
            }

            // Фильтрация для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            let totalWagons = 0;
            let totalWeight = 0;
            let totalDifference = 0;

            income.forEach(item => {
                totalWagons++;
                totalWeight += item.weightTons;
                totalDifference += item.difference;

                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">${item.wagon}</td>
                        <td class="p-3">${item.company}</td>
                        <td class="p-3">${item.warehouse}</td>
                        <td class="p-3">${item.product}</td>
                        <td class="p-3">${item.qtyDoc}</td>
                        <td class="p-3">${item.qtyFact}</td>
                        <td class="p-3">${item.weightTons}</td>
                    </tr>
                `;
            });

            document.getElementById('totalWagons').textContent = totalWagons;
            document.getElementById('totalWeight').textContent = totalWeight.toFixed(2);
            document.getElementById('totalDifference').textContent = totalDifference;
        }

        function updateBalanceSummary() {
            const tbody = document.getElementById('balanceSummaryTableBody');
            const warehouseFilter = document.getElementById('balanceSummaryWarehouse').value;
            tbody.innerHTML = '';

            const summary = {};

            // Обработка прихода
            let income = getCurrentYearData().income;
            let expense = getCurrentYearData().expense;

            // Фильтрация для завсклада - СНАЧАЛА по подгруппе
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            // Фильтрация по складу
            if (warehouseFilter) {
                income = income.filter(item => item.warehouse === warehouseFilter);
                expense = expense.filter(item => item.warehouse === warehouseFilter);
            }

            income.forEach(item => {
                const key = `${item.warehouse}-${item.company}-${item.product}`;
                if (!summary[key]) {
                    summary[key] = {
                        warehouse: item.warehouse,
                        company: item.company,
                        product: item.product,
                        income: 0,
                        expense: 0
                    };
                }
                summary[key].income += item.qtyFact;
            });

            // Обработка расхода
            expense.forEach(item => {
                const key = `${item.warehouse}-${item.company}-${item.product}`;
                if (!summary[key]) {
                    summary[key] = {
                        warehouse: item.warehouse,
                        company: item.company,
                        product: item.product,
                        income: 0,
                        expense: 0
                    };
                }
                summary[key].expense += item.quantity;
            });

            let summaryTotalIncome = 0;
            let summaryTotalExpense = 0;
            let summaryTotalBalance = 0;

            Object.values(summary).forEach(item => {
                const balance = item.income - item.expense;
                const balanceTons = balance / 20;

                summaryTotalIncome += item.income;
                summaryTotalExpense += item.expense;
                summaryTotalBalance += balanceTons;

                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">${item.warehouse}</td>
                        <td class="p-3">${item.company}</td>
                        <td class="p-3">${item.product}</td>
                        <td class="p-3">${item.income}</td>
                        <td class="p-3">${item.expense}</td>
                        <td class="p-3">${balance}</td>
                        <td class="p-3">${balanceTons.toFixed(2)}</td>
                    </tr>
                `;
            });

            document.getElementById('summaryTotalIncome').textContent = summaryTotalIncome;
            document.getElementById('summaryTotalExpense').textContent = summaryTotalExpense;
            document.getElementById('summaryTotalBalance').textContent = summaryTotalBalance.toFixed(2);
        }

        function updateDebtReport() {
            console.log('🔍 updateDebtReport: Текущий год:', appData.currentYear);

            // Получаем данные текущего года с проверкой
            const currentData = getCurrentYearData();
            if (!currentData || !currentData.expense || !currentData.payments) {
                console.log('Нет данных для отчета по долгам');
                return;
            }

            console.log('🔍 updateDebtReport: Данные расходов:', currentData.expense.length);
            console.log('🔍 updateDebtReport: Данные погашений:', currentData.payments.length);

            const tbody = document.getElementById('debtReportTableBody');
            tbody.innerHTML = '';

            const clientDebts = {};

            // Подсчёт задолженности по всем расходам (завсклады теперь видят все долги)
            currentData.expense.forEach(item => {
                if (!clientDebts[item.client]) {
                    clientDebts[item.client] = { total: 0, paid: 0 };
                }
                clientDebts[item.client].total += item.total;
            });

            // Подсчёт всех погашений
            currentData.payments.forEach(item => {
                if (!clientDebts[item.client]) {
                    clientDebts[item.client] = { total: 0, paid: 0 };
                }
                clientDebts[item.client].paid += item.amount;
            });

            let totalDebtAmount = 0;
            let totalDebtSum = 0;
            let totalPaidSum = 0;
            let totalOverpayment = 0;
            let totalDebts = 0;

            Object.keys(clientDebts).forEach(client => {
                const debt = clientDebts[client];
                const remaining = debt.paid - debt.total; // Изменена формула: Погашено - Общая задолженность

                // Накапливаем итоги
                totalDebtAmount += remaining;
                totalDebtSum += debt.total;
                totalPaidSum += debt.paid;

                if (remaining >= 0) {
                    totalOverpayment += remaining;
                } else {
                    totalDebts += Math.abs(remaining);
                }

                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">${client}</td>
                        <td class="p-3">${debt.total.toFixed(2)}</td>
                        <td class="p-3">${debt.paid.toFixed(2)}</td>
                        <td class="p-3 ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}">${remaining.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Обновляем все итоги
            document.getElementById('totalDebtSum').textContent = totalDebtSum.toFixed(2);
            document.getElementById('totalPaidSum').textContent = totalPaidSum.toFixed(2);
            document.getElementById('totalOverpayment').textContent = totalOverpayment.toFixed(2);
            document.getElementById('totalDebts').textContent = totalDebts.toFixed(2);
            document.getElementById('totalDebtAmount').textContent = totalDebtAmount.toFixed(2);
        }

        function updateWagonTotals() {
            const tbody = document.getElementById('wagonTotalsTableBody');
            tbody.innerHTML = '';

            const totals = {};

            let income = getCurrentYearData().income;

            // Фильтрация для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            income.forEach(item => {
                const key = `${item.product}-${item.company}-${item.warehouse}`;
                if (!totals[key]) {
                    totals[key] = {
                        product: item.product,
                        company: item.company,
                        warehouse: item.warehouse,
                        wagons: 0,
                        qtyDoc: 0,
                        qtyFact: 0,
                        weightTons: 0
                    };
                }
                totals[key].wagons++;
                totals[key].qtyDoc += item.qtyDoc;
                totals[key].qtyFact += item.qtyFact;
                totals[key].weightTons += item.weightTons;
            });

            let grandTotalWagons = 0;
            let grandTotalDoc = 0;
            let grandTotalFact = 0;
            let grandTotalDifference = 0;
            let grandTotalWeight = 0;

            Object.values(totals).forEach(item => {
                grandTotalWagons += item.wagons;
                grandTotalDoc += item.qtyDoc;
                grandTotalFact += item.qtyFact;
                grandTotalDifference += (item.qtyFact - item.qtyDoc);
                grandTotalWeight += item.weightTons;

                const difference = item.qtyFact - item.qtyDoc;
                tbody.innerHTML += `
                    <tr>
                        <td class="p-3">${item.product}</td>
                        <td class="p-3">${item.company}</td>
                        <td class="p-3">${item.warehouse}</td>
                        <td class="p-3">${item.wagons}</td>
                        <td class="p-3">${item.qtyDoc}</td>
                        <td class="p-3">${item.qtyFact}</td>
                        <td class="p-3 ${difference >= 0 ? 'text-green-600' : 'text-red-600'}">${difference}</td>
                        <td class="p-3">${item.weightTons.toFixed(2)}</td>
                    </tr>
                `;
            });

            document.getElementById('grandTotalWagons').textContent = grandTotalWagons;
            document.getElementById('grandTotalDoc').textContent = grandTotalDoc;
            document.getElementById('grandTotalFact').textContent = grandTotalFact;
            document.getElementById('grandTotalDifference').textContent = grandTotalDifference;
            document.getElementById('grandTotalWeight').textContent = grandTotalWeight.toFixed(2);
        }

        function updateDashboard() {
            console.log('📊 Обновление Dashboard для пользователя:', currentUser?.username, 'роль:', currentUser?.role);
            
            let totalIncome = 0;
            let totalExpense = 0;
            let totalDebt = 0;

            // Фильтрация для завсклада
            let income = getCurrentYearData().income || [];
            let expense = getCurrentYearData().expense || [];

            console.log('📊 Исходные данные - Приход:', income.length, 'Расход:', expense.length);

            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                console.log('📊 Фильтрация для завсклада, группы:', currentUser.warehouseGroup);
                const userWarehouses = getUserWarehouseNames();
                console.log('📊 Доступные склады:', userWarehouses);
                
                const originalIncomeLength = income.length;
                const originalExpenseLength = expense.length;
                
                income = income.filter(item => userWarehouses.includes(item.warehouse));
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
                
                console.log('📊 После фильтрации - Приход:', income.length, '(было:', originalIncomeLength + '), Расход:', expense.length, '(было:', originalExpenseLength + ')');
            }

            income.forEach(item => totalIncome += item.qtyFact);
            expense.forEach(item => {
                totalExpense += item.quantity;
                totalDebt += item.total;
            });

            // Вычесть погашения из долгов
            getCurrentYearData().payments.forEach(item => totalDebt -= item.amount);

            const totalBalance = totalIncome - totalExpense;

            console.log('📊 Итоговые значения - Приход:', totalIncome, 'Расход:', totalExpense, 'Остаток:', totalBalance, 'Долги:', totalDebt.toFixed(2));

            document.getElementById('totalIncome').textContent = totalIncome;
            document.getElementById('totalExpense').textContent = totalExpense;
            document.getElementById('totalBalance').textContent = totalBalance;
            document.getElementById('totalDebt').textContent = totalDebt.toFixed(2);
            
            console.log('📊 Dashboard обновлен успешно');
        }

        // ===== ФУНКЦИИ ДЛЯ БЫСТРЫХ ОТЧЕТОВ =====

        function generateQuickStockReport() {
            const currentYear = appData.currentYear;
            const currentData = getCurrentYearData();

            console.log('📊 Генерация быстрого отчета остатков для года:', currentYear);

            if (!currentData) {
                console.error('Нет данных для текущего года');
                return 'Нет данных для формирования отчета';
            }

            let report = `Фактический Остаток\n\n`;

            // Рассчитываем остатки по складам (используем логику из "Остатки складов")
            const balances = calculateWarehouseBalances(currentData);

            let groupIndex = 1;
            const totalBalances = {};

            // Группируем склады по подгруппам (как в оригинальном отчете)
            if (appData.warehouseGroups && appData.warehouseGroups.length > 0) {
                appData.warehouseGroups.forEach(group => {
                    const groupWarehouses = (appData.warehouses || []).filter(w => w.group === group);

                    if (groupWarehouses.length > 0) {
                        let hasData = false;
                        let groupReport = `${groupIndex}) ${group}\n`;

                        // Сначала собираем все товары по группе
                        const groupBalances = {};
                        
                        groupWarehouses.forEach(warehouse => {
                            const warehouseBalance = balances[warehouse.name];
                            if (warehouseBalance) {
                                Object.keys(warehouseBalance).forEach(product => {
                                    const balance = warehouseBalance[product];
                                    if (Math.abs(balance) > 0.01) { // Показываем только ненулевые остатки
                                        if (!groupBalances[product]) {
                                            groupBalances[product] = 0;
                                        }
                                        groupBalances[product] += balance;
                                        hasData = true;
                                    }
                                });
                            }
                        });

                        // Выводим суммированные товары по группе
                        Object.keys(groupBalances).forEach(product => {
                            const balance = groupBalances[product];
                            groupReport += `${product}\t${balance.toFixed(2)} т/н (${currentYear})\n`;
                            
                            // Добавляем к общим итогам
                            if (!totalBalances[product]) {
                                totalBalances[product] = 0;
                            }
                            totalBalan

                        if (hasData) {
                            report += groupReport + '\n';
                            groupIndex++;
                        }
                    }
                });
            }

            // Добавляем итоги
            report += `Итого: Торговый Дом\n`;
            let grandTotal = 0;

            Object.keys(totalBalances).forEach(product => {
                const total = totalBalances[product];
                if (Math.abs(total) > 0.01) {
                    report += `${product}\t${total.toFixed(2)} т/н (${currentYear})\n`;
                    grandTotal += total;
                }
            });

            report += `\n${grandTotal.toFixed(2)} т/н (${currentYear})`;

            console.log('📊 Отчет сформирован, общий итог:', grandTotal.toFixed(2));

            return report;
        }

        function calculateWarehouseBalances(currentData) {
            console.log('📊 Расчет остатков складов на основе логики "Остатки складов"');
            
            // Используем ту же логику, что и в разделе "Остатки складов"
            const summary = {};

            // Обрабатываем приход товаров (как в updateBalanceSummary)
            if (currentData.income && Array.isArray(currentData.income)) {
                console.log('📊 Обрабатываем приход:', currentData.income.length, 'записей');
                currentData.income.forEach(incomeItem => {
                    const warehouseName = incomeItem.warehouse;
                    const companyName = incomeItem.company;
                    const productName = incomeItem.product;
                    const key = `${warehouseName}-${companyName}-${productName}`;

                    if (!summary[key]) {
                        summary[key] = {
                            warehouse: warehouseName,
                            company: companyName,
                            product: productName,
                            income: 0,
                            expense: 0
                        };
                    }
                    // Используем qtyFact как в своде остатков
                    summary[key].income += parseFloat(incomeItem.qtyFact) || 0;
                });
            }

            // Обрабатываем расход товаров (как в updateBalanceSummary)
            if (currentData.expense && Array.isArray(currentData.expense)) {
                console.log('📊 Обрабатываем расход:', currentData.expense.length, 'записей');
                currentData.expense.forEach(expenseItem => {
                    const warehouseName = expenseItem.warehouse;
                    const companyName = expenseItem.company;
                    const productName = expenseItem.product;
                    const key = `${warehouseName}-${companyName}-${productName}`;

                    if (!summary[key]) {
                        summary[key] = {
                            warehouse: warehouseName,
                            company: companyName,
                            product: productName,
                            income: 0,
                            expense: 0
                        };
                    }
                    // Используем quantity как в своде остатков
                    summary[key].expense += parseFloat(expenseItem.quantity) || 0;
                });
            }

            // Преобразуем в структуру остатков по складам (как в оригинальной функции)
            const stockBalances = {};
            Object.values(summary).forEach(item => {
                const balance = item.income - item.expense; // Реальный остаток в штуках
                const balanceTons = balance / 20; // Переводим в тонны (как в своде остатков)

                if (!stockBalances[item.warehouse]) {
                    stockBalances[item.warehouse] = {};
                }
                if (!stockBalances[item.warehouse][item.product]) {
                    stockBalances[item.warehouse][item.product] = 0;
                }
                stockBalances[item.warehouse][item.product] += balanceTons;
            });

            console.log('📊 Рассчитанные остатки по складам:', stockBalances);
            return stockBalances;
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function sendToWhatsAppSmart(text) {
            const encodedText = encodeURIComponent(text);
            
            if (isMobile()) {
                // На мобильных открываем приложение WhatsApp
                window.location.href = `whatsapp://send?text=${encodedText}`;
            } else {
                // На десктопе открываем WhatsApp Web
                window.open(`https://web.whatsapp.com/send?text=${encodedText}`, '_blank');
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('✅ Отчет скопирован в буфер обмена!');
                }).catch(err => {
                    console.error('Ошибка копирования:', err);
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('✅ Отчет скопирован в буфер обмена!');
            } catch (err) {
                console.error('Ошибка копирования:', err);
                alert('❌ Не удалось скопировать отчет');
            }
            
            document.body.removeChild(textArea);
        }

        function updateManagementLists() {
            // Обновить списки в управлении
            updateProductsList();
            updateCompaniesList();
            updateWarehousesList();
            updateWarehouseGroupsList();
            updateClientsList();
            updateCoalitionsList();

            // Обновить интерфейс управления годами
            if (typeof updateYearManagementInterface === 'function') {
                updateYearManagementInterface();
            }
        }

        function updateProductsList() {
            const list = document.getElementById('productsList');
            if (!list) return;

            list.innerHTML = '';

            // Проверяем что appData.products существует и является массивом
            if (!appData.products || !Array.isArray(appData.products)) {
                appData.products = [];
            }

            appData.products.forEach((product, index) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span>${product}</span>
                        ${currentUser && currentUser.role === 'admin' ? `<button onclick="deleteProduct(${index})" class="text-red-600 hover:text-red-800">Удалить</button>` : ''}
                    </div>
                `;
            });
        }

        function updateCompaniesList() {
            const list = document.getElementById('companiesList');
            if (!list) return;

            list.innerHTML = '';

            // Проверяем что appData.companies существует и является массивом
            if (!appData.companies || !Array.isArray(appData.companies)) {
                appData.companies = [];
            }

            appData.companies.forEach((company, index) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span>${company}</span>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteCompany(${index})" class="text-red-600 hover:text-red-800">Удалить</button>` : ''}
                    </div>
                `;
            });
        }

        function updateWarehousesList() {
            const list = document.getElementById('warehousesList');
            if (!list) return;

            list.innerHTML = '';

            // Проверяем что appData.warehouses существует и является массивом
            if (!appData.warehouses || !Array.isArray(appData.warehouses)) {
                appData.warehouses = [];
            }

            appData.warehouses.forEach((warehouse, index) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span>${warehouse.name} (${warehouse.group})</span>
                        ${currentUser && currentUser.role === 'admin' ? `<button onclick="deleteWarehouse(${index})" class="text-red-600 hover:text-red-800">Удалить</button>` : ''}
                    </div>
                `;
            });
        }

        function updateWarehouseGroupsList() {
            const list = document.getElementById('warehouseGroupsList');
            if (!list) return;

            list.innerHTML = '';

            // Проверяем что appData.warehouseGroups существует и является массивом
            if (!appData.warehouseGroups || !Array.isArray(appData.warehouseGroups)) {
                appData.warehouseGroups = [];
            }

            appData.warehouseGroups.forEach((group, index) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span>${group}</span>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteWarehouseGroup(${index})" class="text-red-600 hover:text-red-800">Удалить</button>` : ''}
                    </div>
                `;
            });
        }

        function updateClientsList() {
            const list = document.getElementById('clientsList');
            if (!list) return;

            list.innerHTML = '';

            // Проверяем что appData.clients существует и является массивом
            if (!appData.clients || !Array.isArray(appData.clients)) {
                appData.clients = [];
            }

            appData.clients.forEach((client, index) => {
                // Поддержка старого формата (строки) и нового (объекты)
                const clientName = typeof client === 'string' ? client : client.name;
                const clientPhone = typeof client === 'string' ? '' : (client.phone || '');

                list.innerHTML += `
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium">${clientName}</div>
                                ${clientPhone ? `<div class="text-sm text-gray-600">📞 ${clientPhone}</div>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editClient(${index})" class="text-blue-600 hover:text-blue-800 text-sm">Изменить</button>
                                ${currentUser.role === 'admin' ? `<button onclick="deleteClient(${index})" class="text-red-600 hover:text-red-800 text-sm">Удалить</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function updateCoalitionsList() {
            const list = document.getElementById('coalitionsList');
            if (!list) return;

            list.innerHTML = '';
            if (appData.coalitions) {
                appData.coalitions.forEach((coalition, index) => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>${coalition}</span>
                            ${currentUser && currentUser.role === 'admin' ? `<button onclick="deleteCoalition(${index})" class="text-red-600 hover:text-red-800">Удалить</button>` : ''}
                        </div>
                    `;
                });
            }
        }

        function updateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            // Проверяем наличие данных пользователей
            if (!appData || !appData.users || !Array.isArray(appData.users)) {
                console.log('Нет данных о пользователях');
                return;
            }

            appData.users.forEach((user, index) => {
                if (user.username !== 'admin') { // Не показывать админа в списке
                    const requiresPasswordChange = user.requiresPasswordChange || false;
                    const isBlocked = user.blocked || false;
                    tbody.innerHTML += `
                        <tr class="${isBlocked ? 'bg-red-50' : ''}">
                            <td class="p-3">${user.username}</td>
                            <td class="p-3">${getRoleText(user.role)}</td>
                            <td class="p-3">${Array.isArray(user.warehouseGroup) ? user.warehouseGroup.filter(g => g !== '').join(', ') || '-' : user.warehouseGroup || '-'}</td>
                            <td class="p-3">
                                ${currentUser.role === 'admin' ? `
                                    <label class="flex items-center">
                                        <input type="checkbox" ${isBlocked ? 'checked' : ''} 
                                               onchange="toggleUserBlock('${user.username}', this.checked)"
                                               class="mr-2">
                                        <span class="text-sm ${isBlocked ? 'text-red-600 font-semibold' : 'text-green-600'}">${isBlocked ? '🔒 Заблокирован' : '✅ Активен'}</span>
                                    </label>
                                ` : `<span class="text-sm ${isBlocked ? 'text-red-600 font-semibold' : 'text-green-600'}">${isBlocked ? '🔒 Заблокирован' : '✅ Активен'}</span>`}
                            </td>
                            <td class="p-3">
                                ${currentUser.role === 'admin' ? `
                                    <input type="checkbox" ${requiresPasswordChange ? 'checked' : ''} 
                                           onchange="togglePasswordChangeRequirement('${user.username}', this.checked)"
                                           class="mr-2">
                                    <span class="text-sm">${requiresPasswordChange ? 'Да' : 'Нет'}</span>
                                ` : (requiresPasswordChange ? 'Да' : 'Нет')}
                            </td>
                            <td class="p-3">
                                ${currentUser.role === 'admin' ? `
                                    <button onclick="editUserGroups('${user.username}')" class="text-blue-600 hover:text-blue-800 mr-2 text-sm">✏️ Группы</button>
                                    <button onclick="resetUserPassword('${user.username}')" class="text-orange-600 hover:text-orange-800 mr-2 text-sm">🔑 Пароль</button>
                                    <button onclick="deleteUser(${index})" class="text-red-600 hover:text-red-800 text-sm">🗑️ Удалить</button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }
            });

            // Обновляем список пользователей для смены пароля
            updatePasswordChangeUserList();
        }

        function updatePasswordChangeUserList() {
            const select = document.getElementById('changePasswordUser');
            if (select) {
                select.innerHTML = '<option value="">Выберите пользователя</option>';

                // Администратор может менять пароли всех пользователей
                if (currentUser && currentUser.role === 'admin') {
                    appData.users.forEach(user => {
                        select.innerHTML += `<option value="${user.username}">${user.username} (${getRoleText(user.role)})</option>`;
                    });
                } else if (currentUser) {
                    // Обычные пользователи могут менять только свой пароль
                    select.innerHTML += `<option value="${currentUser.username}">${currentUser.username} (${getRoleText(currentUser.role)})</option>`;
                    select.value = currentUser.username;
                    select.disabled = true;
                }
            }
        }

        function setupPasswordChangeInterface() {
            const userSelectDiv = document.getElementById('userSelectDiv');
            const select = document.getElementById('changePasswordUser');

            if (currentUser && currentUser.role !== 'admin') {
                // Для обычных пользователей скрываем выбор пользователя
                userSelectDiv.style.display = 'none';
                if (select) {
                    select.value = currentUser.username;
                }
            } else {
                // Для администратора показываем выбор пользователя
                userSelectDiv.style.display = 'block';
                if (select) {
                    select.disabled = false;
                }
            }
        }

        // Функция проверки прав редактирования с учетом даты
        function canEditRecord(record) {
            // Администратор может редактировать всё всегда
            if (currentUser.role === 'admin') {
                return true;
            }

            // Пользователь может редактировать только свои записи
            if (record.user !== currentUser.username) {
                return false;
            }

            // Проверяем дату записи - можно редактировать только записи текущего дня
            const recordDate = new Date(record.date);
            const today = new Date();

            // Сравниваем только дату (без времени)
            const recordDateString = recordDate.toDateString();
            const todayDateString = today.toDateString();

            return recordDateString === todayDateString;
        }

        // Функции редактирования и удаления
        function editIncome(id) {
            const currentData = getCurrentYearData();
            if (!currentData || !currentData.income || !Array.isArray(currentData.income)) {
                console.log('Нет данных о доходах для редактирования');
                return;
            }

            const item = currentData.income.find(i => i.id === id);
            if (item) {
                // Проверяем права на редактирование с учетом даты
                if (!canEditRecord(item)) {
                    if (currentUser.role === 'admin') {
                        // Этого не должно произойти для админа
                        alert('Ошибка проверки прав доступа!');
                    } else if (item.user !== currentUser.username) {
                        alert('Вы можете редактировать только свои записи!');
                    } else {
                        alert('Вы можете редактировать записи только в день их создания!');
                    }
                    return;
                }

                // Заполнить форму данными для редактирования
                document.getElementById('incomeDate').value = item.date;
                document.getElementById('incomeWagon').value = item.wagon;
                document.getElementById('incomeCompany').value = item.company;
                document.getElementById('incomeWarehouse').value = item.warehouse;
                document.getElementById('incomeProduct').value = item.product;
                document.getElementById('incomeQtyDoc').value = item.qtyDoc;
                document.getElementById('incomeQtyFact').value = item.qtyFact;
                document.getElementById('incomeNotes').value = item.notes;

                // Пересчитать разницу и вес
                calculateIncomeDifference();

                // Удалить старую запись
                getCurrentYearData().income = getCurrentYearData().income.filter(i => i.id !== id);

                saveData();
                updateIncomeTable();
            }
        }

        function deleteIncome(id) {
            // Проверяем права на удаление (только администратор)
            if (currentUser.role !== 'admin') {
                alert('Только администратор может удалять записи!');
                return;
            }

            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                getCurrentYearData().income = getCurrentYearData().income.filter(i => i.id !== id);
                saveData();
                updateIncomeTable();
            }
        }

        function editExpense(id) {
            const item = getCurrentYearData().expense.find(i => i.id === id);
            if (item) {
                // Проверяем права на редактирование с учетом даты
                if (!canEditRecord(item)) {
                    if (currentUser.role === 'admin') {
                        // Этого не должно произойти для админа
                        alert('Ошибка проверки прав доступа!');
                    } else if (item.user !== currentUser.username) {
                        alert('Вы можете редактировать только свои записи!');
                    } else {
                        alert('Вы можете редактировать записи только в день их создания!');
                    }
                    return;
                }

                document.getElementById('expenseDate').value = item.date;
                document.getElementById('expenseCoalition').value = item.coalition || '';
                document.getElementById('expenseNumber').value = item.number || '';
                document.getElementById('expenseCompany').value = item.company;
                document.getElementById('expenseWarehouse').value = item.warehouse;
                document.getElementById('expenseProduct').value = item.product;
                document.getElementById('expenseClient').value = item.client;
                document.getElementById('expenseQuantity').value = item.quantity;
                document.getElementById('expensePrice').value = item.price;
                document.getElementById('expenseNotes').value = item.notes;

                // Пересчитать тонны и общую сумму
                calculateExpenseTotals();

                getCurrentYearData().expense = getCurrentYearData().expense.filter(i => i.id !== id);

                saveData();
                updateExpenseTable();
            }
        }

        function deleteExpense(id) {
            // Проверяем права на удаление (только администратор)
            if (currentUser.role !== 'admin') {
                alert('Только администратор может удалять записи!');
                return;
            }

            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                getCurrentYearData().expense = getCurrentYearData().expense.filter(i => i.id !== id);
                saveData();
                updateExpenseTable();
            }
        }

        function editPayment(id) {
            const item = getCurrentYearData().payments.find(i => i.id === id);
            if (item) {
                // Проверяем права на редактирование с учетом даты
                if (!canEditRecord(item)) {
                    if (currentUser.role === 'admin') {
                        // Этого не должно произойти для админа
                        alert('Ошибка проверки прав доступа!');
                    } else if (item.user !== currentUser.username) {
                        alert('Вы можете редактировать только свои записи!');
                    } else {
                        alert('Вы можете редактировать записи только в день их создания!');
                    }
                    return;
                }

                document.getElementById('paymentDate').value = item.date;
                document.getElementById('paymentClient').value = item.client;
                document.getElementById('paymentSomoni').value = item.somoni;
                document.getElementById('paymentRate').value = item.rate;
                document.getElementById('paymentNotes').value = item.notes;

                // Пересчитать сумму
                calculatePaymentAmount();

                getCurrentYearData().payments = getCurrentYearData().payments.filter(i => i.id !== id);

                saveData();
                updatePaymentsTable();
            }
        }

        function deletePayment(id) {
            // Проверяем права на удаление (только администратор)
            if (currentUser.role !== 'admin') {
                alert('Только администратор может удалять записи!');
                return;
            }

            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                getCurrentYearData().payments = getCurrentYearData().payments.filter(i => i.id !== id);
                saveData();
                updatePaymentsTable();
            }
        }

        function deleteProduct(index) {
            if (confirm('Вы уверены, что хотите удалить этот товар?')) {
                appData.products.splice(index, 1);
                saveData();
                updateProductDropdowns();
                updateManagementLists();
            }
        }

        function deleteCompany(index) {
            if (confirm('Вы уверены, что хотите удалить эту фирму?')) {
                appData.companies.splice(index, 1);
                saveData();
                updateCompanyDropdowns();
                updateManagementLists();
            }
        }

        function deleteWarehouse(index) {
            if (confirm('Вы уверены, что хотите удалить этот склад?')) {
                appData.warehouses.splice(index, 1);
                saveData();
                updateWarehouseDropdowns();
                updateManagementLists();
            }
        }

        function deleteWarehouseGroup(index) {
            if (confirm('Вы уверены, что хотите удалить эту подгруппу?')) {
                appData.warehouseGroups.splice(index, 1);
                saveData();
                updateWarehouseGroupDropdowns();
                updateManagementLists();
            }
        }

        function deleteClient(index) {
            if (confirm('Вы уверены, что хотите удалить этого клиента?')) {
                appData.clients.splice(index, 1);
                saveData();
                updateClientDropdowns();
                updateManagementLists();
            }
        }

        function editClient(index) {
            const client = appData.clients[index];
            const clientName = typeof client === 'string' ? client : client.name;
            const clientPhone = typeof client === 'string' ? '' : (client.phone || '');

            const newName = prompt('Введите новое имя клиента:', clientName);
            if (newName === null) return; // Отмена

            const newPhone = prompt('Введите телефон клиента:', clientPhone);
            if (newPhone === null) return; // Отмена

            if (newName.trim()) {
                // Проверяем, нет ли уже клиента с таким именем (кроме текущего)
                const existingIndex = appData.clients.findIndex((c, i) =>
                    i !== index && (typeof c === 'string' ? c : c.name) === newName.trim()
                );

                if (existingIndex === -1) {
                    appData.clients[index] = {
                        name: newName.trim(),
                        phone: newPhone.trim()
                    };
                    saveData();
                    updateClientDropdowns();
                    updateManagementLists();
                } else {
                    alert('Клиент с таким именем уже существует!');
                }
            }
        }

        function deleteCoalition(index) {
            if (confirm('Вы уверены, что хотите удалить эту коалицу?')) {
                appData.coalitions.splice(index, 1);
                saveData();
                updateCoalitionDropdowns();
                updateManagementLists();
            }
        }

        function deleteUser(index) {
            if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                appData.users.splice(index, 1);
                saveData();
                updateUsersTable();
            }
        }

        // Функции для редактирования групп пользователя
        function editUserGroups(username) {
            const user = appData.users.find(u => u.username === username);
            if (!user) {
                alert('Пользователь не найден!');
                return;
            }

            // Заполняем информацию о пользователе
            document.getElementById('editGroupsUsername').textContent = user.username;
            document.getElementById('editGroupsUserRole').textContent = getRoleText(user.role);

            // Заполняем селектор групп
            const select = document.getElementById('editUserGroupsSelect');
            select.innerHTML = '';
            
            appData.warehouseGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                
                // Проверяем, выбрана ли эта группа у пользователя
                const userGroups = Array.isArray(user.warehouseGroup) ? 
                    user.warehouseGroup : [user.warehouseGroup];
                if (userGroups.includes(group)) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });

            // Показываем модальное окно
            document.getElementById('editUserGroupsModal').style.display = 'flex';
        }

        function hideEditUserGroupsModal() {
            document.getElementById('editUserGroupsModal').style.display = 'none';
            document.getElementById('editUserGroupsForm').reset();
        }

        function handleEditUserGroupsSubmit(e) {
            e.preventDefault();
            
            const username = document.getElementById('editGroupsUsername').textContent;
            const user = appData.users.find(u => u.username === username);
            
            if (!user) {
                alert('Пользователь не найден!');
                return;
            }

            // Получаем выбранные группы
            const selectedGroups = Array.from(document.getElementById('editUserGroupsSelect').selectedOptions)
                .map(option => option.value);

            // Обновляем группы пользователя
            user.warehouseGroup = selectedGroups.length > 0 ? selectedGroups : [''];

            // Сохраняем изменения
            saveData();
            updateUsersTable();
            hideEditUserGroupsModal();

            // Показываем уведомление
            const groupsText = selectedGroups.length > 0 ? selectedGroups.join(', ') : 'нет групп';
            alert(`Группы пользователя ${username} обновлены:\n${groupsText}`);

            // Если редактируем текущего пользователя, обновляем интерфейс
            if (currentUser && currentUser.username === username) {
                currentUser.warehouseGroup = user.warehouseGroup;
                updateWarehouseDropdowns();
                updateProductDropdowns();
                updateCompanyDropdowns();
            }
        }

        // Отчёты
        function showReportFilters(reportType) {
            document.getElementById('reportFilters').classList.remove('hidden');
            document.getElementById('reportFilters').dataset.reportType = reportType;

            const titles = {
                'product-expense': 'Отчёт по расходу товаров',
                'product-income': 'Отчёт по приходу товаров',
                'client-expense': 'Расход по клиентам',
                'client-period': 'Расход по клиентам за период',
                'warehouse-report': 'Отчёт по складам',
                'payments-report': 'Отчёт по погашениям'
            };

            document.getElementById('reportTitle').textContent = titles[reportType];
        }

        function generateReport() {
            const reportType = document.getElementById('reportFilters').dataset.reportType;
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            const warehouse = document.getElementById('reportWarehouse').value;
            const client = document.getElementById('reportClient').value;

            let reportData = [];
            let reportHtml = '';

            switch (reportType) {
                case 'product-expense':
                    reportData = generateProductExpenseReport(dateFrom, dateTo, warehouse, client);
                    reportHtml = generateProductExpenseHtml(reportData);
                    break;
                case 'product-income':
                    reportData = generateProductIncomeReport(dateFrom, dateTo, warehouse);
                    reportHtml = generateProductIncomeHtml(reportData);
                    break;
                case 'client-expense':
                    reportData = generateClientExpenseReport(dateFrom, dateTo, client);
                    reportHtml = generateClientExpenseHtml(reportData);
                    break;
                case 'client-period':
                    reportData = generateClientPeriodReport(dateFrom, dateTo, client);
                    reportHtml = generateClientPeriodHtml(reportData);
                    break;
                case 'warehouse-report':
                    reportData = generateWarehouseReport(dateFrom, dateTo, warehouse);
                    reportHtml = generateWarehouseReportHtml(reportData);
                    break;
                case 'payments-report':
                    reportData = generatePaymentsReport(dateFrom, dateTo, client);
                    reportHtml = generatePaymentsReportHtml(reportData);
                    break;
            }

            document.getElementById('reportContent').innerHTML = reportHtml;
            document.getElementById('reportResults').classList.remove('hidden');
            document.getElementById('exportToExcel').classList.remove('hidden');
        }

        function generateProductExpenseReport(dateFrom, dateTo, warehouse, client) {
            let expense = getCurrentYearData().expense;

            // Фильтрация для завсклада - СНАЧАЛА по подгруппе
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            // Фильтрация по датам, складу и клиенту
            if (dateFrom || dateTo || warehouse || client) {
                expense = expense.filter(item => {
                    let match = true;
                    if (dateFrom && new Date(item.date) < new Date(dateFrom)) match = false;
                    if (dateTo && new Date(item.date) > new Date(dateTo)) match = false;
                    if (warehouse && item.warehouse !== warehouse) match = false;
                    if (client && item.client !== client) match = false;
                    return match;
                });
            }

            return expense;
        }

        function generateProductExpenseHtml(data) {
            let html = '<table class="w-full"><thead class="bg-gray-50"><tr>';
            html += '<th class="p-3 text-left">Дата</th>';
            html += '<th class="p-3 text-left">Товар</th>';
            html += '<th class="p-3 text-left">Фирма</th>';
            html += '<th class="p-3 text-left">Склад</th>';
            html += '<th class="p-3 text-left">Количество</th>';
            html += '<th class="p-3 text-left">Тонн</th>';
            html += '<th class="p-3 text-left">Цена</th>';
            html += '<th class="p-3 text-left">Сумма</th>';
            html += '<th class="p-3 text-left">Создал</th>';
            html += '</tr></thead><tbody>';

            let totalQuantity = 0;
            let totalTons = 0;
            let totalSum = 0;

            data.forEach(item => {
                totalQuantity += item.quantity;
                totalTons += item.tons || 0;
                totalSum += item.total;
                const editInfo = item.editedBy ? ` (изм: ${item.editedBy})` : '';

                html += `<tr>
                    <td class="p-3">${item.date}</td>
                    <td class="p-3">${item.product}</td>
                    <td class="p-3">${item.company}</td>
                    <td class="p-3">${item.warehouse}</td>
                    <td class="p-3">${item.quantity}</td>
                    <td class="p-3">${item.tons || ''}</td>
                    <td class="p-3">${item.price}</td>
                    <td class="p-3">${item.total.toFixed(2)}</td>
                    <td class="p-3">${item.user}${editInfo}</td>
                </tr>`;
            });

            // Добавляем итоговую строку
            html += `<tr class="bg-gray-100 font-semibold">
                <td colspan="4" class="p-3 text-right">ИТОГО:</td>
                <td class="p-3">${totalQuantity}</td>
                <td class="p-3">${totalTons.toFixed(2)}</td>
                <td class="p-3">-</td>
                <td class="p-3">${totalSum.toFixed(2)}</td>
                <td class="p-3">-</td>
            </tr>`;

            html += '</tbody></table>';
            return html;
        }

        function generateProductIncomeReport(dateFrom, dateTo, warehouse) {
            let income = getCurrentYearData().income;

            // Фильтрация для завсклада - СНАЧАЛА по подгруппе
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            if (dateFrom || dateTo || warehouse) {
                income = income.filter(item => {
                    let match = true;
                    if (dateFrom && new Date(item.date) < new Date(dateFrom)) match = false;
                    if (dateTo && new Date(item.date) > new Date(dateTo)) match = false;
                    if (warehouse && item.warehouse !== warehouse) match = false;
                    return match;
                });
            }

            return income;
        }

        function generateProductIncomeHtml(data) {
            let html = '<table class="w-full"><thead class="bg-gray-50"><tr>';
            html += '<th class="p-3 text-left">Дата</th>';
            html += '<th class="p-3 text-left">Товар</th>';
            html += '<th class="p-3 text-left">Фирма</th>';
            html += '<th class="p-3 text-left">Склад</th>';
            html += '<th class="p-3 text-left">Кол-во по док</th>';
            html += '<th class="p-3 text-left">Кол-во по факт</th>';
            html += '<th class="p-3 text-left">Разница</th>';
            html += '<th class="p-3 text-left">Кол-во факт тонн</th>';
            html += '</tr></thead><tbody>';

            let totalQtyDoc = 0;
            let totalQtyFact = 0;
            let totalDifference = 0;
            let totalTons = 0;

            data.forEach(item => {
                totalQtyDoc += item.qtyDoc;
                totalQtyFact += item.qtyFact;
                totalDifference += item.difference;
                totalTons += item.weightTons;

                html += `<tr>
                    <td class="p-3">${item.date}</td>
                    <td class="p-3">${item.product}</td>
                    <td class="p-3">${item.company}</td>
                    <td class="p-3">${item.warehouse}</td>
                    <td class="p-3">${item.qtyDoc}</td>
                    <td class="p-3">${item.qtyFact}</td>
                    <td class="p-3">${item.difference}</td>
                    <td class="p-3">${item.weightTons.toFixed(2)}</td>
                </tr>`;
            });

            // Добавляем итоговую строку
            html += `<tr class="bg-gray-100 font-semibold">
                <td colspan="4" class="p-3 text-right">ИТОГО:</td>
                <td class="p-3">${totalQtyDoc}</td>
                <td class="p-3">${totalQtyFact}</td>
                <td class="p-3">${totalDifference}</td>
                <td class="p-3">${totalTons.toFixed(2)}</td>
            </tr>`;

            html += '</tbody></table>';
            return html;
        }

        function generateClientExpenseReport(dateFrom, dateTo, client) {
            let expense = getCurrentYearData().expense;

            // Фильтрация для завсклада - СНАЧАЛА по подгруппе
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            if (dateFrom || dateTo || client) {
                expense = expense.filter(item => {
                    let match = true;
                    if (dateFrom && new Date(item.date) < new Date(dateFrom)) match = false;
                    if (dateTo && new Date(item.date) > new Date(dateTo)) match = false;
                    if (client && item.client !== client) match = false;
                    return match;
                });
            }

            return expense;
        }

        function generateClientExpenseHtml(data) {
            let html = '<table class="w-full"><thead class="bg-gray-50"><tr>';
            html += '<th class="p-3 text-left">Дата</th>';
            html += '<th class="p-3 text-left">Клиент</th>';
            html += '<th class="p-3 text-left">Товар</th>';
            html += '<th class="p-3 text-left">Фирма</th>';
            html += '<th class="p-3 text-left">Склад</th>';
            html += '<th class="p-3 text-left">Количество</th>';
            html += '<th class="p-3 text-left">Вес тонн</th>';
            html += '<th class="p-3 text-left">Цена</th>';
            html += '<th class="p-3 text-left">Сумма</th>';
            html += '</tr></thead><tbody>';

            let totalQuantity = 0;
            let totalTons = 0;
            let totalSum = 0;

            data.forEach(item => {
                totalQuantity += item.quantity;
                totalTons += item.tons;
                totalSum += item.total;

                html += `<tr>
                    <td class="p-3">${item.date}</td>
                    <td class="p-3">${item.client}</td>
                    <td class="p-3">${item.product}</td>
                    <td class="p-3">${item.company}</td>
                    <td class="p-3">${item.warehouse}</td>
                    <td class="p-3">${item.quantity}</td>
                    <td class="p-3">${item.tons.toFixed(2)}</td>
                    <td class="p-3">${item.price.toFixed(2)}</td>
                    <td class="p-3">${item.total.toFixed(2)}</td>
                </tr>`;
            });

            // Добавляем итоговую строку
            html += `<tr class="bg-gray-100 font-semibold">
                <td colspan="5" class="p-3 text-right">ИТОГО:</td>
                <td class="p-3">${totalQuantity}</td>
                <td class="p-3">${totalTons.toFixed(2)}</td>
                <td class="p-3">-</td>
                <td class="p-3">${totalSum.toFixed(2)}</td>
            </tr>`;

            html += '</tbody></table>';
            return html;
        }

        function generateClientPeriodReport(dateFrom, dateTo, client) {
            return generateClientExpenseReport(dateFrom, dateTo, client);
        }

        function generateClientPeriodHtml(data) {
            return generateClientExpenseHtml(data);
        }

        function generateWarehouseReport(dateFrom, dateTo, warehouse) {
            let income = getCurrentYearData().income;
            let expense = getCurrentYearData().expense;

            // Фильтрация для завсклада - СНАЧАЛА по подгруппе
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            if (dateFrom || dateTo || warehouse) {
                income = income.filter(item => {
                    let match = true;
                    if (dateFrom && new Date(item.date) < new Date(dateFrom)) match = false;
                    if (dateTo && new Date(item.date) > new Date(dateTo)) match = false;
                    if (warehouse && item.warehouse !== warehouse) match = false;
                    return match;
                });

                expense = expense.filter(item => {
                    let match = true;
                    if (dateFrom && new Date(item.date) < new Date(dateFrom)) match = false;
                    if (dateTo && new Date(item.date) > new Date(dateTo)) match = false;
                    if (warehouse && item.warehouse !== warehouse) match = false;
                    return match;
                });
            }

            return { income, expense };
        }

        function generateWarehouseReportHtml(data) {
            let html = '<div class="mb-6"><h4 class="text-lg font-semibold mb-4">Приход</h4>';
            html += '<table class="w-full mb-6"><thead class="bg-gray-50"><tr>';
            html += '<th class="p-3 text-left">Склад</th>';
            html += '<th class="p-3 text-left">Фирма</th>';
            html += '<th class="p-3 text-left">Товар</th>';
            html += '<th class="p-3 text-left">Количество</th>';
            html += '</tr></thead><tbody>';

            data.income.forEach(item => {
                html += `<tr>
                    <td class="p-3">${item.warehouse || 'Не указан'}</td>
                    <td class="p-3">${item.company || 'Не указана'}</td>
                    <td class="p-3">${item.product || 'Не указан'}</td>
                    <td class="p-3">${item.qtyFact || 0}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            html += '<div><h4 class="text-lg font-semibold mb-4">Расход</h4>';
            html += '<table class="w-full"><thead class="bg-gray-50"><tr>';
            html += '<th class="p-3 text-left">Склад</th>';
            html += '<th class="p-3 text-left">Фирма</th>';
            html += '<th class="p-3 text-left">Товар</th>';
            html += '<th class="p-3 text-left">Клиент</th>';
            html += '<th class="p-3 text-left">Количество</th>';
            html += '</tr></thead><tbody>';

            data.expense.forEach(item => {
                html += `<tr>
                    <td class="p-3">${item.warehouse || 'Не указан'}</td>
                    <td class="p-3">${item.company || 'Не указана'}</td>
                    <td class="p-3">${item.product || 'Не указан'}</td>
                    <td class="p-3">${item.client || 'Не указан'}</td>
                    <td class="p-3">${item.quantity || 0}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            return html;
        }

        function generatePaymentsReport(dateFrom, dateTo, client) {
            let payments = getCurrentYearData().payments;

            // Фильтрация по датам и клиенту (все пользователи видят все погашения)
            if (dateFrom || dateTo || client) {
                payments = payments.filter(item => {
                    let match = true;
                    if (dateFrom && new Date(item.date) < new Date(dateFrom)) match = false;
                    if (dateTo && new Date(item.date) > new Date(dateTo)) match = false;
                    if (client && item.client !== client) match = false;
                    return match;
                });
            }

            return payments;
        }

        function generatePaymentsReportHtml(data) {
            let html = '<table class="w-full"><thead class="bg-gray-50"><tr>';
            html += '<th class="p-3 text-left">Дата</th>';
            html += '<th class="p-3 text-left">Клиент</th>';
            html += '<th class="p-3 text-left">Сомони</th>';
            html += '<th class="p-3 text-left">Курс</th>';
            html += '<th class="p-3 text-left">Сумма ($)</th>';
            html += '<th class="p-3 text-left">Примечания</th>';
            html += '<th class="p-3 text-left">Создал</th>';
            html += '</tr></thead><tbody>';

            let totalSomoni = 0;
            let totalAmount = 0;

            data.forEach(item => {
                totalSomoni += item.somoni;
                totalAmount += item.amount;
                const editInfo = item.editedBy ? ` (изм: ${item.editedBy})` : '';

                html += `<tr>
                    <td class="p-3">${item.date}</td>
                    <td class="p-3">${item.client}</td>
                    <td class="p-3">${item.somoni.toFixed(2)}</td>
                    <td class="p-3">${item.rate.toFixed(2)}</td>
                    <td class="p-3">${item.amount.toFixed(2)}</td>
                    <td class="p-3">${item.notes || '-'}</td>
                    <td class="p-3">${item.user}${editInfo}</td>
                </tr>`;
            });

            // Добавляем итоговую строку
            html += `<tr class="bg-gray-100 font-semibold">
                <td colspan="2" class="p-3 text-right">ИТОГО:</td>
                <td class="p-3">${totalSomoni.toFixed(2)}</td>
                <td class="p-3">-</td>
                <td class="p-3">${totalAmount.toFixed(2)}</td>
                <td class="p-3">-</td>
                <td class="p-3">-</td>
            </tr>`;

            html += '</tbody></table>';
            return html;
        }

        // Резервное копирование
        function exportData() {
            // Подсчитываем общее количество записей по всем годам
            let totalIncome = 0, totalExpense = 0, totalPayments = 0;

            if (appData.years) {
                Object.values(appData.years).forEach(yearData => {
                    totalIncome += yearData.income ? yearData.income.length : 0;
                    totalExpense += yearData.expense ? yearData.expense.length : 0;
                    totalPayments += yearData.payments ? yearData.payments.length : 0;
                });
            }

            // Добавляем данные из старого формата если есть
            if (appData.income) totalIncome += appData.income.length;
            if (appData.expense) totalExpense += appData.expense.length;
            if (appData.payments) totalPayments += appData.payments.length;

            // Создаем полный экспорт с метаданными
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser ? currentUser.username : 'unknown',
                    version: '2.0',
                    currentYear: appData.currentYear || new Date().getFullYear(),
                    totalRecords: {
                        users: appData.users ? appData.users.length : 0,
                        products: appData.products ? appData.products.length : 0,
                        companies: appData.companies ? appData.companies.length : 0,
                        warehouses: appData.warehouses ? appData.warehouses.length : 0,
                        warehouseGroups: appData.warehouseGroups ? appData.warehouseGroups.length : 0,
                        clients: appData.clients ? appData.clients.length : 0,
                        years: appData.years ? Object.keys(appData.years).length : 0,
                        totalIncome: totalIncome,
                        totalExpense: totalExpense,
                        totalPayments: totalPayments
                    }
                },
                data: appData
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const username = currentUser ? currentUser.username : 'unknown';
            const dateStr = new Date().toISOString().split('T')[0];
            const timeStr = new Date().getTime();
            link.download = `backup_${username}_${dateStr}_${timeStr}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert(`Экспорт завершен!\nВсего записей: ${totalIncome + totalExpense + totalPayments}\nГодов данных: ${appData.years ? Object.keys(appData.years).length : 0}`);
        }

        // Экспорт всех данных в Excel
        function exportAllToExcel() {
            const workbook = createWorkbook();

            // Добавляем все листы
            addIncomeSheet(workbook);
            addExpenseSheet(workbook);
            addPaymentsSheet(workbook);
            addDebtReportSheet(workbook);
            addWagonSummarySheet(workbook);
            addBalanceSummarySheet(workbook);
            addWagonTotalsSheet(workbook);
            addManagementSheet(workbook);

            const username = currentUser ? currentUser.username : 'unknown';
            const dateStr = new Date().toISOString().split('T')[0];
            downloadExcel(workbook, `Полный_отчет_${username}_${dateStr}.xlsx`);
        }

        // Экспорт отдельного раздела в Excel
        function exportSectionToExcel(section) {
            const workbook = createWorkbook();
            const username = currentUser ? currentUser.username : 'unknown';
            const currentDate = new Date().toISOString().split('T')[0];

            switch (section) {
                case 'income':
                    addIncomeSheet(workbook);
                    downloadExcel(workbook, `Приход_${username}_${currentDate}.xlsx`);
                    break;
                case 'expense':
                    addExpenseSheet(workbook);
                    downloadExcel(workbook, `Расход_${username}_${currentDate}.xlsx`);
                    break;
                case 'payments':
                    addPaymentsSheet(workbook);
                    downloadExcel(workbook, `Погашения_${username}_${currentDate}.xlsx`);
                    break;
                case 'debt':
                    addDebtReportSheet(workbook);
                    downloadExcel(workbook, `Отчет_по_долгам_${username}_${currentDate}.xlsx`);
                    break;
                case 'wagonSummary':
                    addWagonSummarySheet(workbook);
                    downloadExcel(workbook, `Свод_вагонов_${username}_${currentDate}.xlsx`);
                    break;
                case 'balanceSummary':
                    addBalanceSummarySheet(workbook);
                    downloadExcel(workbook, `Свод_остатков_${username}_${currentDate}.xlsx`);
                    break;
                case 'wagonTotals':
                    addWagonTotalsSheet(workbook);
                    downloadExcel(workbook, `Итоги_вагонов_${username}_${currentDate}.xlsx`);
                    break;
                case 'management':
                    addManagementSheet(workbook);
                    downloadExcel(workbook, `Справочники_${username}_${currentDate}.xlsx`);
                    break;
            }
        }

        // Создание рабочей книги Excel
        function createWorkbook() {
            return {
                sheets: {},
                sheetNames: []
            };
        }

        // Добавление листа "Приход"
        function addIncomeSheet(workbook) {
            let income = appData.income;

            // Фильтрация для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            const headers = ['Дата', 'Вагон', 'Фирма', 'Склад', 'Товар', 'По док', 'Факт', 'Разница', 'Тонн', 'Примечания', 'Пользователь'];
            const data = [headers];

            income.forEach(item => {
                const editInfo = item.editedBy ? ` (изменено: ${item.editedBy})` : '';
                data.push([
                    item.date,
                    item.wagon,
                    item.company,
                    item.warehouse,
                    item.product,
                    item.qtyDoc,
                    item.qtyFact,
                    item.difference,
                    item.weightTons,
                    item.notes || '',
                    item.user + editInfo
                ]);
            });

            workbook.sheets['Приход'] = data;
            workbook.sheetNames.push('Приход');
        }

        // Добавление листа "Расход"
        function addExpenseSheet(workbook) {
            let expense = getCurrentYearData().expense;

            // Фильтрация для завсклада
            if (currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            const headers = ['Дата', 'Фирма', 'Склад', 'Товар', 'Клиент', 'Количество', 'Тонн', 'Цена', 'Сумма', 'Примечания', 'Пользователь'];
            const data = [headers];

            expense.forEach(item => {
                const editInfo = item.editedBy ? ` (изменено: ${item.editedBy})` : '';
                data.push([
                    item.date,
                    item.company,
                    item.warehouse,
                    item.product,
                    item.client,
                    item.quantity,
                    item.tons,
                    item.price,
                    item.total,
                    item.notes || '',
                    item.user + editInfo
                ]);
            });

            workbook.sheets['Расход'] = data;
            workbook.sheetNames.push('Расход');
        }

        // Добавление листа "Погашения"
        function addPaymentsSheet(workbook) {
            const headers = ['Дата', 'Клиент', 'Сомони', 'Курс', 'Сумма', 'Примечания', 'Пользователь'];
            const data = [headers];

            getCurrentYearData().payments.forEach(item => {
                const editInfo = item.editedBy ? ` (изменено: ${item.editedBy})` : '';
                data.push([
                    item.date,
                    item.client,
                    item.somoni,
                    item.rate,
                    item.amount,
                    item.notes || '',
                    item.user + editInfo
                ]);
            });

            workbook.sheets['Погашения'] = data;
            workbook.sheetNames.push('Погашения');
        }

        // Добавление листа "Отчет по долгам"
        function addDebtReportSheet(workbook) {
            const clientDebts = {};

            // Подсчёт задолженности по расходам
            getCurrentYearData().expense.forEach(item => {
                if (!clientDebts[item.client]) {
                    clientDebts[item.client] = { total: 0, paid: 0 };
                }
                clientDebts[item.client].total += item.total;
            });

            // Подсчёт погашений
            getCurrentYearData().payments.forEach(item => {
                if (!clientDebts[item.client]) {
                    clientDebts[item.client] = { total: 0, paid: 0 };
                }
                clientDebts[item.client].paid += item.amount;
            });

            const headers = ['Клиент', 'Общая задолженность', 'Погашено', 'Остаток долга'];
            const data = [headers];

            Object.keys(clientDebts).forEach(client => {
                const debt = clientDebts[client];
                const remaining = debt.total - debt.paid;
                data.push([
                    client,
                    debt.total.toFixed(2),
                    debt.paid.toFixed(2),
                    remaining.toFixed(2)
                ]);
            });

            workbook.sheets['Отчет по долгам'] = data;
            workbook.sheetNames.push('Отчет по долгам');
        }

        // Добавление листа "Свод вагонов"
        function addWagonSummarySheet(workbook) {
            let income = getCurrentYearData().income;

            // Фильтрация для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            const headers = ['Вагон', 'Фирма', 'Склад', 'Товар', 'По док', 'Факт', 'Тонн'];
            const data = [headers];

            income.forEach(item => {
                data.push([
                    item.wagon,
                    item.company,
                    item.warehouse,
                    item.product,
                    item.qtyDoc,
                    item.qtyFact,
                    item.weightTons
                ]);
            });

            workbook.sheets['Свод вагонов'] = data;
            workbook.sheetNames.push('Свод вагонов');
        }

        // Добавление листа "Свод остатков"
        function addBalanceSummarySheet(workbook) {
            const summary = {};

            // Обработка прихода
            let income = getCurrentYearData().income;
            let expense = getCurrentYearData().expense;

            // Фильтрация для завсклада
            if (currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
                expense = expense.filter(item => userWarehouses.includes(item.warehouse));
            }

            income.forEach(item => {
                const key = `${item.warehouse}-${item.company}-${item.product}`;
                if (!summary[key]) {
                    summary[key] = {
                        warehouse: item.warehouse,
                        company: item.company,
                        product: item.product,
                        income: 0,
                        expense: 0
                    };
                }
                summary[key].income += item.qtyFact;
            });

            // Обработка расхода
            expense.forEach(item => {
                const key = `${item.warehouse}-${item.company}-${item.product}`;
                if (!summary[key]) {
                    summary[key] = {
                        warehouse: item.warehouse,
                        company: item.company,
                        product: item.product,
                        income: 0,
                        expense: 0
                    };
                }
                summary[key].expense += item.quantity;
            });

            const headers = ['Склад', 'Фирма', 'Товар', 'Приход', 'Расход', 'Остаток', 'Остаток тонн'];
            const data = [headers];

            Object.values(summary).forEach(item => {
                const balance = item.income - item.expense;
                const balanceTons = balance / 20;
                data.push([
                    item.warehouse,
                    item.company,
                    item.product,
                    item.income,
                    item.expense,
                    balance,
                    balanceTons.toFixed(2)
                ]);
            });

            workbook.sheets['Свод остатков'] = data;
            workbook.sheetNames.push('Свод остатков');
        }

        // Добавление листа "Итоги вагонов"
        function addWagonTotalsSheet(workbook) {
            const totals = {};

            let income = getCurrentYearData().income;

            // Фильтрация для завсклада
            if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                const userWarehouses = getUserWarehouseNames();
                income = income.filter(item => userWarehouses.includes(item.warehouse));
            }

            income.forEach(item => {
                const key = `${item.product}-${item.company}-${item.warehouse}`;
                if (!totals[key]) {
                    totals[key] = {
                        product: item.product,
                        company: item.company,
                        warehouse: item.warehouse,
                        wagons: 0,
                        qtyDoc: 0,
                        qtyFact: 0,
                        weightTons: 0
                    };
                }
                totals[key].wagons++;
                totals[key].qtyDoc += item.qtyDoc;
                totals[key].qtyFact += item.qtyFact;
                totals[key].weightTons += item.weightTons;
            });

            const headers = ['Товар', 'Фирма', 'Склад', 'Количество вагонов', 'Приход по док', 'Приход по факт', 'Вес тонн'];
            const data = [headers];

            Object.values(totals).forEach(item => {
                data.push([
                    item.product,
                    item.company,
                    item.warehouse,
                    item.wagons,
                    item.qtyDoc,
                    item.qtyFact,
                    item.weightTons.toFixed(2)
                ]);
            });

            workbook.sheets['Итоги вагонов'] = data;
            workbook.sheetNames.push('Итоги вагонов');
        }

        // Добавление листа "Справочники"
        function addManagementSheet(workbook) {
            // Товары
            const productsData = [['Товары'], ...appData.products.map(p => [p])];

            // Фирмы
            const companiesData = [['Фирмы'], ...appData.companies.map(c => [c])];

            // Склады
            const warehousesData = [['Склады', 'Подгруппа'], ...appData.warehouses.map(w => [w.name, w.group])];

            // Клиенты
            const clientsData = [['Клиенты'], ...appData.clients.map(c => [c])];

            // Подгруппы складов
            const groupsData = [['Подгруппы складов'], ...appData.warehouseGroups.map(g => [g])];

            // Объединяем все данные в один лист
            const data = [
                ['СПРАВОЧНИКИ'],
                [],
                ...productsData,
                [],
                ...companiesData,
                [],
                ...warehousesData,
                [],
                ...clientsData,
                [],
                ...groupsData
            ];

            workbook.sheets['Справочники'] = data;
            workbook.sheetNames.push('Справочники');
        }

        // Скачивание Excel файла с полным форматированием
        function downloadExcel(workbook, filename) {
            // Создаем HTML таблицы для каждого листа
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${filename}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .sheet { margin-bottom: 40px; page-break-after: always; }
                        .sheet-title { 
                            font-size: 18px; 
                            font-weight: bold; 
                            margin-bottom: 15px; 
                            color: #2563eb;
                            border-bottom: 2px solid #2563eb;
                            padding-bottom: 5px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 20px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        th { 
                            background-color: #f3f4f6; 
                            border: 1px solid #d1d5db; 
                            padding: 12px 8px; 
                            text-align: left;
                            font-weight: bold;
                            color: #374151;
                        }
                        td { 
                            border: 1px solid #d1d5db; 
                            padding: 8px; 
                            vertical-align: top;
                        }
                        tr:nth-child(even) { background-color: #f9fafb; }
                        tr:hover { background-color: #f3f4f6; }
                        .total-row { 
                            background-color: #dbeafe !important; 
                            font-weight: bold;
                        }
                        .section-header {
                            background-color: #1f2937 !important;
                            color: white !important;
                            text-align: center;
                            font-size: 14px;
                        }
                        .numeric { text-align: right; }
                        .date { text-align: center; }
                        @media print {
                            .sheet { page-break-after: always; }
                            body { margin: 10px; }
                        }
                    </style>
                </head>
                <body>
            `;

            workbook.sheetNames.forEach((sheetName, index) => {
                htmlContent += `<div class="sheet">`;
                htmlContent += `<h2 class="sheet-title">${sheetName}</h2>`;

                const sheet = workbook.sheets[sheetName];
                if (sheet && sheet.length > 0) {
                    htmlContent += `<table>`;

                    sheet.forEach((row, rowIndex) => {
                        const isHeader = rowIndex === 0;
                        const isTotalRow = row.some(cell => String(cell).toLowerCase().includes('итого'));
                        const isSectionHeader = row.length === 1 && String(row[0]).toUpperCase() === String(row[0]);

                        let rowClass = '';
                        if (isTotalRow) rowClass = 'total-row';
                        if (isSectionHeader) rowClass = 'section-header';

                        htmlContent += `<tr class="${rowClass}">`;

                        row.forEach((cell, cellIndex) => {
                            const cellValue = String(cell || '');
                            const tag = isHeader ? 'th' : 'td';

                            // Определяем класс для ячейки
                            let cellClass = '';
                            if (!isHeader && !isSectionHeader) {
                                if (isNumeric(cellValue)) cellClass = 'numeric';
                                else if (isDate(cellValue)) cellClass = 'date';
                            }

                            // Для заголовков секций объединяем ячейки
                            const colspan = isSectionHeader ? ` colspan="${row.length > 1 ? row.length : sheet[0]?.length || 1}"` : '';

                            htmlContent += `<${tag} class="${cellClass}"${colspan}>${formatCellValue(cellValue)}</${tag}>`;
                        });

                        htmlContent += `</tr>`;
                    });

                    htmlContent += `</table>`;
                } else {
                    htmlContent += `<p>Нет данных для отображения</p>`;
                }

                htmlContent += `</div>`;
            });

            htmlContent += `
                    <div style="margin-top: 40px; text-align: center; color: #6b7280; font-size: 12px;">
                        <p>Отчет создан: ${new Date().toLocaleString('ru-RU')}</p>
                        <p>Система учёта товаров</p>
                    </div>
                </body>
                </html>
            `;

            // Создаем и скачиваем файл
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename.replace('.xlsx', '.html'));
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Вспомогательные функции для форматирования
        function isNumeric(value) {
            return !isNaN(parseFloat(value)) && isFinite(value) && value !== '';
        }

        function isDate(value) {
            const datePattern = /^\d{1,2}\.\d{1,2}\.\d{4}$/;
            return datePattern.test(value);
        }

        function formatCellValue(value) {
            if (value === null || value === undefined) return '';

            const strValue = String(value);

            // Форматирование чисел
            if (isNumeric(strValue)) {
                const num = parseFloat(strValue);
                return num % 1 === 0 ? num.toString() : num.toFixed(2);
            }

            // Экранирование HTML
            return strValue
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Конвертация рабочей книги в CSV (резервный вариант)
        function convertWorkbookToCSV(workbook) {
            let csvContent = '\uFEFF'; // BOM для корректного отображения кириллицы

            workbook.sheetNames.forEach((sheetName, index) => {
                if (index > 0) csvContent += '\n\n';
                csvContent += `"=== ${sheetName} ==="\n`;

                const sheet = workbook.sheets[sheetName];
                sheet.forEach(row => {
                    const csvRow = row.map(cell => {
                        const cellStr = String(cell || '');
                        // Экранирование кавычек и запятых
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n') || cellStr.includes(';')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(',');
                    csvContent += csvRow + '\n';
                });
            });

            return csvContent;
        }

        // Альтернативный экспорт в CSV
        function downloadCSV(workbook, filename) {
            const csvContent = convertWorkbookToCSV(workbook);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename.replace('.xlsx', '.csv'));
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) {
                showErrorMessage('Выберите файл для импорта');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const fileContent = JSON.parse(e.target.result);

                    // Проверяем формат файла
                    let importedData;
                    if (fileContent.metadata && fileContent.data) {
                        // Новый формат с метаданными
                        importedData = fileContent.data;
                    } else {
                        // Старый формат без метаданных
                        importedData = fileContent;
                    }

                    // Выполняем умный импорт только новых записей
                    const importResult = performSmartImport(importedData);

                    if (importResult.hasNewData) {
                        saveData();
                        showImportResults(importResult);
                        // Обновляем интерфейс
                        updateDropdowns();
                        if (document.getElementById('dashboard').classList.contains('hidden') === false) {
                            updateDashboard();
                        }
                    } else {
                        showWarningMessage('Новых данных для импорта не найдено');
                    }

                } catch (error) {
                    console.error('Import error:', error);
                    showErrorMessage('Ошибка при импорте данных: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function performSmartImport(importedData) {
            const result = {
                hasNewData: false,
                newRecords: {
                    users: [],
                    products: [],
                    companies: [],
                    warehouses: [],
                    warehouseGroups: [],
                    clients: [],
                    years: {},
                    totalIncome: 0,
                    totalExpense: 0,
                    totalPayments: 0
                },
                duplicates: {
                    users: 0,
                    products: 0,
                    companies: 0,
                    warehouses: 0,
                    warehouseGroups: 0,
                    clients: 0,
                    income: 0,
                    expense: 0,
                    payments: 0
                }
            };

            // Импорт пользователей (кроме admin)
            if (importedData.users) {
                importedData.users.forEach(user => {
                    if (user.username !== 'admin' && !appData.users.find(u => u.username === user.username)) {
                        appData.users.push(user);
                        result.newRecords.users.push(user);
                        result.hasNewData = true;
                    } else if (user.username !== 'admin') {
                        result.duplicates.users++;
                    }
                });
            }

            // Импорт товаров
            if (importedData.products) {
                importedData.products.forEach(product => {
                    // Проверяем, есть ли уже товар с таким названием (регистронезависимо)
                    const existingProduct = appData.products.find(existingProduct => 
                        existingProduct.toLowerCase() === product.toLowerCase()
                    );
                    
                    if (!existingProduct) {
                        appData.products.push(product);
                        result.newRecords.products.push(product);
                        result.hasNewData = true;
                    } else {
                        result.duplicates.products++;
                    }
                });
            }

            // Импорт фирм
            if (importedData.companies) {
                importedData.companies.forEach(company => {
                    // Проверяем, есть ли уже фирма с таким названием (регистронезависимо)
                    const existingCompany = appData.companies.find(existingCompany => 
                        existingCompany.toLowerCase() === company.toLowerCase()
                    );
                    
                    if (!existingCompany) {
                        appData.companies.push(company);
                        result.newRecords.companies.push(company);
                        result.hasNewData = true;
                    } else {
                        result.duplicates.companies++;
                    }
                });
            }

            // Импорт подгрупп складов
            if (importedData.warehouseGroups) {
                importedData.warehouseGroups.forEach(group => {
                    if (!appData.warehouseGroups.includes(group)) {
                        appData.warehouseGroups.push(group);
                        result.newRecords.warehouseGroups.push(group);
                        result.hasNewData = true;
                    } else {
                        result.duplicates.warehouseGroups++;
                    }
                });
            }

            // Импорт складов
            if (importedData.warehouses) {
                importedData.warehouses.forEach(warehouse => {
                    if (!appData.warehouses.find(w => w.name === warehouse.name)) {
                        appData.warehouses.push(warehouse);
                        result.newRecords.warehouses.push(warehouse);
                        result.hasNewData = true;
                    } else {
                        result.duplicates.warehouses++;
                    }
                });
            }

            // Импорт клиентов
            if (importedData.clients) {
                importedData.clients.forEach(client => {
                    // Получаем имя клиента (поддержка старого и нового формата)
                    const clientName = typeof client === 'string' ? client : client.name;
                    
                    // Проверяем, есть ли уже клиент с таким именем
                    const existingClient = appData.clients.find(existingClient => {
                        const existingName = typeof existingClient === 'string' ? existingClient : existingClient.name;
                        return existingName === clientName;
                    });
                    
                    if (!existingClient) {
                        appData.clients.push(client);
                        result.newRecords.clients.push(client);
                        result.hasNewData = true;
                    } else {
                        result.duplicates.clients++;
                    }
                });
            }

            // Инициализируем структуру годов если её нет
            if (!appData.years) {
                appData.years = {};
            }
            if (!appData.currentYear) {
                appData.currentYear = new Date().getFullYear();
            }

            // Импорт данных по годам
            if (importedData.years) {
                Object.keys(importedData.years).forEach(year => {
                    const yearData = importedData.years[year];

                    // Создаем год если его нет
                    if (!appData.years[year]) {
                        appData.years[year] = { income: [], expense: [], payments: [] };
                        result.newRecords.years[year] = { income: [], expense: [], payments: [] };
                    }

                    // Импорт приходов года
                    if (yearData.income) {
                        yearData.income.forEach(income => {
                            const exists = appData.years[year].income.find(i =>
                                i.wagon === income.wagon &&
                                i.date === income.date &&
                                i.company === income.company &&
                                i.warehouse === income.warehouse &&
                                i.product === income.product
                            );

                            if (!exists) {
                                const newIncome = { ...income, id: Date.now() + Math.random() };
                                appData.years[year].income.push(newIncome);
                                if (!result.newRecords.years[year]) result.newRecords.years[year] = { income: [], expense: [], payments: [] };
                                result.newRecords.years[year].income.push(newIncome);
                                result.newRecords.totalIncome++;
                                result.hasNewData = true;
                            } else {
                                result.duplicates.income++;
                            }
                        });
                    }

                    // Импорт расходов года
                    if (yearData.expense) {
                        yearData.expense.forEach(expense => {
                            const exists = appData.years[year].expense.find(e =>
                                e.date === expense.date &&
                                e.company === expense.company &&
                                e.warehouse === expense.warehouse &&
                                e.product === expense.product &&
                                e.client === expense.client &&
                                e.quantity === expense.quantity
                            );

                            if (!exists) {
                                const newExpense = { ...expense, id: Date.now() + Math.random() };
                                appData.years[year].expense.push(newExpense);
                                if (!result.newRecords.years[year]) result.newRecords.years[year] = { income: [], expense: [], payments: [] };
                                result.newRecords.years[year].expense.push(newExpense);
                                result.newRecords.totalExpense++;
                                result.hasNewData = true;
                            } else {
                                result.duplicates.expense++;
                            }
                        });
                    }

                    // Импорт погашений года
                    if (yearData.payments) {
                        yearData.payments.forEach(payment => {
                            const exists = appData.years[year].payments.find(p =>
                                p.date === payment.date &&
                                p.client === payment.client &&
                                p.somoni === payment.somoni &&
                                p.rate === payment.rate
                            );

                            if (!exists) {
                                const newPayment = { ...payment, id: Date.now() + Math.random() };
                                appData.years[year].payments.push(newPayment);
                                if (!result.newRecords.years[year]) result.newRecords.years[year] = { income: [], expense: [], payments: [] };
                                result.newRecords.years[year].payments.push(newPayment);
                                result.newRecords.totalPayments++;
                                result.hasNewData = true;
                            } else {
                                result.duplicates.payments++;
                            }
                        });
                    }
                });
            }

            // Импорт старого формата данных (без годов) - добавляем в текущий год
            const currentYear = appData.currentYear.toString();
            if (!appData.years[currentYear]) {
                appData.years[currentYear] = { income: [], expense: [], payments: [] };
            }

            // Импорт приходов старого формата
            if (importedData.income && !importedData.years) {
                importedData.income.forEach(income => {
                    const exists = appData.years[currentYear].income.find(i =>
                        i.wagon === income.wagon &&
                        i.date === income.date &&
                        i.company === income.company &&
                        i.warehouse === income.warehouse &&
                        i.product === income.product
                    );

                    if (!exists) {
                        const newIncome = { ...income, id: Date.now() + Math.random() };
                        appData.years[currentYear].income.push(newIncome);
                        result.newRecords.totalIncome++;
                        result.hasNewData = true;
                    } else {
                        result.duplicates.income++;
                    }
                });
            }

            // Импорт расходов старого формата
            if (importedData.expense && !importedData.years) {
                importedData.expense.forEach(expense => {
                    const exists = appData.years[currentYear].expense.find(e =>
                        e.date === expense.date &&
                        e.company === expense.company &&
                        e.warehouse === expense.warehouse &&
                        e.product === expense.product &&
                        e.client === expense.client &&
                        e.quantity === expense.quantity
                    );

                    if (!exists) {
                        const newExpense = { ...expense, id: Date.now() + Math.random() };
                        appData.years[currentYear].expense.push(newExpense);
                        result.newRecords.totalExpense++;
                        result.hasNewData = true;
                    } else {
                        result.duplicates.expense++;
                    }
                });
            }

            // Импорт погашений старого формата
            if (importedData.payments && !importedData.years) {
                importedData.payments.forEach(payment => {
                    const exists = appData.years[currentYear].payments.find(p =>
                        p.date === payment.date &&
                        p.client === payment.client &&
                        p.somoni === payment.somoni &&
                        p.rate === payment.rate
                    );

                    if (!exists) {
                        const newPayment = { ...payment, id: Date.now() + Math.random() };
                        appData.years[currentYear].payments.push(newPayment);
                        result.newRecords.totalPayments++;
                        result.hasNewData = true;
                    } else {
                        result.duplicates.payments++;
                    }
                });
            }

            return result;
        }

        function showImportResults(result) {
            const content = document.getElementById('importResultContent');
            let html = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">✅ Импорт завершен успешно!</h3>
                    <p class="text-green-700">Новые данные были добавлены в систему.</p>
                </div>
            `;

            // Показываем статистику новых записей
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

            // Новые записи
            html += '<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">';
            html += '<h4 class="font-semibold text-blue-800 mb-3">📥 Добавлено новых записей:</h4>';
            html += '<div class="space-y-2 text-sm">';

            // Каталоги
            const catalogLabels = {
                users: 'Пользователи',
                products: 'Товары',
                companies: 'Фирмы',
                warehouses: 'Склады',
                warehouseGroups: 'Подгруппы складов',
                clients: 'Клиенты'
            };

            Object.keys(catalogLabels).forEach(key => {
                const count = result.newRecords[key] ? result.newRecords[key].length : 0;
                if (count > 0) {
                    html += `<div class="flex justify-between"><span>${catalogLabels[key]}:</span><span class="font-semibold text-blue-600">${count}</span></div>`;
                }
            });

            // Операции
            if (result.newRecords.totalIncome > 0) {
                html += `<div class="flex justify-between"><span>Приходы:</span><span class="font-semibold text-green-600">${result.newRecords.totalIncome}</span></div>`;
            }
            if (result.newRecords.totalExpense > 0) {
                html += `<div class="flex justify-between"><span>Расходы:</span><span class="font-semibold text-red-600">${result.newRecords.totalExpense}</span></div>`;
            }
            if (result.newRecords.totalPayments > 0) {
                html += `<div class="flex justify-between"><span>Погашения:</span><span class="font-semibold text-orange-600">${result.newRecords.totalPayments}</span></div>`;
            }

            // Годы
            if (result.newRecords.years && Object.keys(result.newRecords.years).length > 0) {
                html += '<div class="mt-3 pt-3 border-t border-blue-300">';
                html += '<div class="font-semibold text-blue-800 mb-2">По годам:</div>';
                Object.keys(result.newRecords.years).forEach(year => {
                    const yearData = result.newRecords.years[year];
                    const totalYear = yearData.income.length + yearData.expense.length + yearData.payments.length;
                    if (totalYear > 0) {
                        html += `<div class="flex justify-between text-xs"><span>${year} год:</span><span class="font-semibold">${totalYear} записей</span></div>`;
                    }
                });
                html += '</div>';
            }

            html += '</div></div>';

            // Дубликаты
            html += '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">';
            html += '<h4 class="font-semibold text-yellow-800 mb-3">⚠️ Пропущено дубликатов:</h4>';
            html += '<div class="space-y-2 text-sm">';

            const duplicateLabels = {
                users: 'Пользователи',
                products: 'Товары',
                companies: 'Фирмы',
                warehouses: 'Склады',
                warehouseGroups: 'Подгруппы складов',
                clients: 'Клиенты',
                income: 'Приходы',
                expense: 'Расходы',
                payments: 'Погашения'
            };

            Object.keys(duplicateLabels).forEach(key => {
                const count = result.duplicates[key];
                if (count > 0) {
                    html += `<div class="flex justify-between"><span>${duplicateLabels[key]}:</span><span class="font-semibold text-yellow-600">${count}</span></div>`;
                }
            });

            html += '</div></div>';
            html += '</div>';

            // Детальная информация о новых записях
            html += '<div class="mt-6">';
            html += '<h4 class="font-semibold mb-3">📋 Детальная информация о новых записях:</h4>';

            Object.keys(result.newRecords).forEach(key => {
                const records = result.newRecords[key];
                if (records.length > 0) {
                    const labels = {
                        users: 'Пользователи',
                        products: 'Товары',
                        companies: 'Фирмы',
                        warehouses: 'Склады',
                        warehouseGroups: 'Подгруппы складов',
                        clients: 'Клиенты',
                        income: 'Приходы',
                        expense: 'Расходы',
                        payments: 'Погашения'
                    };

                    html += `<div class="mb-4 p-3 bg-gray-50 rounded">`;
                    html += `<h5 class="font-medium mb-2">${labels[key]} (${records.length}):</h5>`;
                    html += `<div class="text-sm text-gray-600 max-h-32 overflow-y-auto">`;

                    records.forEach((record, index) => {
                        if (index < 10) { // Показываем только первые 10 записей
                            let displayText = '';
                            switch (key) {
                                case 'users':
                                    displayText = `${record.username} (${record.role})`;
                                    break;
                                case 'warehouses':
                                    displayText = `${record.name} (${record.group})`;
                                    break;
                                case 'income':
                                    displayText = `Вагон ${record.wagon}, ${record.product}, ${record.warehouse}`;
                                    break;
                                case 'expense':
                                    displayText = `${record.product} → ${record.client}, ${record.warehouse}`;
                                    break;
                                case 'payments':
                                    displayText = `${record.client}: ${record.somoni} сом. (${record.amount}$)`;
                                    break;
                                default:
                                    displayText = typeof record === 'string' ? record : JSON.stringify(record);
                            }
                            html += `<div>• ${displayText}</div>`;
                        }
                    });

                    if (records.length > 10) {
                        html += `<div class="text-gray-500 italic">... и еще ${records.length - 10} записей</div>`;
                    }

                    html += `</div></div>`;
                }
            });

            html += '</div>';

            content.innerHTML = html;
            document.getElementById('importResultModal').classList.remove('hidden');
        }

        function closeImportResultModal() {
            document.getElementById('importResultModal').classList.add('hidden');
        }

        function clearDatabase(type) {
            let confirmMessage = '';
            let actionMessage = '';

            switch (type) {
                case 'operations':
                    confirmMessage = 'Вы уверены, что хотите очистить все операции (приходы, расходы, погашения)? Это действие нельзя отменить!';
                    actionMessage = 'Операции очищены';
                    break;
                case 'catalogs':
                    confirmMessage = 'Вы уверены, что хотите очистить все каталоги (фирмы, склады, товары, клиенты)? Это действие нельзя отменить!';
                    actionMessage = 'Каталоги очищены';
                    break;
                case 'all':
                    confirmMessage = 'Вы уверены, что хотите очистить ВСЮ базу данных? Останется только пользователь admin. Это действие нельзя отменить!';
                    actionMessage = 'База данных полностью очищена';
                    break;
            }

            if (confirm(confirmMessage)) {
                if (confirm('Последнее предупреждение! Данные будут удалены безвозвратно!')) {

                    switch (type) {
                        case 'operations':
                            // Очищаем только операции (все годы)
                            if (appData.years) {
                                Object.keys(appData.years).forEach(year => {
                                    appData.years[year] = { income: [], expense: [], payments: [] };
                                });
                            }
                            // Очищаем старый формат если есть
                            if (appData.income) appData.income = [];
                            if (appData.expense) appData.expense = [];
                            if (appData.payments) appData.payments = [];
                            break;

                        case 'catalogs':
                            // Очищаем только каталоги - делаем пустые списки
                            appData.products = [];
                            appData.companies = [];
                            appData.warehouses = [];
                            appData.warehouseGroups = [];
                            appData.clients = [];
                            // Удаляем всех пользователей кроме admin
                            appData.users = appData.users.filter(user => user.username === 'admin');
                            break;

                        case 'all':
                            // Полная очистка - все каталоги пустые, но сохраняем всех пользователей по умолчанию
                            appData = {
                                users: [
                                    { username: 'admin', password: 'P0l1uret@n@', role: 'admin', warehouseGroup: '', blocked: false },
                                    { username: 'tillo', password: '123456', role: 'warehouse', warehouseGroup: 'Сугд' },
                                    { username: 'abdullo', password: '123456', role: 'warehouse', warehouseGroup: 'Хисор' },
                                    { username: 'firdavs', password: '123456', role: 'cashier', warehouseGroup: '' },
                                    { username: 'dillik0807', password: '123456', role: 'admin', warehouseGroup: '' },
                                    { username: 'sorbon', password: '123456', role: 'admin', warehouseGroup: '' }
                                ],
                                products: [],
                                companies: [],
                                warehouses: [],
                                warehouseGroups: [],
                                clients: [],
                                years: {},
                                currentYear: new Date().getFullYear()
                            };
                            break;
                    }

                    saveData();
                    showSuccessMessage(actionMessage);
                    location.reload();
                }
            }
        }

        // Функции для работы с накладной
        function openInvoiceModal() {
            console.log('Открытие модального окна накладной');

            const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
            console.log('Найдено выбранных чекбоксов:', selectedCheckboxes.length);

            if (selectedCheckboxes.length === 0) {
                alert('Выберите документы для создания накладной.\n\nИнструкция:\n1. Перейдите в раздел "Расход"\n2. Поставьте галочки на нужных документах\n3. Нажмите "Создать накладную"');
                return;
            }

            // Проверить, что все выбранные документы принадлежат одному клиенту
            const clients = new Set();
            selectedCheckboxes.forEach(checkbox => {
                clients.add(checkbox.dataset.client);
            });

            if (clients.size > 1) {
                alert('Выберите документы только одного клиента');
                return;
            }

            // Заполнить выпадающий список клиентов
            const invoiceClientSelect = document.getElementById('invoiceClient');
            invoiceClientSelect.innerHTML = '<option value="">Выберите клиента</option>';
            appData.clients.forEach(client => {
                const clientName = typeof client === 'string' ? client : client.name;
                const clientPhone = typeof client === 'string' ? '' : (client.phone || '');
                const displayText = clientPhone ? `${clientName} (${clientPhone})` : clientName;
                const selected = clients.has(clientName) ? 'selected' : '';
                invoiceClientSelect.innerHTML += `<option value="${clientName}" ${selected}>${displayText}</option>`;
            });

            filterExpensesByClient();
            document.getElementById('invoiceModal').classList.remove('hidden');
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
            // Снять выделение с чекбоксов
            document.querySelectorAll('.expense-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllExpense').checked = false;
        }

        function closePrintModal() {
            document.getElementById('printModal').classList.add('hidden');
        }

        function toggleSelectAllExpense() {
            const selectAll = document.getElementById('selectAllExpense');
            const checkboxes = document.querySelectorAll('.expense-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function filterExpensesByClient() {
            const selectedClient = document.getElementById('invoiceClient').value;
            const selectedExpensesContent = document.getElementById('selectedExpensesContent');

            if (!selectedClient) {
                selectedExpensesContent.innerHTML = '<p class="text-gray-500">Выберите клиента</p>';
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
            const selectedExpenses = [];

            selectedCheckboxes.forEach(checkbox => {
                if (checkbox.dataset.client === selectedClient) {
                    const index = parseInt(checkbox.dataset.index);
                    const yearData = getCurrentYearData();
                    let filteredExpenses = yearData.expense;

                    // Применяем фильтрацию для завсклада
                    if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                        const userWarehouses = getUserWarehouseNames();
                        filteredExpenses = filteredExpenses.filter(item => userWarehouses.includes(item.warehouse));
                    }

                    if (filteredExpenses[index]) {
                        selectedExpenses.push(filteredExpenses[index]);
                    }
                }
            });

            if (selectedExpenses.length === 0) {
                selectedExpensesContent.innerHTML = '<p class="text-gray-500">Нет выбранных документов для данного клиента</p>';
                return;
            }

            // Группировка по складам
            const warehouseGroups = {};
            selectedExpenses.forEach(expense => {
                if (!warehouseGroups[expense.warehouse]) {
                    warehouseGroups[expense.warehouse] = [];
                }
                warehouseGroups[expense.warehouse].push(expense);
            });

            let html = '';
            Object.keys(warehouseGroups).forEach(warehouse => {
                html += `
                    <div class="border rounded p-4">
                        <h4 class="font-semibold text-lg mb-3">Склад: ${warehouse}</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-2 text-left">Дата</th>
                                        <th class="p-2 text-left">Товар</th>
                                        <th class="p-2 text-left">Количество</th>
                                        <th class="p-2 text-left">Тонн</th>
                                        <th class="p-2 text-left">Цена</th>
                                        <th class="p-2 text-left">Сумма</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                let warehouseTotal = 0;
                warehouseGroups[warehouse].forEach(expense => {
                    warehouseTotal += expense.total;
                    html += `
                        <tr>
                            <td class="p-2">${expense.date}</td>
                            <td class="p-2">${expense.product}</td>
                            <td class="p-2">${expense.quantity}</td>
                            <td class="p-2">${expense.tons}</td>
                            <td class="p-2">${expense.price}</td>
                            <td class="p-2">${expense.total}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                                <tfoot class="bg-gray-100">
                                    <tr>
                                        <td colspan="5" class="p-2 font-semibold text-right">Итого по складу:</td>
                                        <td class="p-2 font-semibold">${warehouseTotal.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
            });

            selectedExpensesContent.innerHTML = html;
        }

        function generateInvoice() {
            console.log('Генерация накладной');

            const selectedClient = document.getElementById('invoiceClient').value;
            console.log('Выбранный клиент:', selectedClient);

            if (!selectedClient) {
                alert('Выберите клиента из выпадающего списка');
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('.expense-checkbox:checked');
            const selectedExpenses = [];

            selectedCheckboxes.forEach(checkbox => {
                if (checkbox.dataset.client === selectedClient) {
                    const index = parseInt(checkbox.dataset.index);
                    const yearData = getCurrentYearData();
                    let filteredExpenses = yearData.expense;

                    // Применяем фильтрацию для завсклада
                    if (currentUser && currentUser.role === 'warehouse' && currentUser.warehouseGroup) {
                        const userWarehouses = getUserWarehouseNames();
                        filteredExpenses = filteredExpenses.filter(item => userWarehouses.includes(item.warehouse));
                    }

                    if (filteredExpenses[index]) {
                        selectedExpenses.push(filteredExpenses[index]);
                    }
                }
            });

            if (selectedExpenses.length === 0) {
                alert('Нет выбранных документов для создания накладной');
                return;
            }

            // Сохраняем данные накладной для экспорта
            currentInvoiceData = {
                client: selectedClient,
                expenses: selectedExpenses
            };

            generateInvoiceContent(selectedClient, selectedExpenses);
            document.getElementById('invoiceModal').classList.add('hidden');
            document.getElementById('printModal').classList.remove('hidden');
        }

        function generateInvoiceContent(client, expenses) {
            const invoiceNumber = `РН-${Date.now()}`;
            const currentDate = new Date().toLocaleDateString('ru-RU');
            const currentUser = getCurrentUserName();

            // Группировка по складам
            const warehouseGroups = {};
            expenses.forEach(expense => {
                if (!warehouseGroups[expense.warehouse]) {
                    warehouseGroups[expense.warehouse] = [];
                }
                warehouseGroups[expense.warehouse].push(expense);
            });

            let html = `
                <div class="max-w-4xl mx-auto p-8 bg-white">
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-bold mb-2">РАСХОДНАЯ НАКЛАДНАЯ</h1>
                        <p class="text-lg">№ ${invoiceNumber} от ${currentDate}</p>
                    </div>
                    
                    <div class="mb-6">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <p><strong>Клиент:</strong> ${client}</p>
                                <p><strong>Дата составления:</strong> ${currentDate}</p>
                            </div>
                            <div>
                                <p><strong>Составил:</strong> ${currentUser}</p>
                                <p><strong>Номер накладной:</strong> ${invoiceNumber}</p>
                            </div>
                        </div>
                    </div>
            `;

            let grandTotal = 0;
            let itemNumber = 1;

            Object.keys(warehouseGroups).forEach(warehouse => {
                html += `
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 bg-gray-100 p-2">Склад: ${warehouse}</h3>
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 p-2 text-left">№</th>
                                    <th class="border border-gray-300 p-2 text-left">Дата</th>
                                    <th class="border border-gray-300 p-2 text-left">Наименование товара</th>
                                    <th class="border border-gray-300 p-2 text-left">Количество</th>
                                    <th class="border border-gray-300 p-2 text-left">Тонн</th>
                                    <th class="border border-gray-300 p-2 text-left">Цена за ед.</th>
                                    <th class="border border-gray-300 p-2 text-left">Сумма</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                let warehouseTotal = 0;
                warehouseGroups[warehouse].forEach(expense => {
                    warehouseTotal += expense.total;
                    html += `
                        <tr>
                            <td class="border border-gray-300 p-2">${itemNumber++}</td>
                            <td class="border border-gray-300 p-2">${expense.date}</td>
                            <td class="border border-gray-300 p-2">${expense.product}</td>
                            <td class="border border-gray-300 p-2">${expense.quantity}</td>
                            <td class="border border-gray-300 p-2">${expense.tons}</td>
                            <td class="border border-gray-300 p-2">${expense.price}</td>
                            <td class="border border-gray-300 p-2">${expense.total.toFixed(2)}</td>
                        </tr>
                    `;
                });

                grandTotal += warehouseTotal;

                html += `
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 font-semibold">
                                    <td colspan="6" class="border border-gray-300 p-2 text-right">Итого по складу ${warehouse}:</td>
                                    <td class="border border-gray-300 p-2">${warehouseTotal.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            });

            html += `
                    <div class="mt-8">
                        <div class="text-right">
                            <p class="text-xl font-bold">ОБЩАЯ СУММА: ${grandTotal.toFixed(2)} сом.</p>
                        </div>
                    </div>
                    
                    <div class="mt-12 grid grid-cols-2 gap-8">
                        <div>
                            <p class="mb-8">Отпустил: ________________</p>
                            <p class="text-sm">(подпись, ФИО)</p>
                        </div>
                        <div>
                            <p class="mb-8">Получил: ________________</p>
                            <p class="text-sm">(подпись, ФИО)</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center text-sm text-gray-600">
                        <p>Накладная создана в системе учёта товаров</p>
                        <p>Дата и время создания: ${new Date().toLocaleString('ru-RU')}</p>
                    </div>
                </div>
            `;

            document.getElementById('invoiceContent').innerHTML = html;
        }

        function getCurrentUserName() {
            return currentUser ? currentUser.username : 'Неизвестный пользователь';
        }

        function printInvoice() {
            window.print();
        }

        function exportInvoiceToExcel() {
            if (!currentInvoiceData) {
                alert('Нет данных накладной для экспорта');
                return;
            }

            const client = currentInvoiceData.client;
            const selectedExpenses = currentInvoiceData.expenses;
            const wb = XLSX.utils.book_new();

            const warehouseGroups = {};
            selectedExpenses.forEach(expense => {
                if (!warehouseGroups[expense.warehouse]) {
                    warehouseGroups[expense.warehouse] = [];
                }
                warehouseGroups[expense.warehouse].push(expense);
            });

            const invoiceNumber = `РН-${Date.now()}`;
            const currentDate = new Date().toLocaleDateString('ru-RU');
            const currentUserName = getCurrentUserName();

            const summaryData = [
                ['РАСХОДНАЯ НАКЛАДНАЯ'],
                [`№ ${invoiceNumber} от ${currentDate}`],
                [''],
                ['Клиент:', client],
                ['Дата составления:', currentDate],
                ['Составил:', currentUserName],
                ['']
            ];

            let grandTotal = 0;
            Object.keys(warehouseGroups).forEach(warehouse => {
                const warehouseTotal = warehouseGroups[warehouse].reduce((sum, expense) => sum + expense.total, 0);
                grandTotal += warehouseTotal;
                summaryData.push([`Склад ${warehouse}:`, warehouseTotal.toFixed(2) + ' сом.']);
            });

            summaryData.push(['']);
            summaryData.push(['ОБЩАЯ СУММА:', grandTotal.toFixed(2) + ' сом.']);

            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Сводка');

            Object.keys(warehouseGroups).forEach(warehouse => {
                const expenses = warehouseGroups[warehouse];
                const headers = ['№', 'Дата', 'Товар', 'Количество', 'Цена', 'Сумма'];
                const data = [headers];

                let itemNumber = 1;
                let warehouseTotal = 0;

                expenses.forEach(expense => {
                    warehouseTotal += expense.total;
                    data.push([
                        itemNumber++,
                        expense.date,
                        expense.product,
                        expense.quantity,
                        expense.price,
                        expense.total.toFixed(2)
                    ]);
                });

                data.push(['', '', '', '', 'ИТОГО:', warehouseTotal.toFixed(2)]);

                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [
                    { wch: 5 }, { wch: 12 }, { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 12 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, warehouse);
            });

            const username = currentUser ? currentUser.username : 'unknown';
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `Накладная_${client}_${username}_${dateStr}.xlsx`;

            XLSX.writeFile(wb, fileName);
        }

        // Создаем рабочую книгу Excel
        const wb = XLSX.utils.book_new();

        // Группируем по складам
        const warehouseGroups = {};
        selectedExpenses.forEach(expense => {
            if (!warehouseGroups[expense.warehouse]) {
                warehouseGroups[expense.warehouse] = [];
            }
            warehouseGroups[expense.warehouse].push(expense);
        });

        // Создаем общий лист с информацией о накладной
        const invoiceNumber = `РН-${Date.now()}`;
        const currentDate = new Date().toLocaleDateString('ru-RU');
        const currentUserName = getCurrentUserName();

        // Создаем красивую таблицу для накладной
        const summaryData = [
            // Заголовок накладной
            ['', '', 'РАСХОДНАЯ НАКЛАДНАЯ', '', ''],
            ['', '', `№ ${invoiceNumber} от ${currentDate}`, '', ''],
            ['', '', '', '', ''],

            // Основная информация в табличном виде
            ['Параметр', 'Значение', '', 'Параметр', 'Значение'],
            ['Клиент:', client, '', 'Номер накладной:', invoiceNumber],
            ['Дата составления:', currentDate, '', 'Составил:', currentUserName],
            ['', '', '', '', ''],

            // Заголовок для итогов по складам
            ['', '', 'ИТОГИ ПО СКЛАДАМ', '', ''],
            ['Склад', 'Сумма (сом.)', '', '', '']
        ];

        // Добавляем итоги по складам в табличном виде
        let grandTotal = 0;
        Object.keys(warehouseGroups).forEach(warehouse => {
            const warehouseTotal = warehouseGroups[warehouse].reduce((sum, expense) => sum + expense.total, 0);
            grandTotal += warehouseTotal;
            summaryData.push([warehouse, warehouseTotal.toFixed(2), '', '', '']);
        });

        // Добавляем общую сумму
        summaryData.push(['', '', '', '', '']);
        summaryData.push(['ОБЩАЯ СУММА:', grandTotal.toFixed(2), '', '', '']);
        summaryData.push(['', '', '', '', '']);

        // Добавляем поля для подписей
        summaryData.push(['', '', 'ПОДПИСИ', '', '']);
        summaryData.push(['Отпустил:', '________________', '', 'Получил:', '________________']);
        summaryData.push(['(подпись, ФИО)', '', '', '(подпись, ФИО)', '']);

        const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);

        // Настраиваем ширину колонок
        summaryWs['!cols'] = [
            { wch: 20 },  // Параметр/Склад
            { wch: 25 },  // Значение/Сумма
            { wch: 5 },   // Пустая колонка
            { wch: 20 },  // Параметр
            { wch: 25 }   // Значение
        ];

        // Объединяем ячейки для заголовков
        summaryWs['!merges'] = [
            { s: { r: 0, c: 2 }, e: { r: 0, c: 4 } }, // РАСХОДНАЯ НАКЛАДНАЯ
            { s: { r: 1, c: 2 }, e: { r: 1, c: 4 } }, // Номер и дата
            { s: { r: 7, c: 2 }, e: { r: 7, c: 4 } }, // ИТОГИ ПО СКЛАДАМ
            { s: { r: summaryData.length - 3, c: 2 }, e: { r: summaryData.length - 3, c: 4 } } // ПОДПИСИ
        ];

        XLSX.utils.book_append_sheet(wb, summaryWs, 'Расходная накладная');

        // Создаем отдельный лист для каждого склада
        Object.keys(warehouseGroups).forEach(warehouse => {
            const expenses = warehouseGroups[warehouse];

            // Создаем заголовок накладной для каждого склада
            const data = [
                ['', '', 'РАСХОДНАЯ НАКЛАДНАЯ', '', '', '', ''],
                ['', '', `№ ${invoiceNumber} от ${currentDate}`, '', '', '', ''],
                ['', '', `Клиент: ${client}`, '', '', '', ''],
                ['', '', `Склад: ${warehouse}`, '', '', '', ''],
                ['', '', '', '', '', '', ''],
                ['№', 'Дата', 'Наименование товара', 'Количество', 'Тонн', 'Цена за ед.', 'Сумма']
            ];

            let itemNumber = 1;
            let warehouseTotal = 0;

            expenses.forEach(expense => {
                warehouseTotal += expense.total;
                data.push([
                    itemNumber++,
                    expense.date,
                    expense.product,
                    expense.quantity,
                    expense.tons,
                    expense.price,
                    expense.total.toFixed(2)
                ]);
            });

            // Добавляем итого
            data.push(['', '', '', '', '', 'ИТОГО:', warehouseTotal.toFixed(2)]);

            const ws = XLSX.utils.aoa_to_sheet(data);

            // Устанавливаем ширину колонок
            ws['!cols'] = [
                { wch: 5 },   // №
                { wch: 12 },  // Дата
                { wch: 25 },  // Наименование
                { wch: 12 },  // Количество
                { wch: 10 },  // Тонн
                { wch: 12 },  // Цена
                { wch: 12 }   // Сумма
            ];

            // Объединяем ячейки для заголовков
            ws['!merges'] = [
                { s: { r: 0, c: 2 }, e: { r: 0, c: 6 } }, // РАСХОДНАЯ НАКЛАДНАЯ
                { s: { r: 1, c: 2 }, e: { r: 1, c: 6 } }, // Номер и дата
                { s: { r: 2, c: 2 }, e: { r: 2, c: 6 } }, // Клиент
                { s: { r: 3, c: 2 }, e: { r: 3, c: 6 } }  // Склад
            ];

            XLSX.utils.book_append_sheet(wb, ws, `Склад ${warehouse}`);
        });

        // Сохраняем файл
        const username = currentUser ? currentUser.username : 'unknown';


        // Функция для добавления тестовых данных расходов
        function addTestExpenseData() {
            const yearData = getCurrentYearData();

            // Добавляем тестовые расходы если их нет
            if (yearData.expense.length === 0) {
                const testExpenses = [
                    {
                        id: Date.now() + 1,
                        date: new Date().toISOString().split('T')[0],
                        coalition: '',
                        number: '001',
                        company: 'ООО ТарговыйДом',
                        warehouse: 'Спитамен',
                        product: 'Навои Карбамид',
                        client: 'Коалица',
                        quantity: 100,
                        tons: 5,
                        price: 1000,
                        total: 100000,
                        user: currentUser.username
                    },
                    {
                        id: Date.now() + 2,
                        date: new Date().toISOString().split('T')[0],
                        coalition: '',
                        number: '002',
                        company: 'ООО Сахад',
                        warehouse: 'Хисор Шавкат',
                        product: 'Фаргона Селитра',
                        client: 'Коалица',
                        quantity: 50,
                        tons: 2.5,
                        price: 1200,
                        total: 60000,
                        user: currentUser.username
                    }
                ];

                testExpenses.forEach(expense => {
                    yearData.expense.push(expense);
                });

                saveData();
                updateExpenseTable();
                updateDashboard();

                alert('Добавлены тестовые данные расходов для проверки накладной');
            } else {
                alert('Данные расходов уже есть');
            }
        }

        // Функции для работы с кассовым ордером
        function openCashOrderModal() {
            const selectedCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Выберите погашения для создания кассового ордера');
                return;
            }

            // Проверить, что все выбранные погашения принадлежат одному клиенту
            const clients = new Set();
            selectedCheckboxes.forEach(checkbox => {
                clients.add(checkbox.dataset.client);
            });

            if (clients.size > 1) {
                alert('Выберите погашения только одного клиента');
                return;
            }

            // Заполнить выпадающий список клиентов
            const cashOrderClientSelect = document.getElementById('cashOrderClient');
            cashOrderClientSelect.innerHTML = '<option value="">Выберите клиента</option>';
            appData.clients.forEach(client => {
                const clientName = typeof client === 'string' ? client : client.name;
                const clientPhone = typeof client === 'string' ? '' : (client.phone || '');
                const displayText = clientPhone ? `${clientName} (${clientPhone})` : clientName;
                const selected = clients.has(clientName) ? 'selected' : '';
                cashOrderClientSelect.innerHTML += `<option value="${clientName}" ${selected}>${displayText}</option>`;
            });

            filterPaymentsByClient();
            document.getElementById('cashOrderModal').classList.remove('hidden');
        }

        function closeCashOrderModal() {
            document.getElementById('cashOrderModal').classList.add('hidden');
            // Снять выделение с чекбоксов
            document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllPayments').checked = false;
        }

        function closePrintCashOrderModal() {
            document.getElementById('printCashOrderModal').classList.add('hidden');
        }

        function toggleSelectAllPayments() {
            const selectAll = document.getElementById('selectAllPayments');
            const checkboxes = document.querySelectorAll('.payment-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function filterPaymentsByClient() {
            const selectedClient = document.getElementById('cashOrderClient').value;
            const selectedPaymentsContent = document.getElementById('selectedPaymentsContent');

            if (!selectedClient) {
                selectedPaymentsContent.innerHTML = '<p class="text-gray-500">Выберите клиента</p>';
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
            const selectedPayments = [];

            selectedCheckboxes.forEach(checkbox => {
                if (checkbox.dataset.client === selectedClient) {
                    const index = parseInt(checkbox.dataset.index);
                    const yearData = getCurrentYearData();
                    let filteredPayments = yearData.payments;

                    if (filteredPayments[index]) {
                        selectedPayments.push(filteredPayments[index]);
                    }
                }
            });

            if (selectedPayments.length === 0) {
                selectedPaymentsContent.innerHTML = '<p class="text-gray-500">Нет выбранных погашений для данного клиента</p>';
                return;
            }

            let html = `
                <div class="border rounded p-4">
                    <h4 class="font-semibold text-lg mb-3">Погашения клиента: ${selectedClient}</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2 text-left">№</th>
                                    <th class="p-2 text-left">Дата</th>
                                    <th class="p-2 text-left">Сомони</th>
                                    <th class="p-2 text-left">Курс</th>
                                    <th class="p-2 text-left">Сумма</th>
                                    <th class="p-2 text-left">Примечания</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            let totalSomoni = 0;
            let totalAmount = 0;
            selectedPayments.forEach((payment, index) => {
                totalSomoni += payment.somoni;
                totalAmount += payment.amount;
                html += `
                    <tr>
                        <td class="p-2">${index + 1}</td>
                        <td class="p-2">${payment.date}</td>
                        <td class="p-2">${payment.somoni}</td>
                        <td class="p-2">${payment.rate}</td>
                        <td class="p-2">${payment.amount}</td>
                        <td class="p-2">${payment.notes || '-'}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td colspan="2" class="p-2 font-semibold text-right">Итого:</td>
                                    <td class="p-2 font-semibold">${totalSomoni.toFixed(2)}</td>
                                    <td class="p-2">-</td>
                                    <td class="p-2 font-semibold">${totalAmount.toFixed(2)}</td>
                                    <td class="p-2">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;

            selectedPaymentsContent.innerHTML = html;
        }

        function generateCashOrder() {
            const selectedClient = document.getElementById('cashOrderClient').value;
            if (!selectedClient) {
                alert('Выберите клиента');
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('.payment-checkbox:checked');
            const selectedPayments = [];

            selectedCheckboxes.forEach(checkbox => {
                if (checkbox.dataset.client === selectedClient) {
                    const index = parseInt(checkbox.dataset.index);
                    const yearData = getCurrentYearData();
                    let filteredPayments = yearData.payments;

                    if (filteredPayments[index]) {
                        selectedPayments.push(filteredPayments[index]);
                    }
                }
            });

            if (selectedPayments.length === 0) {
                alert('Нет выбранных погашений для создания кассового ордера');
                return;
            }

            // Сохраняем данные кассового ордера для экспорта
            currentCashOrderData = {
                client: selectedClient,
                payments: selectedPayments
            };

            generateCashOrderContent(selectedClient, selectedPayments);
            document.getElementById('cashOrderModal').classList.add('hidden');
            document.getElementById('printCashOrderModal').classList.remove('hidden');
        }

        function generateCashOrderContent(client, payments) {
            const orderNumber = `РКО-${Date.now()}`;
            const currentDate = new Date().toLocaleDateString('ru-RU');
            const currentUser = getCurrentUserName();

            let totalSomoni = 0;
            let totalAmount = 0;
            payments.forEach(payment => {
                totalSomoni += payment.somoni;
                totalAmount += payment.amount;
            });

            let html = `
                <div class="max-w-4xl mx-auto p-8 bg-white">
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-bold mb-2">РАСХОДНЫЙ КАССОВЫЙ ОРДЕР</h1>
                        <p class="text-lg">№ ${orderNumber} от ${currentDate}</p>
                    </div>
                    
                    <div class="mb-8">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <p class="mb-2"><strong>Выдать:</strong> ${client}</p>
                                <p class="mb-2"><strong>Основание:</strong> Погашение задолженности</p>
                                <p class="mb-2"><strong>Приложение:</strong> ${payments.length} документ(ов)</p>
                            </div>
                            <div>
                                <p class="mb-2"><strong>Кассир:</strong> ${currentUser}</p>
                                <p class="mb-2"><strong>Дата:</strong> ${currentDate}</p>
                                <p class="mb-2"><strong>Номер ордера:</strong> ${orderNumber}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">Детализация погашений:</h3>
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 p-3 text-left">№</th>
                                    <th class="border border-gray-300 p-3 text-left">Дата погашения</th>
                                    <th class="border border-gray-300 p-3 text-left">Сумма в сомони</th>
                                    <th class="border border-gray-300 p-3 text-left">Курс</th>
                                    <th class="border border-gray-300 p-3 text-left">Сумма в долларах</th>
                                    <th class="border border-gray-300 p-3 text-left">Примечания</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            payments.forEach((payment, index) => {
                html += `
                    <tr>
                        <td class="border border-gray-300 p-3">${index + 1}</td>
                        <td class="border border-gray-300 p-3">${payment.date}</td>
                        <td class="border border-gray-300 p-3">${payment.somoni.toFixed(2)}</td>
                        <td class="border border-gray-300 p-3">${payment.rate.toFixed(2)}</td>
                        <td class="border border-gray-300 p-3">${payment.amount.toFixed(2)}</td>
                        <td class="border border-gray-300 p-3">${payment.notes || '-'}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-100 font-semibold">
                                    <td colspan="2" class="border border-gray-300 p-3 text-right">ИТОГО:</td>
                                    <td class="border border-gray-300 p-3">${totalSomoni.toFixed(2)}</td>
                                    <td class="border border-gray-300 p-3">-</td>
                                    <td class="border border-gray-300 p-3">${totalAmount.toFixed(2)}</td>
                                    <td class="border border-gray-300 p-3">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mb-8">
                        <div class="border border-gray-300 p-4">
                            <p class="mb-2"><strong>Сумма прописью:</strong></p>
                            <p class="text-lg">${numberToWords(totalAmount)} долларов США</p>
                            <p class="text-lg">${numberToWords(totalSomoni)} сомони</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div>
                            <p class="mb-8">Выдал кассир: ________________</p>
                            <p class="text-sm">(подпись, ФИО)</p>
                        </div>
                        <div>
                            <p class="mb-8">Получил: ________________</p>
                            <p class="text-sm">(подпись, ФИО)</p>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <p class="text-sm"><strong>По документам:</strong></p>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <div>
                                <p class="text-sm">Паспорт: ________________</p>
                                <p class="text-sm">Выдан: ________________</p>
                            </div>
                            <div>
                                <p class="text-sm">Дата выдачи: ________________</p>
                                <p class="text-sm">Адрес: ________________</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center text-sm text-gray-600">
                        <p>Кассовый ордер создан в системе учёта товаров</p>
                        <p>Дата и время создания: ${new Date().toLocaleString('ru-RU')}</p>
                    </div>
                </div>
            `;

            document.getElementById('cashOrderContent').innerHTML = html;
        }

        function numberToWords(num) {
            // Простая функция для преобразования числа в слова (базовая реализация)
            const ones = ['', 'один', 'два', 'три', 'четыре', 'пять', 'шесть', 'семь', 'восемь', 'девять'];
            const teens = ['десять', 'одиннадцать', 'двенадцать', 'тринадцать', 'четырнадцать', 'пятнадцать', 'шестнадцать', 'семнадцать', 'восемнадцать', 'девятнадцать'];
            const tens = ['', '', 'двадцать', 'тридцать', 'сорок', 'пятьдесят', 'шестьдесят', 'семьдесят', 'восемьдесят', 'девяносто'];
            const hundreds = ['', 'сто', 'двести', 'триста', 'четыреста', 'пятьсот', 'шестьсот', 'семьсот', 'восемьсот', 'девятьсот'];

            if (num === 0) return 'ноль';

            const integer = Math.floor(num);
            const decimal = Math.round((num - integer) * 100);

            let result = '';

            if (integer >= 1000) {
                const thousands = Math.floor(integer / 1000);
                result += convertHundreds(thousands) + ' тысяч ';
            }

            result += convertHundreds(integer % 1000);

            if (decimal > 0) {
                result += ` ${decimal}/100`;
            }

            return result.trim();

            function convertHundreds(n) {
                let str = '';

                if (n >= 100) {
                    str += hundreds[Math.floor(n / 100)] + ' ';
                    n %= 100;
                }

                if (n >= 20) {
                    str += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                } else if (n >= 10) {
                    str += teens[n - 10] + ' ';
                    n = 0;
                }

                if (n > 0) {
                    str += ones[n] + ' ';
                }

                return str.trim();
            }
        }

        function printCashOrder() {
            window.print();
        }

        function exportCashOrderToExcel() {
            console.log('Экспорт кассового ордера в Excel');

            if (!currentCashOrderData) {
                alert('Нет данных кассового ордера для экспорта.\n\nСначала создайте кассовый ордер:\n1. Выберите погашения\n2. Создайте кассовый ордер\n3. Затем экспортируйте');
                return;
            }

            const client = currentCashOrderData.client;
            const selectedPayments = currentCashOrderData.payments;

            // Создаем рабочую книгу Excel
            const wb = XLSX.utils.book_new();

            const orderNumber = `РКО-${Date.now()}`;
            const currentDate = new Date().toLocaleDateString('ru-RU');
            const currentUserName = getCurrentUserName();

            // Создаем главный лист с информацией о кассовом ордере
            const mainData = [
                ['РАСХОДНЫЙ КАССОВЫЙ ОРДЕР'],
                [`№ ${orderNumber} от ${currentDate}`],
                [`Клиент: ${client}`, '', '', '', `Составил: ${currentUserName}`],
                [''],
                ['№', 'Дата', 'Сомони', 'Курс', 'Сумма ($)', 'Примечания']
            ];

            let itemNumber = 1;
            let totalSomoni = 0;
            let totalAmount = 0;

            // Добавляем все погашения в таблицу
            selectedPayments.forEach(payment => {
                totalSomoni += payment.somoni;
                totalAmount += payment.amount;
                mainData.push([
                    itemNumber++,
                    payment.date,
                    payment.somoni,
                    payment.rate,
                    payment.amount.toFixed(2),
                    payment.notes || ''
                ]);
            });

            // Добавляем итоги
            mainData.push(['']);
            mainData.push(['ИТОГО:', '', totalSomoni.toFixed(2), '', totalAmount.toFixed(2), '']);
            mainData.push(['']);
            mainData.push(['Выдал: ________________', '', '', 'Получил: ________________']);
            mainData.push(['(подпись, ФИО)', '', '', '(подпись, ФИО)']);

            const mainWs = XLSX.utils.aoa_to_sheet(mainData);

            // Настраиваем ширину колонок
            mainWs['!cols'] = [
                { wch: 8 },   // №
                { wch: 12 },  // Дата
                { wch: 12 },  // Сомони
                { wch: 10 },  // Курс
                { wch: 12 },  // Сумма
                { wch: 25 }   // Примечания
            ];

            XLSX.utils.book_append_sheet(wb, mainWs, 'Кассовый ордер');

            // Создаем детальный лист с дополнительной информацией
            const detailData = [
                ['ДЕТАЛИЗАЦИЯ ПОГАШЕНИЙ'],
                [`Клиент: ${client}`],
                [`Дата составления: ${currentDate}`],
                [`Составил: ${currentUserName}`],
                [''],
                ['№', 'Дата погашения', 'Сомони', 'Курс доллара', 'Сумма в долларах', 'Примечания', 'Кто добавил']
            ];

            let detailNumber = 1;
            selectedPayments.forEach(payment => {
                detailData.push([
                    detailNumber++,
                    payment.date,
                    payment.somoni.toFixed(2),
                    payment.rate.toFixed(2),
                    payment.amount.toFixed(2),
                    payment.notes || '',
                    payment.user || ''
                ]);
            });

            // Добавляем итоги
            detailData.push(['']);
            detailData.push(['ОБЩИЕ ИТОГИ:']);
            detailData.push(['Всего сомони:', totalSomoni.toFixed(2)]);
            detailData.push(['Всего долларов:', totalAmount.toFixed(2)]);
            detailData.push(['Количество операций:', selectedPayments.length]);

            const detailWs = XLSX.utils.aoa_to_sheet(detailData);

            // Настраиваем ширину колонок для детального листа
            detailWs['!cols'] = [
                { wch: 8 },   // №
                { wch: 12 },  // Дата
                { wch: 12 },  // Сомони
                { wch: 12 },  // Курс
                { wch: 15 },  // Сумма
                { wch: 25 },  // Примечания
                { wch: 15 }   // Пользователь
            ];

            XLSX.utils.book_append_sheet(wb, detailWs, 'Детализация');

            // Сохраняем файл
            const username = currentUser ? currentUser.username : 'unknown';
            const dateStr = new Date().toISOString().split('T')[0];
            const fileName = `Кассовый_ордер_${client}_${username}_${dateStr}.xlsx`;

            XLSX.writeFile(wb, fileName);
            console.log('Файл Excel сохранен:', fileName);
        }

        // Сохранение и загрузка данных
        function saveData() {
            localStorage.setItem('retailAppData', JSON.stringify(appData));
            console.log('Данные автоматически сохранены');

            // Автоматическая синхронизация с Firebase
            if (isFirebaseConnected && window.firebaseDB) {
                syncToCloudSilent();
            }
        }

        // Автосохранение каждые 30 секунд
        function startAutoSave() {
            setInterval(() => {
                if (currentUser) {
                    saveData();
                }
            }, 30000); // 30 секунд
        }

        // Автосохранение при изменении полей ввода
        function setupAutoSave() {
            // Автосохранение при изменении любого поля ввода
            document.addEventListener('input', function (e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    // Сохраняем с задержкой, чтобы не сохранять при каждом символе
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(() => {
                        if (currentUser) {
                            saveData();
                        }
                    }, 2000); // 2 секунды после последнего изменения
                }
            });
        }

        // Автосохранение при закрытии страницы
        function setupBeforeUnloadSave() {
            window.addEventListener('beforeunload', function (e) {
                if (currentUser) {
                    saveData();
                }
            });
        }

        function loadData() {
            const savedData = localStorage.getItem('retailAppData');
            if (savedData) {
                appData = JSON.parse(savedData);

                // Проверяем и исправляем структуру данных после загрузки
                if (!appData.years) {
                    appData.years = {};
                }
                if (!appData.currentYear) {
                    appData.currentYear = new Date().getFullYear().toString();
                }

                // Убеждаемся, что данные для текущего года существуют
                if (!appData.years[appData.currentYear]) {
                    appData.years[appData.currentYear] = {
                        income: [],
                        expense: [],
                        payments: []
                    };
                }

                console.log('Данные загружены из localStorage, currentYear:', appData.currentYear);
                return;
            }

            // Устанавливаем данные по умолчанию только если нет сохраненных
            appData = {
                users: [
                    { username: 'admin', password: 'P0l1uret@n@', role: 'admin', warehouseGroup: '', blocked: false },
                    { username: 'tillo', password: '123456', role: 'warehouse', warehouseGroup: 'Сугд' },
                    { username: 'abdullo', password: '123456', role: 'warehouse', warehouseGroup: 'Хисор' },
                    { username: 'firdavs', password: '123456', role: 'cashier', warehouseGroup: '' },
                    { username: 'dillik0807', password: '123456', role: 'admin', warehouseGroup: '' },
                    { username: 'sorbon', password: '123456', role: 'admin', warehouseGroup: '' }
                ],
                products: ['Навои Карбамид', 'Фаргона Карбамид', 'Точики Карбамид', 'Чирчик Карбамид', 'Навои Селитра', 'Фаргона Селитра', 'Чирчик Селитра', 'СуперОлтин'],
                companies: ['ООО ТарговыйДом', 'ООО Сахад', 'ТОЧИК АЗОД', 'ЧДММ Аллат'],
                warehouses: [
                    { name: 'Спитамен', group: 'Сугд' },
                    { name: 'Ч.Расулов', group: 'Сугд' },
                    { name: 'Хучанд', group: 'Сугд' },
                    { name: 'Хисор Шавкат', group: 'Хисор' },
                    { name: 'Гидраизол', group: 'Хисор' },
                    { name: 'Умед Склад', group: 'Хисор' },
                    { name: 'Бахор ОЙЛ', group: 'Ч.Балхи' }
                ],
                warehouseGroups: ['Сугд', 'Хисор', 'Ч.Балхи'],
                clients: [
                    'Коалица',
                    'Абдумачид (Ч.Балхи)',
                    'Абдурахмонов (Гипрозем)',
                    'Абубакр (Бахор Ойл)',
                    'Абували Кулоб',
                    'Агрокомбинат',
                    'Алихонов Исроил',
                    'Алишер Панч',
                    'Алишер Хочаев (Чиликул)',
                    'Асадулло Кабодиен',
                    'Асомидин Гоибов (Ч.Балхи)',
                    'Ахмадшох Эшон Фархор',
                    'Ахтам Рачабов (Кабодиен)',
                    'Баховидинов Зоир',
                    'Бахридин курган',
                    'Бегназаров Файзали (Ч.Балхи)',
                    'Боев Бехруз (А.Чоми)',
                    'Водии Зарин',
                    'Вохидов Хушбахт',
                    'Дилшод Хочи Шариф',
                    'Довуд Хучанд',
                    'Зайдуло Кумсангир',
                    'Зайнуллоев Дилшод',
                    'Зариф Сохибов',
                    'Зоир База Курган Курбонов',
                    'Игамназаров Абдукодир (Ч.Балхи)',
                    'Исломидин КУМСАНГИР',
                    'Исмоилов Салохидин',
                    'Камол Ориф Курган',
                    'Карим Кумсангир',
                    'Карим Ч.Балхи',
                    'Кахрамон Хизир Назар',
                    'Косимов Ориф',
                    'Мансур Мирбобоев',
                    'Маруф Мирбобоев',
                    'Маруф Регар',
                    'Махмуд Самадов (Куйбеш)',
                    'Мурод Ибрагимов',
                    'Муродали Саидов (вахдат)',
                    'Муродов Илхом Вахш',
                    'Наимов Абдулахад',
                    'Наим Чумьяев',
                    'Наличи Хисор',
                    'Насим Бегов',
                    'Насимов Эмом',
                    'Негматов Тураб',
                    'Носир (Пянч)',
                    'Носиров Анвар (Хисор)',
                    'Одинаев МС',
                    'Олим Э.Сатторов',
                    'Ривочидин Куватов Ч.Балхи',
                    'Рустам Панчакент',
                    'Саид Саидов',
                    'Саидов Рахмонали (Чиликул)',
                    'Саидов Саидакбар (Ч.Балхи)',
                    'Самадов Хотамбек (Кулоб)',
                    'Сохибов Зувайдулло',
                    'Субхон Мирзо Восеъ',
                    'Сулаймон Фаровон Бозор',
                    'Сухроб Истаравшан',
                    'ТАДЖИЕВ МАРУФ',
                    'Точидин Гадоев (ВАТЗ)',
                    'Тошматов Бегмат',
                    'Турахон Шарипов',
                    'Уктам Регар',
                    'Умед Хикматов Хисор',
                    'Умед Шарипов',
                    'Умед Эшонов Хисор',
                    'Файзали Бобоев Э.Саттор',
                    'Фаридун Акрамов',
                    'Фарход Абдуллоев',
                    'Фахридин Истаравшан',
                    'Фирдавс Искандар',
                    'Хамза Куйбеш',
                    'Хамза Паяндж',
                    'Хамрох (ХочиШариф)',
                    'Хасанов Махмадсаид',
                    'Хизмат Автодром',
                    'Хочаев Шерали',
                    'хочи Вохиб (Кумсангир)',
                    'Хочи Давлат (Акмал)',
                    'Хочи Исо (Кабодиен)',
                    'Хочи Нурали',
                    'Хочи Одил Пролитар',
                    'Хочи Равшан (Эшбек Саттор)',
                    'Хочи Сайф (Шартуз)',
                    'Худойдод Восеъ',
                    'Хуршед Якдоров',
                    'Хуснидин Ч.Х ИСО',
                    'Чалилов Каром',
                    'Чамшед Нозимов Хисор',
                    'ЧДММ А.Юсупов',
                    'Чума Содиков (Регар)',
                    'ЧУНТАЙ ХАТЛОН СИНСИЛУ',
                    'Чурабек Самадов',
                    'Шавкат Хисор',
                    'Шамсидинов Фируз Бохтар',
                    'ШахринДилшод',
                    'Шерхамза Кулоб',
                    'Шерхон Сайдали',
                    'Шухрат Кумсангир Мансур',
                    'Эшони Сирочидин Абдуев',
                    'Эшони Точидин Бобоев (Восеъ)',
                    'Юсуф Дехконов (Ворошил)'
                ],
                years: {},
                currentYear: new Date().getFullYear(),
                income: [],
                expense: [],
                payments: []
            };

            saveData();
        }

        // Миграция клиентов из строк в объекты
        function migrateClientsData() {
            let needsSave = false;

            appData.clients = appData.clients.map(client => {
                if (typeof client === 'string') {
                    needsSave = true;
                    return {
                        name: client,
                        phone: ''
                    };
                }
                return client;
            });

            if (needsSave) {
                saveData();
                console.log('Данные клиентов мигрированы в новый формат');
            }
        }

        // Функция экспорта отчета в Excel
        function exportReportToExcel() {
            const reportTitle = document.getElementById('reportTitle').textContent;
            const reportTable = document.querySelector('#reportContent table');

            if (!reportTable) {
                alert('Нет данных для экспорта. Сначала сформируйте отчёт.');
                return;
            }

            // Создаем рабочую книгу
            const wb = XLSX.utils.book_new();

            // Конвертируем таблицу в рабочий лист
            const ws = XLSX.utils.table_to_sheet(reportTable);

            // Добавляем лист в книгу
            XLSX.utils.book_append_sheet(wb, ws, 'Отчёт');

            // Генерируем имя файла с пользователем и датой
            const username = currentUser ? currentUser.username : 'unknown';
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            const fileName = `${reportTitle}_${username}_${dateStr}_${timeStr}.xlsx`;

            // Сохраняем файл
            XLSX.writeFile(wb, fileName);
        }

        // Функции для показа уведомлений
        function showErrorMessage(message) {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Автоматически удаляем через 5 секунд
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function showSuccessMessage(message) {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Автоматически удаляем через 3 секунды
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function showWarningMessage(message) {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // Автоматически удаляем через 4 секунды
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 4000);
        }

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function () {
            loadData();
            migrateClientsData();
            initializeYears();
            showLoginScreen();
            setupEventListeners();

            // Настройка автосохранения
            setupAutoSave();
            setupBeforeUnloadSave();
            startAutoSave();
        });

        // Функция для обновления списков складов и годов
        function updateStockBalanceDropdowns() {
            console.log('Обновление списков складов и годов');

            // Обновляем список складов
            const warehouseSelect = document.getElementById('stockBalanceWarehouse');
            if (warehouseSelect) {
                // Сохраняем текущий выбор
                const currentValue = warehouseSelect.value;

                // Очищаем список
                warehouseSelect.innerHTML = '<option value="all">Все склады</option>';

                // Добавляем склады из базы данных
                if (appData.warehouses && appData.warehouses.length > 0) {
                    appData.warehouses.forEach(warehouse => {
                        const option = document.createElement('option');
                        option.value = warehouse.name;
                        option.textContent = warehouse.name;
                        warehouseSelect.appendChild(option);
                    });
                }

                // Восстанавливаем выбор если возможно
                if (currentValue && [...warehouseSelect.options].some(opt => opt.value === currentValue)) {
                    warehouseSelect.value = currentValue;
                }

                console.log('Обновлен список складов:', appData.warehouses?.length || 0, 'складов');
            }

            // Обновляем список годов
            const yearSelect = document.getElementById('stockBalanceYear');
            if (yearSelect) {
                // Сохраняем текущий выбор
                const currentValue = yearSelect.value;

                // Очищаем список
                yearSelect.innerHTML = '';

                // Добавляем текущий год
                const currentYear = appData.currentYear || new Date().getFullYear();
                const currentOption = document.createElement('option');
                currentOption.value = currentYear;
                currentOption.textContent = currentYear;
                yearSelect.appendChild(currentOption);

                // Добавляем другие годы из базы данных
                if (appData.years) {
                    Object.keys(appData.years).forEach(year => {
                        if (year != currentYear) {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearSelect.appendChild(option);
                        }
                    });
                }

                // Восстанавливаем выбор если возможно
                if (currentValue && [...yearSelect.options].some(opt => opt.value === currentValue)) {
                    yearSelect.value = currentValue;
                } else {
                    yearSelect.value = currentYear;
                }

                console.log('Обновлен список годов:', Object.keys(appData.years || {}).length, 'годов');
            }
        }

        // Тестовая функция для проверки
        function testStockBalanceReport() {
            console.log('Тест отчета остатков складов');

            // Проверяем элементы
            const resultDiv = document.getElementById('stockBalanceResult');
            const contentDiv = document.getElementById('stockBalanceContent');
            const dateSpan = document.getElementById('stockBalanceDate');

            if (!resultDiv || !contentDiv || !dateSpan) {
                alert('Ошибка: не найдены элементы интерфейса');
                return;
            }

            // Простой тестовый отчет
            dateSpan.textContent = new Date().toLocaleString('ru-RU');
            contentDiv.innerHTML = `
                <div class="stock-balance-report">
                    <h3 class="text-lg font-bold mb-4">🧪 Тестовый отчет остатков складов</h3>
                    <div class="warehouse-section">
                        <h4>1) Тестовый склад</h4>
                        <div class="ml-4">
                            <div class="product-line">
                                <span class="product-name">Тестовый товар</span>
                                <span class="product-quantity quantity-positive">100.00 тонн (2025)</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');

            alert('Тест успешно выполнен! Отчет отображен.');
        }

        // Функции для отчета остатков складов
        function generateStockBalanceReport() {
            try {
                console.log('Начало генерации отчета остатков складов с группировкой');

                const company = document.getElementById('stockBalanceCompany').value;
                const warehouse = document.getElementById('stockBalanceWarehouse').value;
                const year = document.getElementById('stockBalanceYear').value;

                console.log('Параметры отчета:', { company, warehouse, year });

                if (!company || !warehouse || !year) {
                    alert('Ошибка: не выбраны все параметры отчета');
                    return;
                }

                // Генерируем отчет с группировкой
                const reportData = calculateStockBalanceGrouped(appData, company, warehouse, year);

                if (!reportData) {
                    alert('Ошибка: не удалось рассчитать данные отчета');
                    return;
                }

                // Отображаем результат с группировкой
                displayStockBalanceReportGrouped(reportData, company, warehouse, year);

                console.log('Отчет с группировкой успешно сформирован');
            } catch (error) {
                console.error('Ошибка при генерации отчета с группировкой:', error);
                alert('Ошибка при генерации отчета: ' + error.message);
            }
        }

        function calculateStockBalanceGrouped(data, company, warehouse, year) {
            console.log('Расчет остатков с группировкой (как в своде остатков):', { data, company, warehouse, year });

            // Получаем данные за указанный год
            const yearData = data.years && data.years[year] ? data.years[year] : { income: [], expense: [] };
            console.log('Данные за год:', year, yearData);

            // Создаем структуру для хранения остатков по складам и товарам
            const summary = {};

            // Обрабатываем приход товаров (используем логику из updateBalanceSummary)
            if (yearData.income && yearData.income.length > 0) {
                console.log('Обрабатываем приход товаров:', yearData.income.length, 'записей');
                yearData.income.forEach(incomeItem => {
                    const warehouseName = incomeItem.warehouse;
                    const companyName = incomeItem.company;
                    const productName = incomeItem.product;
                    const key = `${warehouseName}-${companyName}-${productName}`;

                    if (!summary[key]) {
                        summary[key] = {
                            warehouse: warehouseName,
                            company: companyName,
                            product: productName,
                            income: 0,
                            expense: 0
                        };
                    }
                    // Используем qtyFact как в своде остатков
                    summary[key].income += parseFloat(incomeItem.qtyFact) || 0;
                });
            }

            // Обрабатываем расход товаров (используем логику из updateBalanceSummary)
            if (yearData.expense && yearData.expense.length > 0) {
                console.log('Обрабатываем расход товаров:', yearData.expense.length, 'записей');
                yearData.expense.forEach(expenseItem => {
                    const warehouseName = expenseItem.warehouse;
                    const companyName = expenseItem.company;
                    const productName = expenseItem.product;
                    const key = `${warehouseName}-${companyName}-${productName}`;

                    if (!summary[key]) {
                        summary[key] = {
                            warehouse: warehouseName,
                            company: companyName,
                            product: productName,
                            income: 0,
                            expense: 0
                        };
                    }
                    // Используем quantity как в своде остатков
                    summary[key].expense += parseFloat(expenseItem.quantity) || 0;
                });
            }

            // Преобразуем в структуру остатков по складам
            const stockBalances = {};
            Object.values(summary).forEach(item => {
                const balance = item.income - item.expense; // Реальный остаток
                const balanceTons = balance / 20; // Переводим в тонны (как в своде остатков)

                if (!stockBalances[item.warehouse]) {
                    stockBalances[item.warehouse] = {};
                }
                if (!stockBalances[item.warehouse][item.product]) {
                    stockBalances[item.warehouse][item.product] = 0;
                }

                // Суммируем остатки по товарам (если один товар от разных компаний)
                stockBalances[item.warehouse][item.product] += balanceTons;
            });

            console.log('Рассчитанные остатки:', stockBalances);

            // Группируем по группам складов
            const groupedResult = {
                warehouseGroups: {},
                totals: {}
            };

            // Если нет данных
            if (Object.keys(stockBalances).length === 0) {
                console.log('Нет данных для отчета');
                groupedResult.warehouseGroups['no-data'] = {
                    name: 'Нет данных',
                    warehouses: {
                        'no-data': {
                            name: `Нет операций за ${year} год`,
                            products: {
                                'no-data': {
                                    name: `Нет операций за ${year} год`,
                                    quantity: 0
                                }
                            }
                        }
                    }
                };
                return groupedResult;
            }

            // Получаем все группы складов
            const warehouseGroups = data.warehouseGroups || [];
            const warehouses = data.warehouses || [];

            // Создаем карту склад -> группа
            const warehouseToGroup = {};
            warehouses.forEach(w => {
                warehouseToGroup[w.name] = w.group || 'Без группы';
            });

            // Фильтруем склады по параметрам
            const warehousesToProcess = warehouse === 'all' ?
                Object.keys(stockBalances) :
                Object.keys(stockBalances).filter(w => {
                    return w === warehouse || w.toLowerCase().includes(warehouse.toLowerCase());
                });

            console.log('Склады для обработки:', warehousesToProcess);

            // Группируем данные по группам складов
            warehousesToProcess.forEach(warehouseName => {
                if (stockBalances[warehouseName]) {
                    const groupName = warehouseToGroup[warehouseName] || 'Без группы';

                    // Фильтруем товары - показываем только с ненулевыми остатками
                    const nonZeroProducts = {};
                    let hasNonZeroProducts = false;

                    Object.entries(stockBalances[warehouseName]).forEach(([productName, quantity]) => {
                        if (quantity !== 0) {
                            nonZeroProducts[productName] = {
                                name: productName,
                                quantity: quantity
                            };
                            hasNonZeroProducts = true;

                            // Добавляем к общим итогам только ненулевые остатки
                            if (!groupedResult.totals[productName]) {
                                groupedResult.totals[productName] = {
                                    name: productName,
                                    quantity: 0
                                };
                            }
                            groupedResult.totals[productName].quantity += quantity;
                        }
                    });

                    // Добавляем склад в группу только если есть ненулевые остатки
                    if (hasNonZeroProducts) {
                        // Создаем группу если её нет
                        if (!groupedResult.warehouseGroups[groupName]) {
                            groupedResult.warehouseGroups[groupName] = {
                                name: groupName,
                                warehouses: {}
                            };
                        }

                        // Добавляем склад в группу с ненулевыми товарами
                        groupedResult.warehouseGroups[groupName].warehouses[warehouseName] = {
                            name: warehouseName,
                            products: nonZeroProducts
                        };
                    }
                }
            });

            // Удаляем товары с нулевыми итогами из общих итогов
            Object.keys(groupedResult.totals).forEach(productName => {
                if (groupedResult.totals[productName].quantity === 0) {
                    delete groupedResult.totals[productName];
                }
            });

            // Проверяем, есть ли данные после фильтрации
            if (Object.keys(groupedResult.warehouseGroups).length === 0) {
                console.log('Нет остатков для отображения после фильтрации');
                groupedResult.warehouseGroups['no-data'] = {
                    name: 'Нет остатков',
                    warehouses: {
                        'no-data': {
                            name: `Нет товаров с остатками за ${year} год`,
                            products: {
                                'no-data': {
                                    name: `Все остатки равны нулю`,
                                    quantity: 0
                                }
                            }
                        }
                    }
                };
            }

            console.log('Результат с группировкой:', groupedResult);
            return groupedResult;
        }

        function displayStockBalanceReportGrouped(reportData, company, warehouse, year) {
            console.log('Отображение отчета с группировкой:', { reportData, company, warehouse, year });

            const resultDiv = document.getElementById('stockBalanceResult');
            const contentDiv = document.getElementById('stockBalanceContent');
            const dateSpan = document.getElementById('stockBalanceDate');

            if (!resultDiv || !contentDiv || !dateSpan) {
                console.error('Не найдены элементы для отображения отчета');
                alert('Ошибка: не найдены элементы интерфейса для отчета');
                return;
            }

            dateSpan.textContent = new Date().toLocaleString('ru-RU');

            let html = `
                <div class="stock-balance-report">
                    <h3 class="text-lg font-bold mb-4">📦 Фактические Остатки по Группам Складов - ${company === 'all' ? 'Все компании' : 'Торговый Дом'} (${year})</h3>
            `;

            // Отображаем данные по группам складов
            let groupIndex = 1;
            Object.entries(reportData.warehouseGroups).forEach(([groupKey, groupData]) => {
                html += `
                    <div class="warehouse-group-section mb-8 p-4 border-2 border-blue-300 rounded-lg bg-blue-50">
                        <h4 class="font-bold text-blue-800 mb-4 text-xl">🏢 ${groupIndex}. ${groupData.name}</h4>
                `;

                // Отображаем склады в группе
                let warehouseIndex = 1;
                Object.entries(groupData.warehouses).forEach(([warehouseKey, warehouseData]) => {
                    html += `
                        <div class="warehouse-section mb-4 ml-4 p-3 border border-gray-300 rounded bg-white">
                            <h5 class="font-semibold text-gray-700 mb-2">📦 ${groupIndex}.${warehouseIndex} ${warehouseData.name}</h5>
                            <div class="ml-4">
                    `;

                    // Отображаем товары в складе
                    Object.entries(warehouseData.products).forEach(([productKey, productData]) => {
                        const quantityClass = productData.quantity < 0 ? 'text-red-600' : 'text-green-600';
                        const quantityIcon = productData.quantity < 0 ? '⚠️' : '✅';
                        html += `
                            <div class="product-line flex justify-between items-center py-1 border-b border-gray-100">
                                <span class="product-name text-gray-800">${quantityIcon} ${productData.name}</span>
                                <span class="product-quantity font-semibold ${quantityClass}">${productData.quantity.toFixed(2)} тонн</span>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                    warehouseIndex++;
                });

                html += `</div>`;
                groupIndex++;
            });

            // Отображаем общие итоги
            if (Object.keys(reportData.totals).length > 0) {
                html += `
                    <div class="totals-section mt-8 pt-6 border-t-4 border-blue-600 bg-blue-100 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-900 mb-4 text-xl">📊 Общие Итоги: ${company === 'all' ? 'Все компании' : 'Торговый Дом'} (${year})</h4>
                        <div class="ml-4">
                `;

                let grandTotal = 0;
                Object.entries(reportData.totals).forEach(([productKey, productData]) => {
                    const quantityClass = productData.quantity < 0 ? 'text-red-600' : 'text-green-600';
                    const quantityIcon = productData.quantity < 0 ? '⚠️' : '✅';
                    html += `
                        <div class="product-line flex justify-between items-center py-2 border-b border-blue-200">
                            <span class="product-name font-medium text-gray-800">${quantityIcon} ${productData.name}</span>
                            <span class="product-quantity font-bold ${quantityClass} text-lg">${productData.quantity.toFixed(2)} тонн</span>
                        </div>
                    `;
                    grandTotal += productData.quantity;
                });

                const grandTotalClass = grandTotal < 0 ? 'text-red-700' : 'text-green-700';
                html += `
                        <div class="grand-total mt-4 pt-4 border-t-2 border-blue-400">
                            <div class="product-line flex justify-between items-center">
                                <span class="product-name font-bold text-blue-900 text-lg">🎯 ОБЩИЙ ИТОГ:</span>
                                <span class="product-quantity font-bold ${grandTotalClass} text-xl">${grandTotal.toFixed(2)} тонн</span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            html += `</div>`;

            console.log('Устанавливаем HTML содержимое:', html.length, 'символов');
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');

            console.log('Отчет с группировкой успешно отображен');
        }

        function exportStockBalanceToWhatsApp() {
            const company = document.getElementById('stockBalanceCompany').value;
            const warehouse = document.getElementById('stockBalanceWarehouse').value;
            const year = document.getElementById('stockBalanceYear').value;

            // Получаем данные с группировкой
            const reportData = calculateStockBalanceGrouped(appData, company, warehouse, year);

            // Формируем текст для WhatsApp
            let message = `📦 *Фактические Остатки по Группам Складов*\\n`;
            message += `*${company === 'all' ? 'Все компании' : 'Торговый Дом'} (${year})*\\n\\n`;

            let groupIndex = 1;
            Object.entries(reportData.warehouseGroups).forEach(([groupKey, groupData]) => {
                message += `🏢 *${groupIndex}. ${groupData.name}*\\n`;

                let warehouseIndex = 1;
                Object.entries(groupData.warehouses).forEach(([warehouseKey, warehouseData]) => {
                    message += `  📦 ${groupIndex}.${warehouseIndex} ${warehouseData.name}\\n`;

                    Object.entries(warehouseData.products).forEach(([productKey, productData]) => {
                        const icon = productData.quantity < 0 ? '⚠️' : '✅';
                        message += `    ${icon} ${productData.name}: ${productData.quantity.toFixed(2)} тонн\\n`;
                    });
                    message += `\\n`;
                    warehouseIndex++;
                });
                groupIndex++;
            });

            // Добавляем общие итоги
            if (Object.keys(reportData.totals).length > 0) {
                message += `📊 *ОБЩИЕ ИТОГИ:*\\n`;
                let grandTotal = 0;

                Object.entries(reportData.totals).forEach(([productKey, productData]) => {
                    const icon = productData.quantity < 0 ? '⚠️' : '✅';
                    message += `${icon} ${productData.name}: ${productData.quantity.toFixed(2)} тонн\\n`;
                    grandTotal += productData.quantity;
                });

                message += `\\n🎯 *ОБЩИЙ ИТОГ: ${grandTotal.toFixed(2)} тонн*`;
            }

            // Открываем WhatsApp
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function printStockBalanceReport() {
            const content = document.getElementById('stockBalanceContent').innerHTML;
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Отчет по остаткам складов</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .warehouse-section { margin-bottom: 20px; }
                        .totals-section { border-top: 2px solid #3b82f6; padding-top: 15px; }
                        h3, h4 { color: #1e40af; }
                        .text-red-600 { color: #dc2626; }
                        .text-green-600 { color: #16a34a; }
                        .text-blue-600 { color: #2563eb; }
                        .text-blue-800 { color: #1e40af; }
                        .font-mono { font-family: monospace; }
                        .flex { display: flex; }
                        .justify-between { justify-content: space-between; }
                        .py-1 { padding: 2px 0; }
                        .ml-4 { margin-left: 16px; }
                        .border-t { border-top: 1px solid #e5e7eb; }
                        .mt-2 { margin-top: 8px; }
                        .pt-2 { padding-top: 8px; }
                    </style>
                </head>
                <body>
                    ${content}
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        Отчет создан: ${new Date().toLocaleString('ru-RU')}
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.print();
        }

        // Функции для раздела "Остатки складов"
        function initializeStockBalance() {
            console.log('Инициализация раздела остатков складов');

            // Заполняем селектор складов
            const warehouseSelect = document.getElementById('stockBalanceWarehouse');
            if (warehouseSelect && appData.warehouses) {
                warehouseSelect.innerHTML = '<option value="">Все склады</option>';
                appData.warehouses.forEach(warehouse => {
                    warehouseSelect.innerHTML += `<option value="${warehouse.name}">${warehouse.name}</option>`;
                });
            }

            // Заполняем селектор годов
            updateStockBalanceYearSelector();

            // Добавляем обработчики событий
            const generateBtn = document.getElementById('generateStockBalanceBtn');
            const whatsappBtn = document.getElementById('exportStockBalanceWhatsAppBtn');
            const printBtn = document.getElementById('printStockBalanceBtn');

            if (generateBtn) {
                generateBtn.addEventListener('click', generateStockBalanceReport);
            }
            if (whatsappBtn) {
                whatsappBtn.addEventListener('click', exportStockBalanceToWhatsApp);
            }
            if (printBtn) {
                printBtn.addEventListener('click', printStockBalanceReport);
            }
        }

        // Функция для обновления селектора года в разделе остатков складов
        function updateStockBalanceYearSelector() {
            console.log('🔄 Обновление селектора года в разделе остатков складов');
            console.log('🔄 Текущий год приложения:', appData.currentYear);

            const yearSelect = document.getElementById('stockBalanceYear');
            if (yearSelect && appData.years) {
                // Очищаем селектор
                yearSelect.innerHTML = '';

                // Сортируем годы по убыванию (новые сверху)
                const sortedYears = Object.keys(appData.years).sort((a, b) => b - a);
                console.log('Доступные годы для остатков складов:', sortedYears);
                console.log('Текущий год приложения:', appData.currentYear);

                // Добавляем опции
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;

                    // Всегда синхронизируем с текущим годом приложения
                    if (year === appData.currentYear.toString()) {
                        option.selected = true;
                        console.log('Выбран год:', year);
                    }

                    yearSelect.appendChild(option);
                });

                // Принудительно устанавливаем значение селектора
                yearSelect.value = appData.currentYear.toString();

                console.log('✅ Селектор года остатков складов обновлен');
                console.log('✅ Количество опций:', yearSelect.options.length);
                console.log('✅ Выбранное значение:', yearSelect.value);
            } else {
                console.error('❌ Селектор stockBalanceYear не найден или нет данных о годах!');
            }
        }

        function generateStockBalanceReport() {
            console.log('Генерация отчета остатков складов');

            const company = document.getElementById('stockBalanceCompany').value;
            const warehouse = document.getElementById('stockBalanceWarehouse').value;
            const year = document.getElementById('stockBalanceYear').value;

            // Получаем данные для выбранного года
            const yearData = appData.years[year];
            if (!yearData) {
                alert('Данные за выбранный год не найдены');
                return;
            }

            // Рассчитываем остатки
            const stockBalance = calculateStockBalance(yearData, warehouse, company);

            // Отображаем отчет
            displayStockBalanceReport(stockBalance, company, warehouse, year);
        }

        function calculateStockBalance(yearData, warehouseFilter, companyFilter) {
            const balance = {};

            // Обрабатываем приход
            if (yearData.income) {
                yearData.income.forEach(item => {
                    if (warehouseFilter && item.warehouse !== warehouseFilter) return;
                    if (companyFilter && item.company !== companyFilter) return;

                    const key = `${item.warehouse}|${item.product}`;
                    if (!balance[key]) {
                        balance[key] = {
                            warehouse: item.warehouse,
                            product: item.product,
                            company: item.company,
                            quantity: 0,
                            tons: 0
                        };
                    }
                    balance[key].quantity += parseFloat(item.qtyFact || 0);
                    balance[key].tons += parseFloat(item.weightTons || 0);
                });
            }

            // Обрабатываем расход
            if (yearData.expense) {
                yearData.expense.forEach(item => {
                    if (warehouseFilter && item.warehouse !== warehouseFilter) return;
                    if (companyFilter && item.company !== companyFilter) return;

                    const key = `${item.warehouse}|${item.product}`;
                    if (!balance[key]) {
                        balance[key] = {
                            warehouse: item.warehouse,
                            product: item.product,
                            company: item.company,
                            quantity: 0,
                            tons: 0
                        };
                    }
                    balance[key].quantity -= parseFloat(item.quantity || 0);
                    balance[key].tons -= parseFloat(item.tons || 0);
                });
            }

            return Object.values(balance);
        }

        function displayStockBalanceReport(stockBalance, company, warehouse, year) {
            const reportDiv = document.getElementById('stockBalanceReport');
            const contentDiv = document.getElementById('stockBalanceContent');

            if (!reportDiv || !contentDiv) return;

            // Группируем сначала по подгруппам складов, потом по складам
            const groupedData = {};

            stockBalance.forEach(item => {
                // Находим подгруппу склада
                const warehouseInfo = appData.warehouses.find(w => w.name === item.warehouse);
                const groupName = warehouseInfo ? warehouseInfo.group : 'Без группы';

                if (!groupedData[groupName]) {
                    groupedData[groupName] = {};
                }

                if (!groupedData[groupName][item.warehouse]) {
                    groupedData[groupName][item.warehouse] = [];
                }

                groupedData[groupName][item.warehouse].push(item);
            });

            // Формируем HTML отчета
            let html = `
                <div class="stock-balance-header mb-6">
                    <h2 class="text-2xl font-bold text-blue-800 mb-2">
                        Фактические Остатки - ${company || 'Все компании'} (${year})
                    </h2>
                    <p class="text-gray-600">
                        Склад: ${warehouse || 'Все склады'} | 
                        Дата формирования: ${new Date().toLocaleDateString('ru-RU')}
                    </p>
                </div>
            `;

            let warehouseIndex = 1;
            let totalsByProduct = {};

            // Сортируем подгруппы по алфавиту
            const sortedGroups = Object.keys(groupedData).sort();

            sortedGroups.forEach(groupName => {
                const warehousesInGroup = groupedData[groupName];

                // Добавляем заголовок подгруппы
                html += `
                    <div class="warehouse-group-section mb-8">
                        <h3 class="text-xl font-bold text-purple-800 mb-4 pb-2 border-b-2 border-purple-300">
                            📂 ${groupName}
                        </h3>
                `;

                // Сортируем склады в подгруппе по алфавиту
                const sortedWarehouses = Object.keys(warehousesInGroup).sort();

                sortedWarehouses.forEach(warehouseName => {
                    const items = warehousesInGroup[warehouseName];

                    html += `
                        <div class="warehouse-section mb-6 bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500 ml-4">
                            <h4 class="text-lg font-semibold text-blue-700 mb-3">
                                ${warehouseIndex}) ${warehouseName}
                            </h4>
                    `;

                    // Проверяем настройку показа нулевых остатков
                    const showZeroBalance = document.getElementById('showZeroBalance')?.checked ?? true;

                    items.forEach(item => {
                        const tons = item.tons.toFixed(2);
                        const tonsValue = parseFloat(tons);

                        // Фильтруем нулевые остатки если нужно
                        if (!showZeroBalance && tonsValue === 0) {
                            return;
                        }

                        const colorClass = tonsValue > 0 ? 'text-green-600' :
                            tonsValue < 0 ? 'text-red-600' : 'text-gray-600';

                        html += `
                            <div class="flex justify-between items-center px-2 border-b border-gray-300 hover:bg-gray-100 transition-colors">
                                <span class="font-medium text-gray-800">${item.product}</span>
                                <span class="${colorClass} font-bold">
                                    ${tons} т/н (${year})
                                </span>
                            </div>
                        `;

                        // Суммируем по товарам
                        if (!totalsByProduct[item.product]) {
                            totalsByProduct[item.product] = 0;
                        }
                        totalsByProduct[item.product] += item.tons;
                    });

                    html += '</div>';
                    warehouseIndex++;
                });

                html += '</div>'; // Закрываем warehouse-group-section
            });

            // Добавляем итоги
            if (Object.keys(totalsByProduct).length > 0) {
                html += `
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mt-6">
                        <h4 class="text-lg font-bold text-blue-800 mb-4">
                            Итого: ${company || 'Все компании'}
                        </h4>
                `;

                let grandTotal = 0;
                Object.keys(totalsByProduct).forEach(product => {
                    const total = totalsByProduct[product];
                    const colorClass = total >= 0 ? 'text-green-600' : 'text-red-600';
                    grandTotal += total;

                    html += `
                        <div class="flex justify-between items-center py-2 border-b border-blue-200 last:border-b-0">
                            <span class="font-medium">${product}</span>
                            <span class="${colorClass} font-bold">
                                ${total.toFixed(2)} т/н (${year})
                            </span>
                        </div>
                    `;
                });

                const grandTotalColor = grandTotal >= 0 ? 'text-green-600' : 'text-red-600';
                html += `
                    <div class="mt-4 pt-4 border-t-2 border-blue-300">
                        <div class="text-center">
                            <span class="text-xl font-bold ${grandTotalColor}">
                                ${grandTotal.toFixed(2)} т/н (${year})
                            </span>
                        </div>
                    </div>
                `;

                html += '</div>';
            }

            contentDiv.innerHTML = html;
            reportDiv.classList.remove('hidden');
        }

        function exportStockBalanceToWhatsApp() {
            const contentDiv = document.getElementById('stockBalanceContent');
            if (!contentDiv) return;

            // Получаем текстовую версию отчета
            const reportText = contentDiv.innerText;

            // Кодируем для URL
            const encodedText = encodeURIComponent(reportText);

            // Открываем WhatsApp Web
            const whatsappUrl = `https://web.whatsapp.com/send?text=${encodedText}`;
            window.open(whatsappUrl, '_blank');
        }

        function printStockBalanceReport() {
            const contentDiv = document.getElementById('stockBalanceContent');
            if (!contentDiv) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Остатки складов</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .warehouse-section { margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px; }
                        .warehouse-section h4 { color: #1e40af; margin-bottom: 10px; }
                        .product-line { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #eee; }
                        .totals-section { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 20px; }
                        .text-green-600 { color: #059669; }
                        .text-red-600 { color: #dc2626; }
                        .text-blue-800 { color: #1e40af; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${contentDiv.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <script src="mobile-menu-complete.js"></script>
</body>

</html>